<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>منصة مدرسة صلالة الشرقية الرقمية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --primary: #0f172a; --accent: #d4af37; --bg: #f8fafc; --card-bg: #ffffff; --success: #10b981; --wa: #25d366; --danger: #ef4444; --edit: #3b82f6; }
        
        /* هام جداً: مساحة سفلية كبيرة لضمان ظهور المحتوى فوق الأشرطة */
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; padding-bottom: 120px; color: var(--primary); }
        
        .official-header { 
            background: var(--primary); color: white; padding: 10px 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 3px solid var(--accent); position: sticky; top: 0; z-index: 1000;
        }

        .school-info h1 { margin: 0; font-size: clamp(0.85rem, 4vw, 1.1rem); color: var(--accent); font-weight: 800; }
        
        #teacherDisplay {
            font-size: 0.85rem; font-weight: 700; color: #fff; background: rgba(212, 175, 55, 0.2);
            padding: 5px 12px; border-radius: 20px; border: 1px solid var(--accent);
            display: flex; align-items: center; gap: 8px;
        }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .card { background: var(--card-bg); border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .card-title { display: flex; align-items: center; gap: 10px; font-weight: 800; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        
        select, input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: 'Cairo'; margin-bottom: 15px; box-sizing: border-box; font-size: 1rem; }
        .btn { border: none; border-radius: 10px; font-family: 'Cairo'; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: var(--accent); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        /* الأشرطة السفلية المثبتة بقوة */
        .bottom-nav { 
            position: fixed; bottom: 40px; left: 0; right: 0; 
            background: white; display: flex; justify-content: space-around; 
            padding: 10px 0; border-top: 1px solid #eee; z-index: 2000; 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1); 
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94a3b8; cursor: pointer; font-size: 0.8rem; font-weight: 700; }
        .nav-item.active { color: var(--primary); }

        .extra-bottom-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            height: 40px; background: var(--primary); color: var(--accent); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 0.85rem; font-weight: 800; z-index: 2100; 
            border-top: 2px solid var(--accent);
        }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:4000; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
        
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #fff; border-radius: 10px; margin-bottom: 8px; border: 1px solid #eee; border-right: 5px solid var(--accent); }
        .section { display: none; }
        .section.active { display: block; }
    </style>
</head>
<body>

<header class="official-header no-print">
    <div class="school-info"><h1>مدرسة صلالة الشرقية</h1></div>
    <div id="teacherDisplay"><i class="fas fa-user-circle"></i> <span id="teacherNameTxt">...</span></div>
    <button class="btn-danger" onclick="logout()" style="padding:5px 10px; border-radius:8px; width:auto; font-size:0.7rem;">خروج</button>
</header>

<div class="container">
    <section id="absent-section" class="section active">
        <div class="card no-print">
            <div class="card-title"><i class="fas fa-calendar-check"></i> رصد الغياب</div>
            <input type="date" id="absentDate">
            <div style="display: flex; gap:10px;">
                <select id="mainGradeSelect" onchange="updateSections('mainGradeSelect','mainSectionSelect'); updateStudents();"></select>
                <select id="mainSectionSelect" onchange="updateStudents()"></select>
            </div>
            <select id="studentDropdown" onchange="addToList()"><option value="">-- اختر الطالب --</option></select>
            <div id="selectedList"></div>
            <button class="btn btn-primary" onclick="saveData()">حفظ وإرسال السجل</button>
        </div>
    </section>

    <section id="report-section" class="section">
        <div class="card">
            <div class="card-title"><i class="fas fa-file-invoice"></i> نظام التقارير</div>
            <select id="reportMode" onchange="toggleReportUI()">
                <option value="student">تقرير طالب محدد</option>
                <option value="class">كشف غياب الصف المجمع</option>
            </select>
            <div style="display: flex; gap:10px;">
                <select id="repGradeSelect" onchange="updateSections('repGradeSelect','repSectionSelect'); updateReportStudentList();"></select>
                <select id="repSectionSelect" onchange="updateReportStudentList()"></select>
            </div>
            <div id="studentSelectDiv"><select id="repStudentSelect"></select></div>
            <div style="display: flex; gap:10px;">
                <input type="date" id="repDateStart">
                <input type="date" id="repDateEnd">
            </div>
            <button class="btn btn-primary" onclick="generateReport()">عرض التقرير</button>
            <div id="reportResult"></div>
        </div>
    </section>

    <section id="manage-section" class="section">
        <div class="card">
            <div class="card-title"><i class="fas fa-user-plus"></i> إضافة طالب جديد</div>
            <input type="text" id="newName" placeholder="الاسم الرباعي">
            <input type="tel" id="newPhone" placeholder="رقم التواصل">
            <div style="display:flex; gap:10px;">
                <input type="text" id="newGrade" placeholder="الصف (مثال: الخامس)">
                <input type="text" id="newSection" placeholder="الشعبة (مثال: 1)">
            </div>
            <button class="btn btn-success" onclick="addNewStudent()">إضافة وحفظ</button>
        </div>
        <div class="card">
            <div class="card-title"><i class="fas fa-user-edit"></i> إدارة الطلاب الحاليين</div>
            <div style="display:flex; gap:10px;">
                <select id="manageGradeSelect" onchange="updateSections('manageGradeSelect','manageSectionSelect'); renderManagerList();"></select>
                <select id="manageSectionSelect" onchange="renderManagerList()"></select>
            </div>
            <div id="managerListArea"></div>
        </div>
    </section>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <h3>تعديل بيانات الطالب</h3>
        <input type="hidden" id="editOldName">
        <label>الشعبة</label><input type="text" id="editSectionInput">
        <label>الهاتف</label><input type="tel" id="editPhoneInput">
        <button class="btn btn-success" onclick="submitStudentEdit()">تحديث</button>
        <button class="btn btn-danger" onclick="closeModal()" style="margin-top:10px;">إلغاء</button>
    </div>
</div>

<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color:var(--danger)">تأكيد الحذف</h3>
        <p>هل أنت متأكد من حذف الطالب نهائياً؟</p>
        <button class="btn btn-danger" id="confirmDeleteBtn">نعم، حذف</button>
        <button class="btn" onclick="closeModal()" style="margin-top:10px;">تراجع</button>
    </div>
</div>

<div id="successModal" class="modal-overlay">
    <div class="modal-content">
        <i class="fas fa-check-circle" style="font-size:3rem; color:var(--success);"></i>
        <h3 id="successMsg">تم بنجاح</h3>
        <button class="btn btn-primary" onclick="closeModal()">موافق</button>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('absent-section', this)"><i class="fas fa-edit"></i><span>الرصد</span></div>
    <div class="nav-item" onclick="switchTab('report-section', this)"><i class="fas fa-print"></i><span>التقارير</span></div>
    <div class="nav-item" onclick="switchTab('manage-section', this)"><i class="fas fa-users-cog"></i><span>الإدارة</span></div>
</nav>
<div class="extra-bottom-bar">تصميم وتنفيذ الأستاذ فيصل العريبي © 2026</div>

<script>
    // --- 1. الدوال الأساسية والبيانات ---
    let students = []; let history = []; let currentBatch = []; let deleteTarget = "";

    async function loadData() {
        if (sessionStorage.getItem('isLoggedIn') !== 'true') window.location.replace("index.html");
        document.getElementById('teacherNameTxt').innerText = `أ. ${sessionStorage.getItem('teacherName') || 'معلم'}`;
        try {
            const v = Date.now();
            const [sR, hR] = await Promise.all([fetch(`student_fone.json?v=${v}`), fetch(`attendance_history.json?v=${v}`)]);
            students = await sR.json(); history = await hR.json();
            initGrades();
        } catch(e) { console.error("خطأ في تحميل البيانات"); }
    }

    function initGrades() {
        const grades = [...new Set(students.map(s => String(s.grade)))].sort();
        ['mainGradeSelect', 'repGradeSelect', 'manageGradeSelect'].forEach(id => {
            document.getElementById(id).innerHTML = '<option value="">الصف</option>' + grades.map(g => `<option value="${g}">${g}</option>`).join('');
        });
    }

    function updateSections(gId, sId) {
        const g = document.getElementById(gId).value;
        const sections = [...new Set(students.filter(s => String(s.grade) === g).map(s => String(s.section)))].sort();
        document.getElementById(sId).innerHTML = '<option value="">الشعبة</option>' + sections.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    // --- 2. دوال الرصد والواتساب ---
    function updateStudents() {
        const g = document.getElementById('mainGradeSelect').value;
        const s = document.getElementById('mainSectionSelect').value;
        const drop = document.getElementById('studentDropdown');
        drop.innerHTML = '<option value="">-- اختر الطالب --</option>';
        students.filter(x => String(x.grade) === g && String(x.section) === s).sort((a,b)=>a.name.localeCompare(b.name,'ar'))
                .forEach(st => drop.innerHTML += `<option value="${st.name}" data-phone="${st.phone}">${st.name}</option>`);
    }

    function addToList() {
        const d = document.getElementById('studentDropdown');
        if(!d.value || currentBatch.find(x => x.name === d.value)) return;
        currentBatch.push({ name: d.value, phone: d.options[d.selectedIndex].getAttribute('data-phone') });
        renderBatch(); d.selectedIndex = 0;
    }

    function renderBatch() {
        const date = document.getElementById('absentDate').value;
        document.getElementById('selectedList').innerHTML = currentBatch.map((s,i)=>`
            <div class="item-row"><span>${s.name}</span>
            <div><i class="fab fa-whatsapp" style="color:var(--wa); margin-left:15px;" onclick="sendWA('${s.phone}','${s.name}','${date}')"></i>
            <i class="fas fa-times-circle" style="color:var(--danger)" onclick="currentBatch.splice(${i},1);renderBatch();"></i></div></div>`).join('');
    }

    function sendWA(phone, name, date) {
        const text = `مدرسة صلالة الشرقية%0Aغياب الطالب: *${name}*%0Aالتاريخ: *${date}*`;
        window.open(`https://wa.me/${phone}?text=${text}`, '_blank');
    }

    async function saveData() {
        if(!currentBatch.length) return;
        const date = document.getElementById('absentDate').value;
        const res = await fetch('/api/save-attendance', { method:'POST', headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify(currentBatch.map(b => ({ name: b.name, date, class: 'Manual' }))) });
        if(res.ok) { currentBatch = []; renderBatch(); showSuccess("تم حفظ السجل بنجاح"); }
    }

    // --- 3. دوال الإدارة (إضافة، تعديل، حذف) ---
    async function addNewStudent() {
        const data = { name: document.getElementById('newName').value, phone: document.getElementById('newPhone').value, 
                       grade: document.getElementById('newGrade').value, section: document.getElementById('newSection').value };
        const res = await fetch('/api/add-student', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
        if(res.ok) { students.push(data); showSuccess("تمت إضافة الطالب"); }
    }

    function renderManagerList() {
        const g = document.getElementById('manageGradeSelect').value;
        const s = document.getElementById('manageSectionSelect').value;
        const area = document.getElementById('managerListArea'); area.innerHTML = '';
        students.filter(st => String(st.grade) === g && String(st.section) === s).forEach(st => {
            area.innerHTML += `<div class="item-row"><span>${st.name}</span>
            <div><i class="fas fa-edit" style="color:var(--edit); margin-left:15px;" onclick="openEditModal('${st.name}','${st.section}','${st.phone}')"></i>
            <i class="fas fa-trash" style="color:var(--danger)" onclick="openDeleteModal('${st.name}')"></i></div></div>`;
        });
    }

    function openEditModal(name, sec, phone) {
        document.getElementById('editOldName').value = name;
        document.getElementById('editSectionInput').value = sec;
        document.getElementById('editPhoneInput').value = phone;
        document.getElementById('editModal').style.display = 'flex';
    }

    async function submitStudentEdit() {
        const data = { oldName: document.getElementById('editOldName').value, newSection: document.getElementById('editSectionInput').value, newPhone: document.getElementById('editPhoneInput').value };
        const res = await fetch('/api/update-student', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
        if(res.ok) { location.reload(); }
    }

    function openDeleteModal(name) { deleteTarget = name; document.getElementById('deleteModal').style.display = 'flex'; }
    
    document.getElementById('confirmDeleteBtn').onclick = async () => {
        const res = await fetch('/api/delete-student', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name: deleteTarget}) });
        if(res.ok) { location.reload(); }
    };

    // --- 4. دوال التقارير ---
    function updateReportStudentList() {
        const g = document.getElementById('repGradeSelect').value;
        const s = document.getElementById('repSectionSelect').value;
        document.getElementById('repStudentSelect').innerHTML = students.filter(x => String(x.grade) === g && String(x.section) === s)
                .map(st => `<option value="${st.name}">${st.name}</option>`).join('');
    }

    function generateReport() {
        const mode = document.getElementById('reportMode').value;
        const start = document.getElementById('repDateStart').value;
        const end = document.getElementById('repDateEnd').value;
        let filtered = history.filter(h => h.date >= start && h.date <= end);
        if(mode === 'student') filtered = filtered.filter(h => h.name === document.getElementById('repStudentSelect').value);
        
        let html = `<table><tr><th>التاريخ</th><th>الاسم</th></tr>`;
        filtered.forEach(r => html += `<tr><td>${r.date}</td><td>${r.name}</td></tr>`);
        document.getElementById('reportResult').innerHTML = html + `</table>`;
    }

    // --- 5. التنقل والتحكم ---
    function switchTab(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active'); el.classList.add('active');
    }
    function showSuccess(msg) { document.getElementById('successMsg').innerText = msg; document.getElementById('successModal').style.display = 'flex'; }
    function closeModal() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
    function toggleReportUI() { document.getElementById('studentSelectDiv').style.display = (document.getElementById('reportMode').value==='student'?'block':'none'); }
    function logout() { sessionStorage.clear(); window.location.replace("index.html"); }

    window.onload = loadData;
</script>
</body>
</html>
