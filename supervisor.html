<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>منظومة إشراف صلالة الشرقية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --primary: #0f172a; --accent: #d4af37; --bg: #f1f5f9; --white: #ffffff; --danger: #ef4444; --warning: #f59e0b; }
        
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; padding-bottom: 70px; color: var(--primary); }

        /* الهيدر العلوي */
        .app-header { background: var(--primary); color: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .app-header h1 { margin: 0; font-size: 1.2rem; color: var(--accent); font-weight: 900; }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* كرت الرادار */
        .radar-card { background: var(--white); border-radius: 15px; padding: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-bottom: 20px; border-right: 6px solid var(--danger); display: none; }
        .radar-title { font-weight: 800; font-size: 0.9rem; margin-bottom: 10px; color: var(--danger); display: flex; align-items: center; gap: 8px; }
        .radar-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .alert-badge { 
            background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; padding: 6px 12px; 
            border-radius: 8px; font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: 0.2s;
        }
        .alert-badge:hover { background: var(--danger); color: white; }

        /* كرت الفلترة */
        .filter-card { background: var(--white); border-radius: 15px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .filter-title { font-weight: 800; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; font-size: 1rem; }
        select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: 'Cairo'; font-weight: 700; margin-bottom: 10px; font-size: 0.95rem; }
        
        .btn-print { background: var(--primary); color: var(--accent); width: 100%; padding: 12px; border: none; border-radius: 10px; font-family: 'Cairo'; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.95rem; }

        /* كروت الطلاب */
        .student-card { background: var(--white); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); position: relative; border-right: 8px solid var(--primary); }
        .student-card.critical { border-right-color: var(--danger); }
        .student-card.warning { border-right-color: var(--warning); }

        .st-name { font-weight: 900; font-size: 1.05rem; display: block; margin-bottom: 4px; }
        .st-status { font-size: 0.8rem; font-weight: 700; margin-bottom: 8px; display: inline-block; padding: 3px 8px; border-radius: 4px; }
        .bg-red { background: #fee2e2; color: var(--danger); }
        .bg-orange { background: #fef3c7; color: #b45309; }

        .st-dates { font-size: 0.75rem; color: #64748b; background: #f8fafc; padding: 8px; border-radius: 6px; border: 1px dashed #cbd5e1; }

        .wa-float { position: absolute; left: 15px; top: 20px; background: #25d366; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; box-shadow: 0 4px 10px rgba(37, 211, 102, 0.4); text-decoration: none; }

        /* الشريط السفلي (حقوق الملكية) */
        .footer-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--primary); color: white;
            text-align: center; padding: 10px;
            border-top: 3px solid var(--accent);
            font-size: 0.75rem; z-index: 2000;
            display: flex; justify-content: center; align-items: center; gap: 5px;
        }

        /* الهيدر الرسمي للطباعة */
        .official-header { display: none; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 2px solid #000; }
        
        @media print {
            .no-print { display: none !important; }
            .official-header { display: block !important; }
            body { background: white; padding: 0; }
            .student-card { border: 1px solid #000 !important; box-shadow: none !important; break-inside: avoid; }
            .wa-float { display: none; }
            .footer-bar { position: static; color: black; background: white; border: none; font-weight: bold; margin-top: 30px; }
        }
    </style>
</head>
<body>

<div class="official-header">
    <table width="100%" dir="rtl">
        <tr>
            <td width="30%" style="text-align: right; font-size: 0.8rem; font-weight: bold;">
                سلطنة عمان<br>وزارة التربية والتعليم<br>مدرسة صلالة الشرقية (5-9)
            </td>
            <td width="40%" style="text-align: center;">
                <i class="fas fa-graduation-cap" style="font-size: 2.5rem;"></i><br>
                <h3 style="margin: 5px 0;">تقرير الغياب والإنقطاع</h3>
            </td>
            <td width="30%" style="text-align: left; font-size: 0.8rem; font-weight: bold;">
                تاريخ: <span id="pDate"></span><br>العام الدراسي 2025/2026
            </td>
        </tr>
    </table>
</div>

<header class="app-header no-print">
    <h1><i class="fas fa-shield-alt"></i> منظومة الإشراف الإداري</h1>
</header>

<div class="container">
    
    <div id="radarSection" class="radar-card no-print">
        <div class="radar-title"><i class="fas fa-bell"></i> صفوف تحتاج للمتابعة:</div>
        <div id="radarList" class="radar-grid"></div>
    </div>

    <div class="filter-card no-print">
        <div class="filter-title"><i class="fas fa-search"></i> البحث والطباعة</div>
        <select id="gradeSel" onchange="updateSections()"></select>
        <select id="secSel" onchange="runAnalysis()"><option value="">-- اختر الشعبة --</option></select>
        <button class="btn-print" onclick="window.print()">
            <i class="fas fa-print"></i> طباعة التقرير الرسمي
        </button>
    </div>

    <div id="resultsArea">
        <div style="text-align: center; color: #94a3b8; padding: 40px;">
            <i class="fas fa-clipboard-check" style="font-size: 3rem; margin-bottom: 10px;"></i>
            <p>اختر الصف والشعبة لعرض الحالات</p>
        </div>
    </div>
</div>

<div class="footer-bar no-print">
    <i class="fas fa-code"></i> تصميم وتنفيذ الأستاذ: <span style="color:var(--accent); font-weight:700; margin-right:4px;">فيصل العريبي</span> | جميع الحقوق محفوظة ©
</div>
<div class="footer-bar" style="display:none;">
    تصميم وتنفيذ: أ. فيصل العريبي
</div>

<script>
    let students = []; let history = [];

    async function init() {
        const v = Date.now();
        const [sR, hR] = await Promise.all([
            fetch(`student_fone.json?v=${v}`),
            fetch(`attendance_history.json?v=${v}`)
        ]);
        students = await sR.json();
        history = await hR.json();
        
        document.getElementById('pDate').innerText = new Date().toLocaleDateString('ar-OM');
        
        // --- تصحيح القائمة (حذف الفراغات والترتيب) ---
        const rawGrades = [...new Set(students.map(s => s.grade))];
        
        // 1. فلترة: حذف القيم الفارغة أو null أو المسافات
        const cleanGrades = rawGrades.filter(g => g && String(g).trim() !== "");
        
        // 2. ترتيب: تحويلها لأرقام لضمان الترتيب الصحيح 5, 6, 7
        cleanGrades.sort((a, b) => Number(a) - Number(b));

        document.getElementById('gradeSel').innerHTML = '<option value="">-- اختر الصف --</option>' + 
            cleanGrades.map(g => `<option value="${g}">${g}</option>`).join('');
        // ---------------------------------------------

        buildRadar();
    }

    function updateSections() {
        const g = document.getElementById('gradeSel').value;
        // تنظيف وترتيب الشعب أيضاً
        const rawSections = [...new Set(students.filter(s => String(s.grade) === g).map(s => s.section))];
        const cleanSections = rawSections.filter(s => s && String(s).trim() !== "").sort();

        document.getElementById('secSel').innerHTML = '<option value="">-- اختر الشعبة --</option>' + 
            cleanSections.map(s => `<option value="${s}">${s}</option>`).join('');
        
        runAnalysis();
    }

    function buildRadar() {
        const list = document.getElementById('radarList');
        const section = document.getElementById('radarSection');
        list.innerHTML = "";
        
        const classes = [...new Set(students.map(s => `${s.grade}|${s.section}`))];

        // ترتيب الرادار أيضاً
        classes.sort((a,b) => {
            const [g1, s1] = a.split('|');
            const [g2, s2] = b.split('|');
            return Number(g1) - Number(g2) || s1.localeCompare(s2);
        });

        classes.forEach(cls => {
            const [g, s] = cls.split('|');
            if(!g || g === "undefined" || !s) return; // تجاهل البيانات التالفة

            const classSt = students.filter(st => String(st.grade)===g && String(st.section)===s);
            let hasIssue = false;

            classSt.forEach(st => {
                const abs = history.filter(h => h.name === st.name).map(h => h.date).sort();
                if(getConsec(abs) >= 3 || getMaxWeek(abs) >= 3) hasIssue = true;
            });

            if(hasIssue) {
                const btn = document.createElement('div');
                btn.className = 'alert-badge';
                btn.innerText = `صف ${g}/${s}`;
                btn.onclick = () => {
                    document.getElementById('gradeSel').value = g;
                    updateSections();
                    document.getElementById('secSel').value = s;
                    runAnalysis();
                };
                list.appendChild(btn);
            }
        });

        if(list.innerHTML !== "") section.style.display = 'block';
    }

    function runAnalysis() {
        const g = document.getElementById('gradeSel').value;
        const s = document.getElementById('secSel').value;
        const area = document.getElementById('resultsArea');
        if(!g || !s) return;

        let html = "";
        const filtered = students.filter(x => String(x.grade) === g && String(x.section) === s);

        filtered.forEach(st => {
            const abs = history.filter(h => h.name === st.name).map(h => h.date).sort();
            const consec = getConsec(abs);
            const weekMax = getMaxWeek(abs);

            if(consec >= 3 || weekMax >= 3) {
                const isCritical = consec >= 3;
                const statusText = isCritical ? `منقطع عن الدراسة (${consec} أيام متتالية)` : `غياب متكرر (${weekMax} أيام في أسبوع)`;
                const badgeClass = isCritical ? 'bg-red' : 'bg-orange';
                const cardClass = isCritical ? 'critical' : 'warning';
                
                let waMsg = `مدرسة صلالة الشرقية\nعناية ولي أمر الطالب: *${st.name}*\n`;
                if(isCritical) waMsg += `نحيطكم علماً بأن الطالب منقطع منذ ${consec} أيام. يرجى مراجعة المدرسة فوراً.`;
                else waMsg += `نلاحظ تكرار غياب الطالب بمعدل ${weekMax} أيام أسبوعياً. نرجو المتابعة.`;

                html += `
                <div class="student-card ${cardClass}">
                    <span class="st-name">${st.name}</span>
                    <span class="st-status ${badgeClass}">${statusText}</span>
                    <div class="st-dates">تواريخ الغياب: ${abs.join(' | ')}</div>
                    <a href="https://wa.me/${st.phone}?text=${encodeURIComponent(waMsg)}" target="_blank" class="wa-float no-print">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                </div>`;
            }
        });

        area.innerHTML = html || '<div style="text-align:center; padding:20px;">ممتاز! لا توجد حالات غياب تستدعي التنبيه في هذا الصف.</div>';
    }

    function getConsec(dates) {
        if(dates.length < 2) return dates.length;
        const d = dates.map(x => new Date(x)).sort((a,b)=>a-b);
        let max=1, c=1;
        for(let i=1; i<d.length; i++) {
            if((d[i]-d[i-1])/(1000*60*60*24) === 1) c++;
            else { max=Math.max(max,c); c=1; }
        }
        return Math.max(max,c);
    }

    function getMaxWeek(dates) {
        const counts = {};
        dates.forEach(x => {
            const d = new Date(x);
            const k = `${d.getMonth()}-${Math.ceil(d.getDate()/7)}`;
            counts[k] = (counts[k] || 0) + 1;
        });
        return Math.max(...Object.values(counts), 0);
    }

    window.onload = init;
</script>
</body>
</html>
