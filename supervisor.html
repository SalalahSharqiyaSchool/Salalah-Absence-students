<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>أداة إشراف الغياب - مدرسة صلالة الشرقية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --primary: #0f172a; --accent: #d4af37; --bg: #f1f5f9; --red: #ef4444; --green: #22c55e; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; padding: 0; }
        
        /* تصميم الهيدر */
        .top-bar { background: var(--primary); color: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--accent); }
        .top-bar h2 { margin: 0; font-size: 1.2rem; }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* الكروت */
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { display: block; font-weight: 700; margin-bottom: 8px; color: var(--primary); }
        
        select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: 'Cairo'; margin-bottom: 15px; font-size: 1rem; }
        
        .btn-print { background: var(--primary); color: var(--accent); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 800; font-family: 'Cairo'; margin-bottom: 20px; }

        /* نتائج التحليل */
        .student-box { border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative; border-right: 6px solid var(--primary); }
        .student-box.danger { border-right-color: var(--red); background: #fef2f2; }
        .student-name { font-weight: 900; font-size: 1rem; color: var(--primary); margin-bottom: 5px; }
        .absence-info { font-size: 0.85rem; color: #475569; margin-bottom: 10px; }

        .wa-link { display: inline-flex; align-items: center; gap: 8px; background: var(--green); color: white; padding: 6px 15px; border-radius: 20px; text-decoration: none; font-size: 0.8rem; font-weight: 700; }
        
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 800; margin-left: 5px; }
        .badge-red { background: var(--red); color: white; }
        .badge-orange { background: #f59e0b; color: white; }

        @media print {
            .no-print { display: none !important; }
            .card { box-shadow: none; border: 1px solid #ccc; }
            body { background: white; }
        }
    </style>
</head>
<body>

<div class="top-bar no-print">
    <h2><i class="fas fa-shield-alt"></i> أداة المشرف المستقلة</h2>
    <p style="margin:5px 0 0; font-size:0.8rem; opacity:0.8;">تحليل المنقطعين والغياب المتكرر</p>
</div>

<div class="container">
    <div class="card no-print">
        <label>1. اختر الصف:</label>
        <select id="gradeSelect" onchange="updateSections()"></select>

        <label>2. اختر الشعبة:</label>
        <select id="sectionSelect" onchange="startAnalysis()">
            <option value="">-- اختر الشعبة --</option>
        </select>

        <button class="btn-print" onclick="window.print()"><i class="fas fa-print"></i> طباعة التقرير كـ PDF</button>
    </div>

    <div id="resultsArea">
        </div>
</div>

<script>
    let students = [];
    let history = [];

    // تحميل البيانات مباشرة فور فتح الصفحة
    async function loadData() {
        try {
            const v = Date.now();
            const [sR, hR] = await Promise.all([
                fetch(`student_fone.json?v=${v}`),
                fetch(`attendance_history.json?v=${v}`)
            ]);
            students = await sR.json();
            history = await hR.json();

            // ملء الصفوف
            const grades = [...new Set(students.map(s => String(s.grade)))].sort();
            const gSelect = document.getElementById('gradeSelect');
            gSelect.innerHTML = '<option value="">-- اختر الصف --</option>' + 
                                grades.map(g => `<option value="${g}">${g}</option>`).join('');

        } catch (e) {
            alert("تأكد من وجود ملفات البيانات (student_fone.json و attendance_history.json) في نفس المجلد.");
        }
    }

    function updateSections() {
        const grade = document.getElementById('gradeSelect').value;
        const sections = [...new Set(students.filter(s => String(s.grade) === grade).map(s => String(s.section)))].sort();
        const sSelect = document.getElementById('sectionSelect');
        sSelect.innerHTML = '<option value="">-- اختر الشعبة --</option>' + 
                             sections.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    function startAnalysis() {
        const grade = document.getElementById('gradeSelect').value;
        const section = document.getElementById('sectionSelect').value;
        const resultsArea = document.getElementById('resultsArea');
        resultsArea.innerHTML = "";

        if(!grade || !section) return;

        const filtered = students.filter(s => String(s.grade) === grade && String(s.section) === section);

        filtered.forEach(st => {
            const absDates = history.filter(h => h.name === st.name).map(h => h.date).sort();
            if(absDates.length === 0) return;

            const consecutive = checkConsecutive(absDates);
            const weeklyCounts = getWeeklyCounts(absDates);
            const maxInWeek = Math.max(...Object.values(weeklyCounts), 0);

            // تصفية الحالات الهامة فقط
            if(consecutive >= 3 || maxInWeek >= 3) {
                renderStudent(st, consecutive, maxInWeek, absDates);
            }
        });

        if(resultsArea.innerHTML === "") {
            resultsArea.innerHTML = '<div class="card" style="text-align:center;">لا توجد حالات غياب تستدعي التدخل في هذه الشعبة.</div>';
        }
    }

    function renderStudent(st, consec, weekly, dates) {
        const resultsArea = document.getElementById('resultsArea');
        const isDanger = consec >= 5;
        
        let waMsg = `مدرسة صلالة الشرقية\nعناية ولي أمر الطالب: *${st.name}*\n`;
        if(isDanger) waMsg += `نحيطكم علماً بأن الطالب منقطع عن المدرسة لمدة (${consec}) أيام متتالية. يرجى مراجعة المدرسة فوراً.`;
        else if(weekly >= 3) waMsg += `نلاحظ تكرار غياب الطالب بمعدل (${weekly}) أيام خلال الأسبوع الواحد. يرجى المتابعة وتوضيح الأسباب.`;
        else waMsg += `نحيطكم علماً بأن الطالب غائب لمدة (${consec}) أيام متتالية.`;

        const box = document.createElement('div');
        box.className = `card student-box ${isDanger ? 'danger' : ''}`;
        box.innerHTML = `
            <div class="student-name">
                ${st.name} 
                ${isDanger ? '<span class="badge badge-red">منقطع</span>' : ''}
                ${weekly >= 3 ? '<span class="badge badge-orange">تجاوز الحد الأسبوعي</span>' : ''}
            </div>
            <div class="absence-info">
                <strong>الحالة:</strong> غياب ${consec} أيام متتالية | غياب ${weekly} أيام في أسبوع واحد.<br>
                <strong>التواريخ:</strong> <span style="font-size:0.75rem;">${dates.join(' | ')}</span>
            </div>
            <a href="https://wa.me/${st.phone}?text=${encodeURIComponent(waMsg)}" target="_blank" class="wa-link no-print">
                <i class="fab fa-whatsapp"></i> إرسال رسالة رسمية لولي الأمر
            </a>
        `;
        resultsArea.appendChild(box);
    }

    // دوال الحساب
    function checkConsecutive(dates) {
        if(dates.length < 2) return dates.length;
        const dObjs = dates.map(d => new Date(d)).sort((a,b)=>a-b);
        let max = 1, curr = 1;
        for(let i=1; i<dObjs.length; i++) {
            const diff = (dObjs[i]-dObjs[i-1])/(1000*60*60*24);
            if(diff === 1) curr++;
            else { max = Math.max(max, curr); curr = 1; }
        }
        return Math.max(max, curr);
    }

    function getWeeklyCounts(dates) {
        const counts = {};
        dates.forEach(d => {
            const date = new Date(d);
            const week = Math.ceil(date.getDate() / 7); // تقريبي للأسبوع
            const month = date.getMonth();
            const key = `${month}-${week}`;
            counts[key] = (counts[key] || 0) + 1;
        });
        return counts;
    }

    window.onload = loadData;
</script>

</body>
</html>
