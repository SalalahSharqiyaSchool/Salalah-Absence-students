<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>مذكرة إشراف الغياب - مدرسة صلالة الشرقية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --primary: #0f172a; --accent: #d4af37; --danger: #ef4444; --success: #25d366; --bg: #f8fafc; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--primary); }
        
        .no-print-zone { background: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }

        .header-box { text-align: center; border: 2px solid var(--primary); padding: 15px; margin-bottom: 30px; border-radius: 10px; display: none; }
        
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end; }
        select { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e2e8f0; font-family: 'Cairo'; font-weight: 600; }

        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-family: 'Cairo'; font-weight: 700; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .btn-print { background: var(--primary); color: var(--accent); }
        .btn-wa { background: var(--success); color: white; padding: 5px 12px; font-size: 0.85rem; border-radius: 5px; text-decoration: none; }

        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
        th { background: #f1f5f9; color: var(--primary); border: 1px solid #cbd5e1; padding: 12px; font-size: 0.9rem; }
        td { border: 1px solid #cbd5e1; padding: 10px; text-align: center; font-size: 0.9rem; vertical-align: middle; }

        .status-badge { padding: 3px 8px; border-radius: 5px; font-size: 0.75rem; font-weight: 700; display: block; margin-bottom: 5px; }
        .warning { background: #fff7ed; color: #9a3412; border: 1px solid #fed7aa; }
        .critical { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }

        .signature-section { margin-top: 50px; display: none; justify-content: space-between; padding: 0 50px; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .header-box, .signature-section { display: flex !important; flex-direction: column; }
            .header-box { display: block !important; }
            table { font-size: 10pt; }
            th { background: #eee !important; color: black !important; }
            .container { max-width: 100%; padding: 0; }
        }
    </style>
</head>
<body>

<div class="no-print-zone no-print">
    <div class="container">
        <h2 style="margin-top:0;"><i class="fas fa-file-medical-alt"></i> استخراج مذكرة متابعة الغياب</h2>
        <div class="filter-grid">
            <div>
                <label>اختر الصف:</label>
                <select id="gradeSelect" onchange="updateSections()"></select>
            </div>
            <div>
                <label>اختر الشعبة:</label>
                <select id="sectionSelect" onchange="generateReport()"></select>
            </div>
            <button class="btn btn-print" onclick="window.print()">
                <i class="fas fa-print"></i> طباعة المذكرة الورقية
            </button>
        </div>
    </div>
</div>

<div class="container">
    <div class="header-box">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="text-align: right;">سلطنة عمان<br>وزارة التربية والتعليم<br>مدرسة صلالة الشرقية (5-9)</div>
            <div style="font-weight: 900; font-size: 1.4rem;">مذكرة متابعة الطلاب (الغياب المتكرر والمنقطع)</div>
            <div style="text-align: left;">تاريخ التقرير: <span id="reportDate"></span></div>
        </div>
    </div>

    <div id="reportContent">
        <table>
            <thead>
                <tr>
                    <th width="20%">اسم الطالب</th>
                    <th width="10%">الصف/الشعبة</th>
                    <th width="30%">تحليل حالة الغياب</th>
                    <th width="25%">تواريخ الغياب المكتشفة</th>
                    <th width="15%" class="no-print">إجراء</th>
                </tr>
            </thead>
            <tbody id="reportTableBody">
                <tr><td colspan="5" class="no-data">يرجى اختيار الصف والشعبة لعرض البيانات</td></tr>
            </tbody>
        </table>
    </div>

    <div class="signature-section">
        <div>توقيع مشرف الصف: ............................</div>
        <div>اعتماد مدير المدرسة: ............................</div>
    </div>
</div>

<script>
    let students = [];
    let history = [];

    async function loadInitialData() {
        try {
            const v = Date.now();
            const [sR, hR] = await Promise.all([
                fetch(`student_fone.json?v=${v}`),
                fetch(`attendance_history.json?v=${v}`)
            ]);
            students = await sR.json();
            history = await hR.json();

            document.getElementById('reportDate').innerText = new Date().toLocaleDateString('ar-OM');

            const grades = [...new Set(students.map(s => String(s.grade)))].sort();
            const gSelect = document.getElementById('gradeSelect');
            gSelect.innerHTML = '<option value="">اختر الصف</option>' + grades.map(g => `<option value="${g}">${g}</option>`).join('');
        } catch (e) { alert("خطأ في تحميل البيانات"); }
    }

    function updateSections() {
        const grade = document.getElementById('gradeSelect').value;
        const sections = [...new Set(students.filter(s => String(s.grade) === grade).map(s => String(s.section)))].sort();
        const sSelect = document.getElementById('sectionSelect');
        sSelect.innerHTML = '<option value="">الشعبة</option>' + sections.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    function generateReport() {
        const grade = document.getElementById('gradeSelect').value;
        const section = document.getElementById('sectionSelect').value;
        if (!grade || !section) return;

        const tableBody = document.getElementById('reportTableBody');
        tableBody.innerHTML = "";

        const filteredStudents = students.filter(s => String(s.grade) === grade && String(s.section) === section);

        filteredStudents.forEach(student => {
            const studentAbsences = history.filter(h => h.name === student.name).map(h => h.date).sort();
            if (studentAbsences.length === 0) return;

            const consecutive = getMaxConsecutive(studentAbsences);
            const weeklyCounts = getWeeklyCounts(studentAbsences);
            const maxInWeek = Math.max(...Object.values(weeklyCounts), 0);

            // نفلتر فقط الحالات التي تستحق المتابعة (منقطع 3+ أيام أو غاب 3+ أيام في أسبوع)
            if (consecutive >= 3 || maxInWeek >= 3) {
                const row = document.createElement('tr');
                
                let statusInfo = "";
                let waMsg = "";

                if (consecutive >= 5) {
                    statusInfo += `<span class="status-badge critical">انقطاع كلي (${consecutive} أيام متصلة)</span>`;
                    waMsg = `نحيطكم علماً بأن الطالب منقطع عن الدراسة لمدة (${consecutive}) أيام متتالية. يرجى مراجعة المدرسة فوراً.`;
                } else if (consecutive >= 3) {
                    statusInfo += `<span class="status-badge warning">انقطاع جزئي (${consecutive} أيام متصلة)</span>`;
                    waMsg = `نحيطكم علماً بأن الطالب غائب لمدة (${consecutive}) أيام متتالية. يرجى توضيح السبب.`;
                }

                if (maxInWeek >= 3) {
                    statusInfo += `<span class="status-badge warning">غياب متكرر (${maxInWeek} أيام في أسبوع)</span>`;
                    if(!waMsg) waMsg = `نلاحظ تكرار غياب الطالب بمعدل (${maxInWeek}) أيام خلال الأسبوع الواحد. يرجى المتابعة.`;
                }

                row.innerHTML = `
                    <td style="text-align:right; font-weight:bold;">${student.name}</td>
                    <td>${student.grade} / ${student.section}</td>
                    <td>${statusInfo}</td>
                    <td style="font-size:0.8rem; color:#444;">${studentAbsences.join(' ، ')}</td>
                    <td class="no-print">
                        <a href="https://wa.me/${student.phone}?text=${encodeURIComponent('مدرسة صلالة الشرقية\nإلى ولي أمر الطالب: ' + student.name + '\n' + waMsg)}" 
                           target="_blank" class="btn-wa">
                           <i class="fab fa-whatsapp"></i> مراسلة
                        </a>
                    </td>
                `;
                tableBody.appendChild(row);
            }
        });

        if (tableBody.innerHTML === "") {
            tableBody.innerHTML = '<tr><td colspan="5" style="padding:30px;">لا توجد حالات تستدعي المتابعة في هذه الشعبة</td></tr>';
        }
    }

    function getMaxConsecutive(dateStrings) {
        if (dateStrings.length === 0) return 0;
        const dates = dateStrings.map(d => new Date(d)).sort((a,b)=>a-b);
        let max = 1, current = 1;
        for (let i = 1; i < dates.length; i++) {
            const diff = (dates[i] - dates[i-1]) / (1000 * 60 * 60 * 24);
            if (diff === 1) current++;
            else { max = Math.max(max, current); current = 1; }
        }
        return Math.max(max, current);
    }

    function getWeeklyCounts(dateStrings) {
        const counts = {};
        dateStrings.forEach(ds => {
            const d = new Date(ds);
            const week = getWeekNum(d);
            counts[week] = (counts[week] || 0) + 1;
        });
        return counts;
    }

    function getWeekNum(d) {
        const date = new Date(d.getTime());
        date.setHours(0, 0, 0, 0);
        date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
        const week1 = new Date(date.getFullYear(), 0, 4);
        return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
    }

    window.onload = loadInitialData;
</script>

</body>
</html>
