<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>منصة مدرسة صلالة الشرقية الرقمية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { 
            --primary: #0f172a; [cite: 1]
            --accent: #d4af37; [cite: 2]
            --bg: #f8fafc; 
            --card-bg: #ffffff; 
            --success: #10b981; 
            --wa: #25d366; 
            --danger: #ef4444; 
            --edit: #3b82f6; [cite: 2]
        }

        body { 
            font-family: 'Cairo', sans-serif; [cite: 3]
            background: var(--bg); [cite: 4]
            margin: 0; 
            padding-bottom: 160px; 
            color: var(--primary); 
            overflow-x: hidden; [cite: 5]
        }
        
        /* الهيدر المطور */
        .official-header { 
            background: var(--primary); [cite: 6]
            color: white; 
            padding: 12px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 3px solid var(--accent); 
            position: sticky; 
            top: 0; [cite: 7]
            z-index: 1000; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
        }

        .school-info h1 { 
            margin: 0; [cite: 8]
            font-size: clamp(0.75rem, 4vw, 1.1rem); 
            color: var(--accent); 
            font-weight: 800; 
        }
        
        .user-controls { 
            display: flex; [cite: 9]
            align-items: center; 
            gap: 12px; 
        }

        .user-info { 
            display: flex; [cite: 10]
            flex-direction: column; 
            align-items: flex-end; 
            border-right: 2px solid var(--accent); 
            padding-right: 10px; [cite: 11]
        }

        .teacher-name { 
            font-size: 0.85rem; [cite: 12]
            font-weight: 700; 
            color: #fff; 
        }

        #liveClock { 
            font-size: 0.7rem; [cite: 13]
            opacity: 0.8; 
        }
        
        .logout-btn { 
            background: rgba(239, 68, 68, 0.1); [cite: 14]
            color: #ff6b6b; 
            border: 1px solid #ef4444; 
            width: 35px; 
            height: 35px; 
            border-radius: 8px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; [cite: 15]
            transition: 0.3s; 
        }

        .logout-btn:hover { background: var(--danger); color: white; [cite: 16] }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; [cite: 17] }
        
        .card { 
            background: var(--card-bg); [cite: 18]
            border-radius: 15px; 
            padding: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
            border: 1px solid #e2e8f0; [cite: 19]
        }

        .card-title { 
            display: flex; [cite: 20]
            align-items: center; 
            gap: 10px; 
            font-weight: 800; 
            margin-bottom: 15px; 
            border-bottom: 2px solid #f1f5f9; 
            padding-bottom: 10px; 
            color: var(--primary); [cite: 21]
        }

        label { display: block; font-weight: 700; margin-bottom: 5px; font-size: 0.9rem; color: #475569; [cite: 22] }
        
        select, input { 
            width: 100%; [cite: 23]
            padding: 12px; 
            border: 2px solid #e2e8f0; 
            border-radius: 10px; 
            font-family: 'Cairo'; 
            margin-bottom: 15px; 
            box-sizing: border-box; 
            font-size: 1rem; 
            outline: none; [cite: 24]
        }

        select:focus, input:focus { border-color: var(--accent); [cite: 25] }

        .btn { 
            border: none; [cite: 26]
            border-radius: 10px; 
            font-family: 'Cairo'; 
            font-weight: 800; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            width: 100%; 
            padding: 12px; [cite: 27]
            transition: 0.2s; 
        }

        .btn-primary { background: var(--primary); color: var(--accent); [cite: 28] }
        .btn-success { background: var(--success); color: white; [cite: 29] }
        .btn-danger { background: var(--danger); color: white; [cite: 30] }
        .btn-cancel { background: #f1f5f9; color: #475569; [cite: 31] }
        
        .modal-overlay { 
            position: fixed; [cite: 32]
            top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.7); 
            display:none; 
            justify-content:center; 
            align-items:center; 
            z-index:3000; 
            padding: 20px; [cite: 33]
        }

        .modal-content { 
            background: white; [cite: 34]
            padding: 25px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 400px; 
            text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); [cite: 35]
        }
        
        .item-row { 
            display: flex; [cite: 36]
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            background: #fff; 
            border-radius: 10px; 
            margin-bottom: 8px; 
            border-right: 5px solid var(--accent); 
            border: 1px solid #eee; [cite: 37]
        }

        .action-icons { display: flex; gap: 15px; [cite: 38] }
        .action-icons i { cursor: pointer; font-size: 1.2rem; [cite: 39] }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; [cite: 40] }
        th, td { padding: 10px; border: 1px solid #cbd5e1; text-align: center; font-size: 0.85rem; [cite: 41] }
        th { background: #f8fafc; font-weight: 900; [cite: 42] }

        .bottom-nav { 
            position: fixed; [cite: 43]
            bottom: 35px; 
            left: 0; right: 0; 
            background: white; 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            border-top: 1px solid #eee; [cite: 44]
            z-index: 1200; 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05); 
        }

        .nav-item { 
            display: flex; [cite: 45]
            flex-direction: column; 
            align-items: center; 
            color: #94a3b8; 
            cursor: pointer; 
            font-size: 0.8rem; 
            font-weight: 700; 
            transition: 0.3s; [cite: 46]
        }

        .nav-item.active { color: var(--primary); [cite: 47] }

        .extra-bottom-bar { 
            position: fixed; [cite: 48]
            bottom: 0; 
            left: 0; right: 0; 
            height: 35px; 
            background: var(--primary); 
            color: var(--accent); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.75rem; [cite: 49]
            font-weight: 700; 
            z-index: 1300; 
            border-top: 1px solid var(--accent); 
        }

        .section { display: none; [cite: 50] }
        .section.active { display: block; [cite: 51] }

        /* تنسيقات الطباعة */
        #printHeader, .footer-stamp { display: none; [cite: 52] }
        @media print {
            .no-print, .bottom-nav, .extra-bottom-bar, .official-header, .btn, input, select, label { display: none !important; [cite: 53] }
            #printHeader, .footer-stamp { display: block !important; [cite: 54] }
            body { background: white !important; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; [cite: 55] }
            .container { max-width: 100% !important; margin: 0 !important; padding: 0 !important; [cite: 56] }
            .card { border: none !important; box-shadow: none !important; padding: 0 !important; [cite: 57] }
            table { width: 100%; border: 2px solid #000 !important; border-collapse: collapse; margin-top: 10px; [cite: 58] }
            th { background-color: #f2f2f2 !important; border: 1px solid #000 !important; color: #000 !important; font-weight: bold; [cite: 59, 60] }
            td { border: 1px solid #000 !important; color: #000 !important; padding: 8px; [cite: 61] }
            .date-cell { white-space: pre-line !important; line-height: 1.6; text-align: right !important; padding-right: 15px !important; [cite: 62] }
        }
    </style>
</head>
<body>

<script>
    if (sessionStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'index.html'; [cite: 63]
    }
</script>

<div id="printHeader">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 10px;">
        <div style="text-align: right; line-height: 1.4; font-weight: bold; font-size: 0.9rem;">
            <p>سلطنة عمان</p>
            <p>وزارة التربية والتعليم</p>
            <p>المديرية العامة للتربية والتعليم بمحافظة ظفار</p>
            <p>مدرسة صلالة الشرقية للتعليم الأساسي (5-9)</p>
        </div> [cite: 64]
        <div class="logo-area">
            <img src="data/logo.jpeg" style="width: 85px;" onerror="this.src='https://via.placeholder.com/85?text=Logo'"> [cite: 65]
        </div>
    </div>
    <h1 id="dynamicTitlePrint" style="text-align: center; text-decoration: underline; font-size: 1.5rem; font-weight: 900; margin: 15px 0;">تقرير غياب رسمي</h1>
    <div id="printStudentInfo" style="border: 2px solid #000; padding: 12px; background: #f9f9f9; margin-bottom: 15px; line-height: 1.7; font-size: 1rem;"></div>
</div>

<header class="official-header no-print">
    <div class="school-info"><h1>مدرسة صلالة الشرقية (5-9)</h1></div>
    <div class="user-controls">
        <div class="user-info">
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-user-circle" style="color: var(--accent);"></i>
                <span class="teacher-name" id="displayTeacherName">المعلم</span> [cite: 66]
            </div>
            <div id="liveClock" style="font-size: 0.75rem; color: #cbd5e1; font-weight: 600; margin-top: 2px;"></div>
        </div>
        <button class="logout-btn" onclick="logout()" title="تسجيل الخروج">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>
</header>

<div class="container">
    <section id="absent-section" class="section active">
        <div class="card no-print">
            <div class="card-title"><i class="fas fa-calendar-check"></i> رصد الغياب اليومي</div>
            <label>التاريخ</label>
            <input type="date" id="absentDate"> [cite: 67]
            <div style="display: flex; gap:10px;"> [cite: 68]
                <select id="mainGradeSelect" onchange="updateSections('mainGradeSelect','mainSectionSelect'); updateStudents();"></select> [cite: 69]
                <select id="mainSectionSelect" onchange="updateStudents()"></select>
            </div>
            <label>اختيار الطالب</label>
            <select id="studentDropdown" onchange="addToList()"><option value="">-- اختر الصف والشعبة --</option></select>
            <div id="selectedList" style="margin-top:15px;"></div>
            <button class="btn btn-primary" onclick="saveData()"><i class="fas fa-save"></i> حفظ وإرسال السجل</button> [cite: 70]
        </div>
    </section>

    <section id="report-section" class="section">
        <div class="card">
            <div class="no-print">
                <div class="card-title"><i class="fas fa-file-invoice"></i> نظام التقارير</div>
                <select id="reportMode" onchange="toggleReportUI()">
                    <option value="student">تقرير طالب محدد</option> [cite: 71]
                    <option value="class">كشف غياب الصف المجمع</option>
                </select>
                <div style="display: flex; gap:10px;"> [cite: 72]
                    <select id="repGradeSelect" onchange="updateSections('repGradeSelect','repSectionSelect'); updateReportStudentList();"></select> [cite: 73]
                    <select id="repSectionSelect" onchange="updateReportStudentList()"></select>
                </div>
                <div id="studentSelectDiv"><label>اسم الطالب</label><select id="repStudentSelect"></select></div>
                <div style="display: flex; gap:10px;"> [cite: 74]
                    <input type="date" id="repDateStart">
                    <input type="date" id="repDateEnd">
                </div>
                <button class="btn btn-primary" onclick="generateReport()">عرض التقرير</button> [cite: 75]
            </div>
            
            <div id="reportResult"></div> [cite: 76]

            <div class="footer-stamp">
                <div style="display: flex; justify-content: space-between; margin-top: 40px; font-weight: bold; border-top: 2px solid #000; padding-top: 15px;"> [cite: 77]
                    <p>يعتمد / مدير المدرسة: .........................</p>
                    <p>تاريخ الاستخراج: <span id="printDateStamp"></span></p>
                </div>
            </div>

            <button class="btn btn-primary no-print" id="printBtn" onclick="initiatePrint()" style="display:none; margin-top:15px; width:100%; background: #334155;"> [cite: 78]
                <i class="fas fa-print"></i> طباعة التقرير الرسمي / PDF
            </button>
        </div>
    </section>

    <section id="manage-section" class="section">
        <div class="card">
            <div class="card-title"><i class="fas fa-user-plus"></i> إضافة طالب جديد</div>
            <input type="text" id="newName" placeholder="الاسم الرباعي"> [cite: 79]
            <input type="tel" id="newPhone" placeholder="رقم التواصل"> [cite: 80]
            <div style="display:flex; gap:10px;">
                <input type="text" id="newGrade" placeholder="مثال: الخامس" style="flex:1"> [cite: 81]
                <input type="text" id="newSection" placeholder="مثال: 1" style="flex:1">
            </div>
            <button class="btn btn-success" onclick="addNewStudent()">إضافة وحفظ</button>
        </div>
        <div class="card">
            <div class="card-title"><i class="fas fa-user-edit"></i> تعديل بيانات الطلاب</div> [cite: 82]
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <select id="manageGradeSelect" onchange="updateSections('manageGradeSelect','manageSectionSelect'); renderManagerList();"></select> [cite: 83]
                <select id="manageSectionSelect" onchange="renderManagerList()"></select>
            </div>
            <div id="managerListArea"></div>
        </div>
    </section>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-content" style="text-align: right;">
        <h3>تعديل البيانات</h3>
        <p>الطالب: <b id="displayStudentName"></b></p>
        <input type="hidden" id="editOldName"> [cite: 84]
        <label>الشعبة الجديدة</label>
        <input type="text" id="editSectionInput">
        <label>رقم الهاتف الجديد</label>
        <input type="tel" id="editPhoneInput"> [cite: 85]
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-success" style="flex:2" onclick="submitStudentEdit()">تحديث</button>
            <button class="btn btn-cancel" style="flex:1" onclick="closeModal()">إلغاء</button>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <i class="fas fa-exclamation-triangle" style="font-size:3rem; color:var(--danger); margin-bottom:15px;"></i> [cite: 86]
        <h3>تأكيد الحذف</h3>
        <p>هل تريد حذف الطالب <br><b id="deleteStudentName" style="color:var(--danger)"></b> نهائياً؟</p> [cite: 87]
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-danger" style="flex:1" id="confirmDeleteBtn">نعم، احذف</button>
            <button class="btn btn-cancel" style="flex:1" onclick="closeModal()">إلغاء</button>
        </div>
    </div>
</div>

<div id="successModal" class="modal-overlay">
    <div class="modal-content">
        <i class="fas fa-check-circle" style="font-size:3.5rem; color:var(--success); margin-bottom:15px;"></i> [cite: 88]
        <h3 id="successMsg">تمت العملية بنجاح</h3>
        <button class="btn btn-primary" onclick="closeModal()">موافق</button>
    </div>
</div>

<div id="customAlertModal" class="modal-overlay">
    <div class="modal-content">
        <i id="alertIcon" class="fas fa-info-circle" style="font-size:3rem; margin-bottom:15px; color:var(--primary);"></i> [cite: 89]
        <h3 id="alertTitle" style="margin-bottom:10px;">تنبيه</h3>
        <p id="alertMessage" style="color:#666; font-size:1rem;"></p> [cite: 90]
        <button class="btn btn-primary" onclick="closeCustomAlert()" style="margin-top:20px;">حسناً</button>
    </div>
</div>

<div id="confirmActionModal" class="modal-overlay">
    <div class="modal-content">
        <i class="fas fa-trash-alt" style="font-size:3rem; color:var(--danger); margin-bottom:15px;"></i> [cite: 91]
        <h3>تأكيد الحذف</h3>
        <p id="confirmMsgContent" style="margin-bottom:20px;">هل أنت متأكد من حذف هذا السجل؟</p> [cite: 92]
        <div style="display:flex; gap:10px;">
            <button id="btnConfirmYes" class="btn btn-danger" style="flex:1">نعم، احذف</button>
            <button class="btn btn-cancel" style="flex:1" onclick="closeConfirmModal()">تراجع</button>
        </div>
    </div>
</div>

<nav class="bottom-nav no-print">
    <div class="nav-item active" onclick="switchTab('absent-section', this)"><i class="fas fa-edit"></i><span>الرصد</span></div>
    <div class="nav-item" onclick="switchTab('report-section', this)"><i class="fas fa-print"></i><span>التقارير</span></div>
    <div id="navManageBtn" class="nav-item" onclick="switchTab('manage-section', this)"><i class="fas fa-users-cog"></i><span>الإدارة</span></div>
</nav>

<div class="extra-bottom-bar no-print">تصميم وتنفيذ الأستاذ فيصل العريبي © 2026</div>

<script>
    let students = []; 
    let history = []; 
    let currentBatch = []; 
    let deleteTargetName = "";

    function logout() {
        sessionStorage.clear();
        window.location.href = 'index.html'; [cite: 93]
    }

    function updateLiveDateTime() {
        const now = new Date();
        const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت']; [cite: 94]
        const dayName = days[now.getDay()];
        const dateStr = now.toLocaleDateString('ar-OM', { day: 'numeric', month: 'long', year: 'numeric' });
        document.getElementById('liveClock').innerHTML = `${dayName} | ${dateStr}`;
    }

    function getDayName(dateString) {
        const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت']; [cite: 95]
        return days[new Date(dateString).getDay()]; [cite: 96]
    }
// --- إضافة: دالة التحقق من الصلاحيات وتحديد الصفوف المسموحة ---
    function applyPermissions() {
        const role = sessionStorage.getItem('userRole');
        const manageBtn = document.querySelector('.nav-item i.fa-users-cog')?.parentElement;

        if (role === 'teacher') {
            // إخفاء زر الإدارة من القائمة السفلية للمعلم
            if (manageBtn) manageBtn.style.display = 'none';
        }
    }
   async function loadData() {
    const tName = sessionStorage.getItem('teacherName');
    if(tName && document.getElementById('displayTeacherName')) {
         document.getElementById('displayTeacherName').innerText = tName;
    }

    const v = Date.now();
    try {
        const [sR, hR] = await Promise.all([
            fetch(`student_fone.json?v=${v}`), 
            fetch(`attendance_history.json?v=${v}`)
        ]);
        
        students = await sR.json();
        history = await hR.json();
        
        const today = new Date().toISOString().split('T')[0];
        document.querySelectorAll('input[type="date"]').forEach(i => i.value = today);
        
        updateLiveDateTime();
        
        // تنفيذ الصلاحيات أولاً ثم بناء القوائم
        applyPermissions();
        initGrades(); 
        
    } catch(e) { 
        console.error("Error loading data", e);
        showCustomAlert("فشل في تحميل البيانات الأساسية", "error");
    }
}

   function applyPermissions() {
    const role = sessionStorage.getItem('userRole');
    const navManageBtn = document.getElementById('navManageBtn');

    if (role === 'teacher') {
        // إخفاء زر الإدارة تماماً من القائمة السفلية للمعلم
        if (navManageBtn) navManageBtn.style.display = 'none';
        console.log("صلاحيات معلم: تم إخفاء قسم الإدارة");
    }
}

  function initGrades() {
    const role = sessionStorage.getItem('userRole');
    // جلب الصفوف المسموحة من الذاكرة
    const myGrades = JSON.parse(sessionStorage.getItem('myGrades') || "[]");
    
    // جلب كل الصفوف المتاحة في ملف الطلاب
    let grades = [...new Set(students.map(s => String(s.grade).trim()).filter(g => g))].sort();

    // إذا كان المستخدم معلماً، نقوم بتصفية الصفوف لتظهر المسموحة له فقط
    if (role === 'teacher' && myGrades.length > 0) {
        grades = grades.filter(g => {
            return myGrades.some(myG => String(g).includes(String(myG)) || String(myG).includes(String(g)));
        });
    }

    // تعبئة جميع القوائم المنسدلة في الصفحة
    ['mainGradeSelect', 'repGradeSelect', 'manageGradeSelect'].forEach(id => {
        const el = document.getElementById(id); 
        if(!el) return;
        el.innerHTML = '<option value="">الصف</option>';
        grades.forEach(g => el.innerHTML += `<option value="${g}">${g}</option>`);
    });
}

    function updateSections(gId, sId) {
        const g = document.getElementById(gId).value; [cite: 107]
        const sEl = document.getElementById(sId); 
        const currentVal = sEl.value;
        sEl.innerHTML = '<option value="">ش</option>'; [cite: 108]
        if(!g) return;
        const sections = [...new Set(students.filter(s => String(s.grade) === g).map(s => String(s.section)))].sort(); [cite: 109]
        sections.forEach(s => sEl.innerHTML += `<option value="${s}">${s}</option>`);
        if (Array.from(sEl.options).some(o => o.value === currentVal)) sEl.value = currentVal;
    }

    function updateStudents() {
        const g = document.getElementById('mainGradeSelect').value; [cite: 110]
        const s = document.getElementById('mainSectionSelect').value;
        const drop = document.getElementById('studentDropdown'); 
        drop.innerHTML = '<option value="">-- اختر الطالب --</option>'; [cite: 111]
        if(!g || !s) return;
        students.filter(x => String(x.grade) === g && String(x.section) === s)
                .sort((a,b)=>a.name.localeCompare(b.name, 'ar')) [cite: 112]
                .forEach(st => {
                    drop.innerHTML += `<option value="${st.name}" data-phone="${st.phone}">${st.name}</option>`;
                });
    }

    function addToList() {
        const d = document.getElementById('studentDropdown'); [cite: 113]
        if(!d.value || currentBatch.find(x => x.name === d.value)) return;
        currentBatch.push({ 
            name: d.value, 
            phone: d.options[d.selectedIndex].getAttribute('data-phone') 
        }); [cite: 114]
        renderBatch(); 
        d.selectedIndex = 0;
    }

   function renderBatch() {
        const date = document.getElementById('absentDate').value;
        const listArea = document.getElementById('selectedList');
        
        if (currentBatch.length === 0) {
            listArea.innerHTML = '<p style="text-align:center; color:#94a3b8; font-size:0.9rem;">لم يتم اختيار طلاب بعد</p>';
            return;
        }

        let html = `<p style="font-weight:700; font-size:0.85rem; margin-bottom:10px; color:var(--primary);">الطلاب المختارون: (${currentBatch.length})</p>`;
        
        html += currentBatch.map((s, i) => `
            <div class="item-row">
                <span>${s.name}</span>
                <div class="action-icons">
                    <i class="fab fa-whatsapp" style="color:var(--wa)" onclick="sendWA('${s.phone}','${s.name}','${date}')"></i>
                    <i class="fas fa-minus-circle" style="color:var(--danger)" onclick="currentBatch.splice(${i},1);renderBatch();"></i>
                </div>
            </div>`).join('');
            
        listArea.innerHTML = html;
    }

    function sendWA(phone, name, date) {
        const day = getDayName(date); [cite: 118]
        const text = `مدرسة صلالة الشرقية%0Aغياب الطالب: *${name}*%0Aيوم: *${day}* الموافق: *${date}*`; [cite: 119]
        window.open(`https://wa.me/${phone}?text=${text}`, '_blank');
    }

   async function saveData() {
        if(!currentBatch.length) {
            showCustomAlert("يرجى اختيار طالب واحد على الأقل قبل الحفظ", "error");
            return;
        }

        showConfirmDialog("هل أنت متأكد من حفظ وإرسال سجل الغياب المحدد؟", async function() {
            const date = document.getElementById('absentDate').value;
            const g = document.getElementById('mainGradeSelect').value;
            const s = document.getElementById('mainSectionSelect').value;
            const entries = currentBatch.map(b => ({ name: b.name, date, class: `${g}-${s}` }));
            
            try {
                const res = await fetch('/api/save-attendance', { 
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify(entries) 
                });
                if(res.ok) { 
                    history.push(...entries);
                    currentBatch = []; 
                    renderBatch(); 
                    showSuccess("تم تسجيل الغياب وإرسال البيانات بنجاح"); 
                }
            } catch(e) { 
                showCustomAlert("فشل الاتصال بالخادم، يرجى التحقق من الإنترنت", "error");
            }
        });
    }

    function generateReport() {
        const mode = document.getElementById('reportMode').value; [cite: 126]
        const start = document.getElementById('repDateStart').value;
        const end = document.getElementById('repDateEnd').value; [cite: 127]
        const resDiv = document.getElementById('reportResult');
        let html = ""; infoPrint = "";
        if (!start || !end) { showCustomAlert("يرجى تحديد تاريخ البداية والنهاية", "error"); return; [cite: 128] }

        if (mode === 'student') {
            const name = document.getElementById('repStudentSelect').value; [cite: 129]
            const g = document.getElementById('repGradeSelect').value;
            const s = document.getElementById('repSectionSelect').value;
            if (!name) { showCustomAlert("يرجى اختيار اسم الطالب", "error"); return; [cite: 130] }

            const data = history.filter(h => h.name === name && h.date >= start && h.date <= end); [cite: 131]
            document.getElementById('dynamicTitlePrint').innerText = "تقرير غياب طالب رسمي"; [cite: 132]
            infoPrint = `<b>اسم الطالب:</b> ${name} <br> <b>الصف:</b> ${g} / <b>الشعبة:</b> ${s} <br> <b>الفترة:</b> من ${start} إلى ${end}`; [cite: 133]
            html = `<h3>تقرير: ${name}</h3><table><thead><tr><th>م</th><th>اليوم</th><th>التاريخ</th><th class="no-print">إجراءات</th></tr></thead><tbody> [cite: 134, 135]
                    ${data.map((r, i) => `<tr><td>${i + 1}</td><td>${getDayName(r.date)}</td><td>${r.date}</td> [cite: 136, 137]
                    <td class="no-print"><i class="fas fa-trash-alt" style="color:var(--danger); cursor:pointer;" onclick="deleteAttendanceRecord('${r.name}', '${r.date}')"></i></td></tr> [cite: 138-140]`).join('')} [cite: 141]
                    </tbody></table>`; [cite: 142]
            if (data.length === 0) html += '<p style="text-align:center; padding:10px;">لا توجد غيابات مسجلة.</p>'; [cite: 143]
        } else {
            const g = document.getElementById('repGradeSelect').value; [cite: 144]
            const s = document.getElementById('repSectionSelect').value;
            if (!g || !s) { showCustomAlert("يرجى اختيار الصف والشعبة", "error"); return; [cite: 145] }
            const cData = history.filter(h => h.class === `${g}-${s}` && h.date >= start && h.date <= end); [cite: 146]
            const log = {}; [cite: 147]
            document.getElementById('dynamicTitlePrint').innerText = "كشف غياب الصف المجمع";
            infoPrint = `<b>كشف غياب الصف:</b> ${g} / <b>الشعبة:</b> ${s} <br> <b>الفترة:</b> من ${start} إلى ${end}`; [cite: 148]
            students.filter(st => String(st.grade) === g && String(st.section) === s).forEach(st => {
                const dates = cData.filter(d => d.name === st.name).map(d => `${getDayName(d.date)} (${d.date})`);
                if (dates.length > 0) log[st.name] = dates;
            }); [cite: 149]
            html = `<h3>كشف (${g}/${s})</h3><table><tr><th>الاسم</th><th style="width:70%">أيام الغياب</th><th>الإجمالي</th></tr> [cite: 150, 151]
                    ${Object.keys(log).sort().map(n => `<tr><td>${n}</td><td class="date-cell">${log[n].join('\n')}</td><td>${log[n].length}</td></tr> [cite: 152]`).join('')}</table>`;
        }
        resDiv.innerHTML = html; [cite: 153]
        document.getElementById('printStudentInfo').innerHTML = infoPrint; [cite: 154]
        document.getElementById('printBtn').style.display = 'block';
    }

    function renderManagerList() {
        const g = document.getElementById('manageGradeSelect').value; [cite: 155]
        const s = document.getElementById('manageSectionSelect').value;
        const area = document.getElementById('managerListArea'); 
        area.innerHTML = ''; [cite: 156]
        if(!g || !s) return;
        const filtered = students.filter(st => String(st.grade) === g && String(st.section) === s); [cite: 157]
        if(!filtered.length) { area.innerHTML = '<p>لا يوجد طلاب في هذه الشعبة</p>'; return; [cite: 158] }
        filtered.forEach(st => {
            area.innerHTML += `<div class="item-row"><span>${st.name}</span><div class="action-icons"> [cite: 159]
                    <i class="fas fa-edit" style="color:var(--edit)" onclick="openEditModal('${st.name}')"></i>
                    <i class="fas fa-trash-alt" style="color:var(--danger)" onclick="showDeleteModal('${st.name}')"></i></div></div>`; [cite: 160]
        });
    }

    function showDeleteModal(name) {
        deleteTargetName = name; 
        document.getElementById('deleteStudentName').innerText = name;
        document.getElementById('deleteModal').style.display = 'flex'; [cite: 161]
        document.getElementById('confirmDeleteBtn').onclick = async () => {
            students = students.filter(s => s.name !== deleteTargetName); [cite: 162]
            history = history.filter(h => h.name !== deleteTargetName);
            try {
                const resStudents = await fetch('/api/update-students', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(students) }); [cite: 163, 164]
                const resHistory = await fetch('/api/save-attendance-full', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(history) }); [cite: 165, 166]
                if (resStudents.ok && resHistory.ok) { closeModal(); refreshUI(); showSuccess("تم الحذف بنجاح"); [cite: 167, 168] }
            } catch (e) { showCustomAlert("فشل الاتصال بالسيرفر", "error"); [cite: 169, 170] }
        };
    }

    function openEditModal(name) {
        const s = students.find(x => x.name === name); [cite: 171, 172]
        document.getElementById('editOldName').value = s.name; 
        document.getElementById('displayStudentName').innerText = s.name;
        document.getElementById('editSectionInput').value = s.section; 
        document.getElementById('editPhoneInput').value = s.phone;
        document.getElementById('editModal').style.display = 'flex'; [cite: 173]
    }

    async function submitStudentEdit() {
        const oldN = document.getElementById('editOldName').value; [cite: 174]
        const nSec = document.getElementById('editSectionInput').value.trim();
        const nPh = document.getElementById('editPhoneInput').value.trim();
        students = students.map(s => s.name === oldN ? {...s, section: nSec, phone: nPh} : s); [cite: 175]
        try {
            const res = await fetch('/api/update-students', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(students) }); [cite: 176]
            if(res.ok) { closeModal(); refreshUI(); showSuccess("تم التحديث بنجاح"); [cite: 177] }
        } catch(e) { showCustomAlert("حدث خطأ ما", "error"); }
    }

    async function addNewStudent() {
        const n = document.getElementById('newName').value.trim(); [cite: 178]
        const p = document.getElementById('newPhone').value.trim();
        const g = document.getElementById('newGrade').value.trim();
        const s = document.getElementById('newSection').value.trim(); [cite: 179]
        if(!n || !p || !g || !s) { return showCustomAlert("يرجى إكمال جميع الحقول", "error"); [cite: 180] }
        students.push({name: n, phone: p, grade: g, section: s}); [cite: 181]
        try {
            const res = await fetch('/api/update-students', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(students) }); [cite: 182]
            if(res.ok) { 
                document.getElementById('newName').value = ""; document.getElementById('newPhone').value = ""; [cite: 183, 184]
                refreshUI(); showSuccess("تمت إضافة الطالب بنجاح"); [cite: 185]
            }
        } catch(e) { showCustomAlert("فشل الاتصال", "error"); [cite: 186, 187] }
    }

    function showSuccess(msg) { 
        const successMsgEl = document.getElementById('successMsg');
        if (successMsgEl) successMsgEl.innerText = msg;
        
        const modal = document.getElementById('successModal');
        if (modal) {
            modal.style.display = 'flex';
            // إضافة تأثير اهتزاز خفيف للأيقونة داخل النافذة
            const icon = modal.querySelector('i');
            if (icon) {
                icon.style.transform = 'scale(1.2)';
                setTimeout(() => icon.style.transform = 'scale(1)', 200);
            }
        }
    }

    function closeModal() { 
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); [cite: 189]
    }

    function switchTab(id, el) { 
    const role = sessionStorage.getItem('userRole');
    
    // منع المعلم من الانتقال لقسم الإدارة
    if (id === 'manage-section' && role === 'teacher') {
        showCustomAlert("عذراً، لا تملك صلاحية الدخول لقسم الإدارة", "error");
        return;
    }

    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
    document.getElementById(id).classList.add('active'); 
    el.classList.add('active'); 
}
    function refreshUI() { 
        initGrades(); [cite: 191]
        updateSections('mainGradeSelect','mainSectionSelect'); 
        updateSections('manageGradeSelect','manageSectionSelect'); 
        updateStudents(); 
        renderManagerList(); 
    }

    function toggleReportUI() { 
        document.getElementById('studentSelectDiv').style.display = (document.getElementById('reportMode').value==='student'?'block':'none'); [cite: 192]
    }

    function updateReportStudentList() {
        const g = document.getElementById('repGradeSelect').value; [cite: 193]
        const s = document.getElementById('repSectionSelect').value;
        const sel = document.getElementById('repStudentSelect'); 
        sel.innerHTML = '<option value="">-- اختر الطالب --</option>'; [cite: 194]
        if(!g || !s) return;
        students.filter(x => String(x.grade) === g && String(x.section) === s)
                .sort((a, b) => a.name.localeCompare(b.name, 'ar'))
                .forEach(st => { sel.innerHTML += `<option value="${st.name}">${st.name}</option>`; [cite: 195] });
    }

    function initiatePrint() {
        const printDate = new Date().toLocaleDateString('ar-OM', { year: 'numeric', month: 'long', day: 'numeric' }); [cite: 196]
        document.getElementById('printDateStamp').innerText = printDate;
        window.print();
    }

    async function deleteAttendanceRecord(name, date) {
        showConfirmDialog(`هل أنت متأكد من حذف غياب الطالب (${name}) بتاريخ ${date}؟`, async function() {
            history = history.filter(h => !(h.name === name && h.date === date)); [cite: 197, 198]
            try {
                const res = await fetch('/api/save-attendance-full', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(history) }); [cite: 199]
                if (res.ok) { generateReport(); showSuccess("تم حذف السجل بنجاح"); [cite: 200] }
            } catch (e) { showCustomAlert("فشل الاتصال", "error"); [cite: 201, 202] }
        });
    }

    function showCustomAlert(msg, type = 'info') {
        const modal = document.getElementById('customAlertModal'); [cite: 203]
        const title = document.getElementById('alertTitle');
        const icon = document.getElementById('alertIcon');
        document.getElementById('alertMessage').innerText = msg; [cite: 204]
        if (type === 'error') { title.innerText = "خطأ"; icon.className = "fas fa-times-circle"; icon.style.color = "var(--danger)"; [cite: 205] }
        else { title.innerText = "تنبيه"; icon.className = "fas fa-info-circle"; icon.style.color = "var(--primary)"; [cite: 206] }
        modal.style.display = 'flex'; [cite: 207]
    }

    function closeCustomAlert() { document.getElementById('customAlertModal').style.display = 'none'; [cite: 208] }
    function closeConfirmModal() { document.getElementById('confirmActionModal').style.display = 'none'; [cite: 209] }

    function showConfirmDialog(msg, callback) {
        document.getElementById('confirmMsgContent').innerText = msg; [cite: 210, 211]
        document.getElementById('confirmActionModal').style.display = 'flex';
        document.getElementById('btnConfirmYes').onclick = function() { callback(); closeConfirmModal(); [cite: 212] };
    }

    window.onload = loadData;
    setInterval(updateLiveDateTime, 1000);
</script>
</body>
</html>
