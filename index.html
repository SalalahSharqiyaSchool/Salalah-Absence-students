<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>منصة مدرسة صلالة الشرقية الرقمية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #0f172a; --accent: #d4af37; --success: #10b981;
            --danger: #ef4444; --bg: #f8fafc; --card-bg: #ffffff;
            --nav-h: 75px; --rights-h: 40px;
        }

        body { 
            font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; 
            padding-bottom: calc(var(--nav-h) + var(--rights-h) + 20px); 
            color: var(--primary); overflow-x: hidden;
        }

        .official-header {
            background: var(--primary); color: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 4px solid var(--accent); position: sticky; top: 0; z-index: 2000;
        }
        .school-info h1 { margin: 0; font-size: 1.1rem; font-weight: 900; color: var(--accent); }
        .school-info p { margin: 0; font-size: 0.75rem; opacity: 0.9; }
        .ministry-logo img { height: 55px; filter: brightness(0) invert(1); }

        .container { max-width: 650px; margin: 20px auto; padding: 0 15px; }

        .card { background: var(--card-bg); border-radius: 20px; padding: 22px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .card-title { display: flex; align-items: center; gap: 10px; font-weight: 800; color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        
        label { display: block; font-size: 0.85rem; font-weight: 700; margin-bottom: 8px; color: #64748b; }
        select, input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; font-family: 'Cairo'; margin-bottom: 15px; box-sizing: border-box; font-size: 1rem; }

        .absent-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 15px; background: #fff8e1; border-radius: 12px; 
            margin-bottom: 8px; border-right: 5px solid var(--accent);
        }
        .wa-icon { color: #25d366; font-size: 1.4rem; cursor: pointer; }

        .bottom-nav { 
            position: fixed; bottom: var(--rights-h); left: 0; right: 0; 
            background: white; display: flex; justify-content: space-around; 
            padding: 10px 0; border-top: 1px solid #eee; z-index: 1500;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05); border-top-left-radius: 25px; border-top-right-radius: 25px;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94a3b8; cursor: pointer; font-size: 0.8rem; font-weight: 700; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { color: var(--accent); }

        .footer-rights { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: var(--primary); color: #fff; text-align: center; 
            height: var(--rights-h); line-height: var(--rights-h);
            font-size: 0.75rem; z-index: 1501; border-top: 2px solid var(--accent); 
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border-bottom: 1px solid #f1f5f9; text-align: right; font-size: 0.9rem; }

        .btn { border: none; border-radius: 12px; font-family: 'Cairo'; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 15px; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: var(--accent); }
        .btn-success { background: var(--success); color: white; }

        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media print {
            .bottom-nav, .footer-rights, .official-header, .btn, label, select, input { display: none !important; }
            .card { border: none; box-shadow: none; padding: 0; }
            .section { display: block !important; }
        }
    </style>
</head>
<body>

<header class="official-header">
    <div class="school-info">
        <p>وزارة التربية والتعليم</p>
        <h1>مدرسة صلالة الشرقية (5-9)</h1>
    </div>
    <div class="ministry-logo"><img src="data/logo.jpeg" alt="Logo"></div>
</header>

<div class="container">
    <section id="absent-section" class="section active">
        <div class="card">
            <div class="card-title"><i class="fas fa-user-check"></i> رصد الغياب الجماعي</div>
            <div style="display: flex; gap:10px;">
                <div style="flex:1">
                    <label>الصف</label>
                    <select id="classSelect" onchange="updateStudentDropdown()">
                        <option value="">-- جاري التحميل --</option>
                    </select>
                </div>
                <div style="flex:1"><label>التاريخ</label><input type="date" id="absentDate"></div>
            </div>
            <label>اختر الطالب:</label>
            <select id="studentDropdown" onchange="addStudentToAbsentList()"></select>
            <div id="selectedList" style="margin-top:20px;"></div>
            <button class="btn btn-primary" onclick="saveAttendanceToCloud()"><i class="fas fa-cloud-upload-alt"></i> حفظ الغياب سحابياً</button>
        </div>
    </section>

    <section id="manage-section" class="section">
        <div class="card">
            <div class="card-title"><i class="fas fa-user-plus"></i> إضافة طالب جديد</div>
            <input type="text" id="newName" placeholder="الاسم الرباعي">
            <input type="tel" id="newPhone" placeholder="رقم الهاتف 968">
            <div style="display:flex; gap:10px;">
                <input type="text" id="newGrade" placeholder="الصف (مثال: سادس)">
                <input type="text" id="newSection" placeholder="الشعبة (مثال: 4)">
            </div>
            <button class="btn btn-success" onclick="addNewStudent()">حفظ الطالب</button>
        </div>
        <div class="card">
            <div class="card-title"><i class="fas fa-users-cog"></i> استعراض طلاب الصف</div>
            <select id="filterClass" onchange="renderManagerList()"></select>
            <div id="managerListArea"></div>
        </div>
    </section>

    <section id="report-section" class="section">
        <div class="card">
            <div class="card-title"><i class="fas fa-file-invoice"></i> نظام التقارير والطباعة</div>
            
            <label>نوع التقرير</label>
            <select id="reportMode" onchange="toggleReportMode()">
                <option value="student">غياب طالب محدد (فترة زمنية)</option>
                <option value="day">كشف غياب صف (يوم محدد)</option>
            </select>

            <div id="repStudentDiv">
                <label>اختر الصف أولاً</label>
                <select id="repClassFilter" onchange="updateReportStudentListByClass()">
                    <option value="">-- اختر الصف --</option>
                </select>
                <label>اختر الطالب</label>
                <select id="repStudentSelect">
                    <option value="">-- حدد الصف أولاً --</option>
                </select>
            </div>

            <div id="repClassDiv" style="display:none;">
                <label>اختر الصف</label>
                <select id="repClassSelect"></select>
            </div>

            <div id="dateRangeDiv" style="display: flex; gap: 10px; margin-top: 10px;">
                <div style="flex:1">
                    <label id="dateLabel1">من تاريخ / التاريخ</label>
                    <input type="date" id="repDateStart">
                </div>
                <div style="flex:1" id="repDateEndDiv">
                    <label>إلى تاريخ</label>
                    <input type="date" id="repDateEnd">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="generateReport()"><i class="fas fa-search"></i> عرض التقرير المباشر</button>
            <button class="btn" onclick="window.print()" style="margin-top:10px; background:#e2e8f0;"><i class="fas fa-print"></i> طباعة / حفظ PDF</button>
            
            <div id="reportResult" style="margin-top: 20px;"></div>
        </div>
    </section>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('absent-section', this)"><i class="fas fa-calendar-alt"></i><span>الرصد</span></div>
    <div class="nav-item" onclick="switchTab('manage-section', this)"><i class="fas fa-user-graduate"></i><span>الطلاب</span></div>
    <div class="nav-item" onclick="switchTab('report-section', this)"><i class="fas fa-chart-line"></i><span>التقارير</span></div>
</nav>

<footer class="footer-rights">تنفيذ وتصميم الأستاذ: <b>فيصل العريبي</b> &copy; 2026</footer>

<script>
    let students = []; let history = []; let currentBatch = [];

    async function loadAllData() {
        const v = Date.now();
        try {
            const sRes = await fetch(`student_fone.json?v=${v}`);
            students = await sRes.json();
            const hRes = await fetch(`attendance_history.json?v=${v}`);
            history = await hRes.json();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('absentDate').value = today;
            document.getElementById('repDateStart').value = today;
            document.getElementById('repDateEnd').value = today;
            
            generateClassOptions();
        } catch (e) { console.error("Error Loading Data"); }
    }

    function generateClassOptions() {
        const uniqueClasses = [...new Set(students.map(s => `${s.grade}-${s.section}`))].sort();
        const selectIds = ['classSelect', 'filterClass', 'repClassSelect', 'repClassFilter'];
        selectIds.forEach(id => {
            const el = document.getElementById(id);
            if(!el) return;
            el.innerHTML = (id === 'classSelect' || id === 'repClassFilter') ? '<option value="">-- اختر الصف --</option>' : '';
            uniqueClasses.forEach(cls => {
                const [g, s] = cls.split('-');
                el.innerHTML += `<option value="${cls}">${g} / ${s}</option>`;
            });
        });
    }

    function updateReportStudentListByClass() {
        const selectedCls = document.getElementById('repClassFilter').value;
        const studentSelect = document.getElementById('repStudentSelect');
        studentSelect.innerHTML = '<option value="">-- اختر الطالب --</option>';
        if(!selectedCls) return;
        const [g, s] = selectedCls.split('-');
        students.filter(st => st.grade === g && String(st.section) === s)
                .sort((a,b) => a.name.localeCompare(b.name))
                .forEach(st => {
                    studentSelect.innerHTML += `<option value="${st.name}">${st.name}</option>`;
                });
    }

    function switchTab(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active'); el.classList.add('active');
        if(id === 'manage-section') renderManagerList();
    }

    function updateStudentDropdown() {
        const cls = document.getElementById('classSelect').value;
        if (!cls) return;
        const [g, s] = cls.split('-');
        const drop = document.getElementById('studentDropdown');
        drop.innerHTML = '<option value="">-- اختر الاسم --</option>';
        students.filter(st => st.grade === g && String(st.section) === s).forEach(st => {
            drop.innerHTML += `<option value="${st.name}" data-phone="${st.phone}">${st.name}</option>`;
        });
    }

    function addStudentToAbsentList() {
        const drop = document.getElementById('studentDropdown');
        const name = drop.value;
        const phone = drop.options[drop.selectedIndex].getAttribute('data-phone');
        if(!name || currentBatch.find(x => x.name === name)) return;
        currentBatch.push({ name, phone });
        renderBatch();
        drop.value = "";
    }

    function renderBatch() {
        const area = document.getElementById('selectedList');
        area.innerHTML = '<strong>قائمة الغياب الحالية:</strong>';
        currentBatch.forEach((s, i) => {
            area.innerHTML += `<div class="absent-item">
                <span>${s.name}</span>
                <div style="display:flex; gap:15px; align-items:center;">
                    <i class="fab fa-whatsapp wa-icon" onclick="sendWA('${s.phone}','${s.name}')"></i>
                    <i class="fas fa-trash-alt" style="color:red; cursor:pointer;" onclick="currentBatch.splice(${i},1);renderBatch();"></i>
                </div>
            </div>`;
        });
    }

    function sendWA(p, n) {
        const d = document.getElementById('absentDate').value;
        window.open(`https://wa.me/${p}?text=${encodeURIComponent('مدرسة صلالة الشرقية: نبلغكم بغياب الطالب '+n+' بتاريخ '+d)}`, '_blank');
    }

    async function saveAttendanceToCloud() {
        if(currentBatch.length === 0) return alert("القائمة فارغة");
        const date = document.getElementById('absentDate').value;
        const cls = document.getElementById('classSelect').value;
        const entries = currentBatch.map(b => ({ name: b.name, date, class: cls }));
        const res = await fetch('/api/save-attendance', { method: 'POST', body: JSON.stringify(entries), headers: {'Content-Type': 'application/json'} });
        if(res.ok) { 
            alert("تم الحفظ بنجاح"); 
            currentBatch = []; renderBatch(); await loadAllData();
        }
    }

    async function addNewStudent() {
        const name = document.getElementById('newName').value;
        const phone = document.getElementById('newPhone').value;
        const grade = document.getElementById('newGrade').value;
        const section = document.getElementById('newSection').value;
        if(!name || !phone || !grade || !section) return alert("أكمل البيانات");
        const res = await fetch('/api/update-students', { method: 'POST', body: JSON.stringify([...students, {name, phone, grade, section}]), headers: {'Content-Type':'application/json'} });
        if(res.ok) { alert("تم الحفظ"); document.getElementById('newName').value=""; await loadAllData(); }
    }

    function renderManagerList() {
        const cls = document.getElementById('filterClass').value;
        if(!cls) return;
        const [g, s] = cls.split('-');
        let html = '<table><tr><th>الاسم</th><th>حذف</th></tr>';
        students.filter(st => st.grade === g && String(st.section) === s).forEach(st => {
            const idx = students.findIndex(x => x.name === st.name);
            html += `<tr><td>${st.name}</td><td onclick="deleteStudent(${idx})" style="color:red; cursor:pointer;"><i class="fas fa-trash"></i></td></tr>`;
        });
        document.getElementById('managerListArea').innerHTML = html + '</table>';
    }

    async function deleteStudent(i) {
        if(!confirm("حذف الطالب؟")) return;
        students.splice(i, 1);
        const res = await fetch('/api/update-students', { method: 'POST', body: JSON.stringify(students), headers: {'Content-Type':'application/json'} });
        if(res.ok) renderManagerList();
    }

    function toggleReportMode() {
        const m = document.getElementById('reportMode').value;
        document.getElementById('repStudentDiv').style.display = m === 'student' ? 'block' : 'none';
        document.getElementById('repClassDiv').style.display = m === 'day' ? 'block' : 'none';
        
        // إخفاء تاريخ "إلى" إذا كان البحث ليوم واحد فقط
        document.getElementById('repDateEndDiv').style.display = m === 'day' ? 'none' : 'block';
        document.getElementById('dateLabel1').innerText = m === 'day' ? 'التاريخ المحدد' : 'من تاريخ';
    }

    function generateReport() {
        const m = document.getElementById('reportMode').value;
        const start = document.getElementById('repDateStart').value;
        const end = document.getElementById('repDateEnd').value;
        let res = [];
        let title = "";

        if(m === 'student') {
            const sName = document.getElementById('repStudentSelect').value;
            if(!sName) return alert("اختر الطالب");
            // الفلترة بين تاريخين للطالب
            res = history.filter(h => h.name === sName && h.date >= start && h.date <= end);
            title = `تقرير غياب: ${sName} (من ${start} إلى ${end})`;
        } else {
            const cName = document.getElementById('repClassSelect').value;
            if(!cName) return alert("اختر الصف");
            // الفلترة ليوم واحد للصف
            res = history.filter(h => h.class === cName && h.date === start);
            title = `غياب صف ${cName} بتاريخ ${start}`;
        }

        let html = `<h3>${title}</h3><p><b>إجمالي الأيام: ${res.length}</b></p><table><tr><th>الاسم</th><th>التاريخ</th></tr>`;
        res.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(r => {
            html += `<tr><td>${r.name}</td><td>${r.date}</td></tr>`;
        });
        document.getElementById('reportResult').innerHTML = html + '</table>';
    }

    window.onload = loadAllData;
</script>
</body>
</html>
