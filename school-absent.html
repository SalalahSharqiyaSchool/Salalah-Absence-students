<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>منصة مدرسة صلالة الشرقية الرقمية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { 
            --primary: #0f172a; --accent: #d4af37; --bg: #f8fafc; --card-bg: #ffffff; 
            --success: #10b981; --wa: #25d366; --danger: #ef4444; --edit: #3b82f6; 
        }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; padding-bottom: 160px; color: var(--primary); overflow-x: hidden; }
        .official-header { background: var(--primary); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--accent); position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .school-info h1 { margin: 0; font-size: 1.1rem; color: var(--accent); font-weight: 800; }
        .user-controls { display: flex; align-items: center; gap: 12px; }
        .user-info { display: flex; flex-direction: column; align-items: flex-end; border-right: 2px solid var(--accent); padding-right: 10px; }
        .teacher-name { font-size: 0.85rem; font-weight: 700; }
        .logout-btn { background: rgba(239, 68, 68, 0.1); color: #ff6b6b; border: 1px solid #ef4444; width: 35px; height: 35px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .card { background: var(--card-bg); border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .card-title { display: flex; align-items: center; gap: 10px; font-weight: 800; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        label { display: block; font-weight: 700; margin-bottom: 5px; font-size: 0.9rem; color: #475569; }
        select, input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-family: 'Cairo'; margin-bottom: 15px; box-sizing: border-box; font-size: 1rem; outline: none; }
        .btn { border: none; border-radius: 10px; font-family: 'Cairo'; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: var(--accent); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-wa { background: var(--wa); color: white; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #fff; border-radius: 10px; margin-bottom: 8px; border-right: 5px solid var(--accent); border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 10px; border: 1px solid #cbd5e1; text-align: center; font-size: 0.85rem; }
        th { background: #f8fafc; font-weight: 900; }
        .bottom-nav { position: fixed; bottom: 35px; left: 0; right: 0; background: white; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #eee; z-index: 1200; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94a3b8; cursor: pointer; font-size: 0.8rem; font-weight: 700; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .extra-bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 35px; background: var(--primary); color: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; z-index: 1300; border-top: 1px solid var(--accent); }
        .section { display: none; }
        .section.active { display: block; }
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:3000; padding: 20px; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; }
        
        /* طباعة التقارير الرسمية */
        @media print {
            .no-print, .bottom-nav, .extra-bottom-bar, .official-header, .btn, input, select, label { display: none !important; }
            #printHeader { display: block !important; text-align: center; margin-bottom: 20px; }
            .card { box-shadow: none; border: none; padding: 0; }
            table { width: 100% !important; border: 2px solid #000; }
            th, td { border: 1px solid #000 !important; color: #000; }
        }
    </style>
</head>
<body>
    <header class="official-header no-print">
        <div class="school-info">
            <h1>مدرسة صلالة الشرقية (5-9)</h1>
            <div id="liveClock" style="font-size: 0.7rem; color: var(--accent);"></div>
        </div>
        <div class="user-controls">
            <div class="user-info">
                <span class="teacher-name" id="displayTeacherName">المعلم</span>
                <span id="headerDate"></span>
            </div>
            <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <div class="container">
        <div id="absentSection" class="section active">
            <div class="card">
                <div class="card-title"><i class="fas fa-calendar-check"></i> رصد الغياب اليومي</div>
                <input type="date" id="absentDate">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <select id="mainGradeSelect" onchange="updateSections('mainGradeSelect', 'mainSectionSelect')">
                        <option value="">الصف</option>
                        <option value="الخامس">الخامس</option>
                        <option value="السادس">السادس</option>
                        <option value="السابع">السابع</option>
                        <option value="الثامن">الثامن</option>
                        <option value="التاسع">التاسع</option>
                    </select>
                    <select id="mainSectionSelect" onchange="updateStudents()">
                        <option value="">الشعبة</option>
                    </select>
                </div>
                <select id="studentDropdown" onchange="addToList()">
                    <option value="">-- اختر الطالب الغائب --</option>
                </select>
                <div id="selectedList" style="margin-top: 15px;"></div>
                <button class="btn btn-success" onclick="saveData()" style="margin-top: 15px;"><i class="fas fa-save"></i> حفظ وإرسال الغياب</button>
            </div>
        </div>

        <div id="reportSection" class="section">
            <div class="card">
                <div class="card-title"><i class="fas fa-file-pdf"></i> التقارير والطباعة</div>
                <select id="reportMode" onchange="toggleReportUI()">
                    <option value="class">تقرير غياب صف/شعبة</option>
                    <option value="student">سجل غياب طالب محدد</option>
                </select>
                <div id="classSelectArea" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <select id="repGradeSelect" onchange="updateSections('repGradeSelect', 'repSectionSelect')">
                        <option value="">الصف</option>
                        <option value="الخامس">الخامس</option>
                        <option value="السادس">السادس</option>
                        <option value="السابع">السابع</option>
                        <option value="الثامن">الثامن</option>
                        <option value="التاسع">التاسع</option>
                    </select>
                    <select id="repSectionSelect" onchange="updateReportStudentList()">
                        <option value="">الشعبة</option>
                    </select>
                </div>
                <div id="studentSelectDiv" style="display:none">
                    <select id="repStudentSelect"><option value="">-- اختر الطالب --</option></select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="date" id="repDateStart">
                    <input type="date" id="repDateEnd">
                </div>
                <button class="btn btn-primary" onclick="generateReport()"><i class="fas fa-search"></i> عرض التقرير</button>
                <div id="reportResult" style="margin-top: 20px;"></div>
            </div>
        </div>

        <div id="manageSection" class="section">
            <div class="card">
                <div class="card-title"><i class="fas fa-users-cog"></i> إدارة بيانات الطلاب</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <select id="manageGradeSelect" onchange="updateSections('manageGradeSelect', 'manageSectionSelect')">
                        <option value="">الصف</option>
                        <option value="الخامس">الخامس</option>
                        <option value="السادس">السادس</option>
                        <option value="السابع">السابع</option>
                        <option value="الثامن">الثامن</option>
                        <option value="التاسع">التاسع</option>
                    </select>
                    <select id="manageSectionSelect" onchange="renderManagerList()">
                        <option value="">الشعبة</option>
                    </select>
                </div>
                <div id="managerListArea"></div>
                <hr>
                <div class="card-title"><i class="fas fa-user-plus"></i> إضافة طالب جديد</div>
                <input type="text" id="newName" placeholder="اسم الطالب">
                <input type="tel" id="newPhone" placeholder="رقم ولي الأمر">
                <button class="btn btn-success" onclick="addNewStudent()"><i class="fas fa-plus"></i> إضافة طالب</button>
            </div>
        </div>
    </div>

    <div id="customAlertModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="alertTitle">تنبيه</h3>
            <i id="alertIcon" style="font-size: 3rem; margin: 15px 0;"></i>
            <p id="alertMessage"></p>
            <button class="btn btn-primary" onclick="closeCustomAlert()">موافق</button>
        </div>
    </div>

    <div id="confirmActionModal" class="modal-overlay">
        <div class="modal-content">
            <h3>تأكيد الإجراء</h3>
            <p id="confirmMsgContent"></p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-danger" id="btnConfirmYes">نعم، متأكد</button>
                <button class="btn btn-primary" onclick="closeConfirmModal()">إلغاء</button>
            </div>
        </div>
    </div>
    <nav class="bottom-nav no-print">
        <div class="nav-item active" onclick="switchTab('absentSection', this)"><i class="fas fa-user-check"></i><span>الرصد</span></div>
        <div class="nav-item" onclick="switchTab('reportSection', this)"><i class="fas fa-file-alt"></i><span>التقارير</span></div>
        <div id="adminTab" class="nav-item" onclick="switchTab('manageSection', this)" style="display:none"><i class="fas fa-tools"></i><span>الإدارة</span></div>
    </nav>
    <div class="extra-bottom-bar no-print">منصة مدرسة صلالة الشرقية الرقمية &copy; 2026</div>

    <script>
        let students = []; let history = []; let currentBatch = [];

        function getSecureKey() {
            const obfuscated = "jEhNiAyMHRBZXJjZVN5WVR";
            return atob(obfuscated.split("").reverse().join(""));
        }

        async function loadData() {
            if (sessionStorage.getItem('isLoggedIn') !== 'true') { window.location.href = 'index.html'; return; }
            const role = sessionStorage.getItem('userRole');
            document.getElementById('displayTeacherName').innerText = sessionStorage.getItem('teacherName');
            if(role === 'admin') document.getElementById('adminTab').style.display = 'flex';

            const SEC = getSecureKey();
            try {
                const [resS, resH] = await Promise.all([
                    fetch('/api/get-students', { headers: { 'x-app-secret': SEC } }),
                    fetch('/api/get-history', { headers: { 'x-app-secret': SEC } })
                ]);
                students = await resS.json();
                history = await resH.json();
                document.getElementById('headerDate').innerText = new Date().toLocaleDateString('ar-OM');
                updateReportStudentList();
            } catch(e) { console.error("Load Error"); }
        }

      function updateSections() {
    const gradeSelect = document.getElementById('mainGradeSelect'); 
    const sectionSelect = document.getElementById('mainSectionSelect');
    const selectedGrade = gradeSelect.value; // القيمة المختارة مثل "السابع"

    sectionSelect.innerHTML = '<option value="">-- اختر الشعبة --</option>';

    if (!selectedGrade) return;

    const userRole = sessionStorage.getItem('userRole');
    const userClasses = JSON.parse(sessionStorage.getItem('userClasses') || '[]');

    if (userRole === 'admin') {
        // للمدير: استخراج الشعب من بيانات الطلاب
        const availableSections = [...new Set(students
            .filter(s => s.grade === selectedGrade)
            .map(s => s.section))].sort();

        availableSections.forEach(sec => {
            sectionSelect.innerHTML += `<option value="${sec}">${sec}</option>`;
        });
    } else {
        // للمعلم (مثل أ.عصام): البحث عن الصفوف التي تبدأ بـ "السابع-"
        userClasses.forEach(cls => {
            // التحقق إذا كان النص يحتوي على اسم الصف المختارة (مثلاً السابع)
            if (cls.startsWith(selectedGrade)) {
                // فصل النص عند الشرطة "-" لأخذ الرقم
                // إذا كان النص "السابع-1" فإن parts[1] سيكون "1"
                const parts = cls.split('-'); 
                if (parts.length > 1) {
                    const secNum = parts[1];
                    sectionSelect.innerHTML += `<option value="${secNum}">${secNum}</option>`;
                }
            }
        });
    }
}

        function updateStudents() {
            const g = document.getElementById('mainGradeSelect').value;
            const s = document.getElementById('mainSectionSelect').value;
            const drop = document.getElementById('studentDropdown');
            drop.innerHTML = '<option value="">-- اختر الطالب --</option>';
            students.filter(x => String(x.grade) === g && String(x.section) === s)
                   .sort((a,b) => a.name.localeCompare(b.name, 'ar'))
                   .forEach(st => { drop.innerHTML += `<option value="${st.name}" data-phone="${st.phone}">${st.name}</option>`; });
        }

        function addToList() {
            const d = document.getElementById('studentDropdown');
            if(!d.value || currentBatch.find(x => x.name === d.value)) return;
            currentBatch.push({ name: d.value, phone: d.options[d.selectedIndex].getAttribute('data-phone') });
            renderBatch();
        }

        function renderBatch() {
            const area = document.getElementById('selectedList');
            area.innerHTML = currentBatch.map((s, i) => `
                <div class="item-row">
                    <span>${s.name}</span>
                    <i class="fas fa-minus-circle" style="color:var(--danger); cursor:pointer" onclick="currentBatch.splice(${i},1);renderBatch();"></i>
                </div>`).join('');
        }

        async function saveData() {
            if(!currentBatch.length) return;
            const date = document.getElementById('absentDate').value;
            const g = document.getElementById('mainGradeSelect').value;
            const s = document.getElementById('mainSectionSelect').value;
            const entries = currentBatch.map(b => ({ name: b.name, phone: b.phone, date, class: `${g}-${s}` }));
            
            try {
                const res = await fetch('/api/save-attendance', {
                    method:'POST',
                    headers:{ 'Content-Type':'application/json', 'x-app-secret': getSecureKey() },
                    body:JSON.stringify(entries)
                });
                if(res.ok) { 
                    history.push(...entries); currentBatch = []; renderBatch(); 
                    showCustomAlert("تم رصد الغياب بنجاح", "success"); 
                }
            } catch(e) { showCustomAlert("خطأ في الاتصال بالسيرفر", "error"); }
        }

        function generateReport() {
            const mode = document.getElementById('reportMode').value;
            const start = document.getElementById('repDateStart').value;
            const end = document.getElementById('repDateEnd').value;
            let filtered = history.filter(h => h.date >= start && h.date <= end);
            
            if(mode === 'class') {
                const g = document.getElementById('repGradeSelect').value;
                const s = document.getElementById('repSectionSelect').value;
                filtered = filtered.filter(h => h.class === `${g}-${s}`);
            } else {
                filtered = filtered.filter(h => h.name === document.getElementById('repStudentSelect').value);
            }
            renderReportTable(filtered);
        }

        function renderReportTable(data) {
            const area = document.getElementById('reportResult');
            if(!data.length) { area.innerHTML = "<p>لا توجد سجلات غياب</p>"; return; }
            let html = `<table><tr><th>الاسم</th><th>التاريخ</th><th>الصف</th><th class="no-print">إجراء</th></tr>`;
            data.forEach((x, i) => {
                html += `<tr>
                    <td>${x.name}</td>
                    <td>${x.date}</td>
                    <td>${x.class}</td>
                    <td class="no-print">
                        <button class="btn btn-wa" style="padding:5px; width:auto" onclick="sendWA('${x.phone}', '${x.name}', '${x.date}')"><i class="fab fa-whatsapp"></i></button>
                        <i class="fas fa-trash-alt" style="color:var(--danger); margin-right:10px; cursor:pointer" onclick="deleteHistoryItem(${i})"></i>
                    </td>
                </tr>`;
            });
            area.innerHTML = html + `</table><button class="btn btn-primary no-print" onclick="window.print()" style="margin-top:15px">طباعة التقرير</button>`;
        }

        function sendWA(p, n, d) {
            const msg = `ولي أمر الطالب: ${n}، نود إحاطتكم بأن الطالب مسجل غياب في مدرسة صلالة الشرقية بتاريخ ${d}.`;
            window.open(`https://wa.me/968${p}?text=${encodeURIComponent(msg)}`);
        }

        function switchTab(id, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        }

        function toggleReportUI() {
            const mode = document.getElementById('reportMode').value;
            document.getElementById('studentSelectDiv').style.display = (mode === 'student') ? 'block' : 'none';
            document.getElementById('classSelectArea').style.display = (mode === 'student') ? 'none' : 'grid';
        }

        function updateReportStudentList() {
            const drop = document.getElementById('repStudentSelect');
            drop.innerHTML = '<option value="">-- اختر الطالب --</option>';
            [...new Set(students.map(s => s.name))].sort().forEach(n => {
                drop.innerHTML += `<option value="${n}">${n}</option>`;
            });
        }

        function logout() { sessionStorage.clear(); window.location.href = 'index.html'; }
        function showCustomAlert(msg, type) { document.getElementById('alertMessage').innerText = msg; document.getElementById('customAlertModal').style.display = 'flex'; }
        function closeCustomAlert() { document.getElementById('customAlertModal').style.display = 'none'; }
        function closeConfirmModal() { document.getElementById('confirmActionModal').style.display = 'none'; }

        window.onload = () => {
            loadData();
            document.getElementById('absentDate').valueAsDate = new Date();
            setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('ar-OM'); }, 1000);
        };
    </script>
</body>
</html>
