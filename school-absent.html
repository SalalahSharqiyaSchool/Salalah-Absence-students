<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>منصة مدرسة صلالة الشرقية الرقمية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { 
            --primary: #0f172a; 
            --accent: #d4af37; 
            --bg: #f8fafc; 
            --card-bg: #ffffff; 
            --success: #10b981; 
            --wa: #25d366; 
            --danger: #ef4444; 
            --edit: #3b82f6; 
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding-bottom: 160px; 
            color: var(--primary); 
            overflow-x: hidden;
        }
        
        /* الهيدر المطور */
        .official-header { 
            background: var(--primary); 
            color: white; 
            padding: 12px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 3px solid var(--accent); 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
        }

        .school-info h1 { 
            margin: 0; 
            font-size: clamp(0.75rem, 4vw, 1.1rem); 
            color: var(--accent); 
            font-weight: 800; 
        }
        
        .user-controls { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }

        .user-info { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            border-right: 2px solid var(--accent); 
            padding-right: 10px; 
        }

        .teacher-name { 
            font-size: 0.85rem; 
            font-weight: 700; 
            color: #fff; 
        }

        #headerDate { 
            font-size: 0.7rem; 
            opacity: 0.8; 
        }
        
        .logout-btn { 
            background: rgba(239, 68, 68, 0.1); 
            color: #ff6b6b; 
            border: 1px solid #ef4444; 
            width: 35px; 
            height: 35px; 
            border-radius: 8px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: 0.3s; 
        }

        .logout-btn:hover { 
            background: var(--danger); 
            color: white; 
        }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        
        .card { 
            background: var(--card-bg); 
            border-radius: 15px; 
            padding: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
            border: 1px solid #e2e8f0; 
        }

        .card-title { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-weight: 800; 
            margin-bottom: 15px; 
            border-bottom: 2px solid #f1f5f9; 
            padding-bottom: 10px; 
            color: var(--primary);
        }

        label { display: block; font-weight: 700; margin-bottom: 5px; font-size: 0.9rem; color: #475569; }
        
        select, input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e2e8f0; 
            border-radius: 10px; 
            font-family: 'Cairo'; 
            margin-bottom: 15px; 
            box-sizing: border-box; 
            font-size: 1rem; 
            outline: none;
        }

        select:focus, input:focus { border-color: var(--accent); }

        .btn { 
            border: none; 
            border-radius: 10px; 
            font-family: 'Cairo'; 
            font-weight: 800; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            width: 100%; 
            padding: 12px; 
            transition: 0.2s; 
        }

        .btn-primary { background: var(--primary); color: var(--accent); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-cancel { background: #f1f5f9; color: #475569; }
        
        .modal-overlay { 
            position: fixed; 
            top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.7); 
            display:none; 
            justify-content:center; 
            align-items:center; 
            z-index:3000; 
            padding: 20px; 
        }

        .modal-content { 
            background: white; 
            padding: 25px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 400px; 
            text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
        }
        
        .item-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            background: #fff; 
            border-radius: 10px; 
            margin-bottom: 8px; 
            border-right: 5px solid var(--accent); 
            border: 1px solid #eee; 
        }

        .action-icons { display: flex; gap: 15px; }
        .action-icons i { cursor: pointer; font-size: 1.2rem; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border: 1px solid #cbd5e1; text-align: center; font-size: 0.85rem; }
        th { background: #f8fafc; font-weight: 900; }

        .bottom-nav { 
            position: fixed; 
            bottom: 35px; 
            left: 0; right: 0; 
            background: white; 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            border-top: 1px solid #eee; 
            z-index: 1200; 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05); 
        }

        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: #94a3b8; 
            cursor: pointer; 
            font-size: 0.8rem; 
            font-weight: 700; 
            transition: 0.3s; 
        }

        .nav-item.active { color: var(--primary); }

        .extra-bottom-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; right: 0; 
            height: 35px; 
            background: var(--primary); 
            color: var(--accent); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.75rem; 
            font-weight: 700; 
            z-index: 1300; 
            border-top: 1px solid var(--accent); 
        }

        .section { display: none; }
        .section.active { display: block; }

        /* تنسيقات الطباعة الرسمية */
        #printHeader, .footer-stamp { display: none; }

        @media print {
            .no-print, .bottom-nav, .extra-bottom-bar, .official-header, .btn, input, select, label { display: none !important; }
            #printHeader, .footer-stamp { display: block !important; }
            body { background: white !important; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .container { max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
            .card { border: none !important; box-shadow: none !important; padding: 0 !important; }
            table { width: 100%; border: 2px solid #000 !important; border-collapse: collapse; margin-top: 10px; }
            th { background-color: #f2f2f2 !important; border: 1px solid #000 !important; color: #000 !important; font-weight: bold; }
            td { border: 1px solid #000 !important; color: #000 !important; padding: 8px; }
            .date-cell { white-space: pre-line !important; line-height: 1.6; text-align: right !important; padding-right: 15px !important; }
        }
    </style>
</head>
<body>


   <script>
    // --- 1. المتغيرات والتهيئة ---
    let students = []; 
    let history = []; 
    let currentBatch = []; 
    let deleteTargetName = "";

    // التحقق من تسجيل الدخول
    if (sessionStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'index.html';
    }

    // --- 2. أدوات الأمان والوقت ---
    function logout() {
        sessionStorage.clear();
        window.location.href = 'index.html';
    }

    function updateLiveDateTime() {
        const now = new Date();
        const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
        const dayName = days[now.getDay()];
        const dateStr = now.toLocaleDateString('ar-OM', { day: 'numeric', month: 'long', year: 'numeric' });
        
        const clockEl = document.getElementById('liveClock');
        if(clockEl) clockEl.innerHTML = `${dayName} | ${dateStr}`;
    }
    updateLiveDateTime();

    function getDayName(dateString) {
        const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
        return days[new Date(dateString).getDay()];
    }

    // ⭐ دالة فك التمويه (مفتاح الأمان)
    function getSecureKey() {
        // كلمة السر المموّهة (MySecret@2026!#)
        const obfuscated = "jEhNiAyMHRBZXJjZVN5WVR";
        try {
            return atob(obfuscated.split("").reverse().join(""));
        } catch (e) {
            console.error("خطأ في مفتاح الأمان");
            return null;
        }
    }

    // --- 3. دوال الاتصال بالسيرفر (Load & Sync) ---

    // دالة تحميل البيانات
    async function loadData() {
        const tName = sessionStorage.getItem('teacherName');
        const userRole = sessionStorage.getItem('userRole');

        if(tName && document.getElementById('displayTeacherName')) {
            document.getElementById('displayTeacherName').innerText = tName + (userRole === 'admin' ? ' (مدير)' : '');
        }

        const SECRET_KEY = getSecureKey();
        const queryParams = new URLSearchParams({ role: userRole });

        try {
            // أ- جلب الطلاب
            const response = await fetch(`/api/get-students?${queryParams}`, {
                method: 'GET',
                headers: { 'x-app-secret': SECRET_KEY }
            });
            if (!response.ok) throw new Error("غير مصرح بالدخول");
            students = await response.json();

            // ب- جلب السجل
            const historyResponse = await fetch(`/api/get-history`, {
                method: 'GET',
                headers: { 'x-app-secret': SECRET_KEY }
            });
            if (!historyResponse.ok) throw new Error("فشل تحميل السجل");
            history = await historyResponse.json();
            
            initGrades();
        } catch(e) { 
            console.error("Security Error:", e);
            showCustomAlert("فشل في تحميل البيانات. تأكد من الاتصال والصلاحيات.", "error");
        }
    }

    // --- 4. العمليات الأساسية (Add, Edit, Delete, Save) ---

    // رصد الغياب اليومي
    async function saveData() {
        if(!currentBatch.length) return;
        const date = document.getElementById('absentDate').value;
        const g = document.getElementById('mainGradeSelect').value;
        const s = document.getElementById('mainSectionSelect').value;
        const entries = currentBatch.map(b => ({ name: b.name, date, class: `${g}-${s}` }));
        
        try {
            const res = await fetch('/api/save-attendance', { 
                method:'POST', 
                headers:{
                    'Content-Type':'application/json',
                    'x-app-secret': getSecureKey() // ✅ تم الإصلاح: إضافة المفتاح
                }, 
                body:JSON.stringify(entries) 
            });
            if(res.ok) { 
                history.push(...entries);
                currentBatch = []; 
                renderBatch(); 
                showSuccess("تم الحفظ بنجاح"); 
            } else {
                throw new Error("Unauthorized");
            }
        } catch(e) { 
            showCustomAlert("فشل الحفظ: تأكد من الصلاحيات", "error");
        }
    }

    // إضافة طالب جديد
    async function addNewStudent() {
        const n = document.getElementById('newName').value.trim();
        const p = document.getElementById('newPhone').value.trim();
        const g = document.getElementById('newGrade').value.trim();
        const s = document.getElementById('newSection').value.trim();

        if(!n || !p || !g || !s) return showCustomAlert("يرجى إكمال جميع الحقول", "error");

        const userRole = sessionStorage.getItem('userRole');
        const userClasses = JSON.parse(sessionStorage.getItem('userClasses') || '[]');
        if (userRole !== 'admin') {
            const targetClass = `${g}-${s}`;
            if (!userClasses.includes(targetClass)) {
                return showCustomAlert("ليس لديك صلاحية لإضافة طلاب في هذا الفصل", "error");
            }
        }

        students.push({name: n, phone: p, grade: g, section: s});

        try {
            const res = await fetch('/api/update-students', { 
                method:'POST', 
                headers:{
                    'Content-Type':'application/json',
                    'x-app-secret': getSecureKey() // ✅ تم الإصلاح: إضافة المفتاح
                }, 
                body:JSON.stringify(students) 
            });
            
            if(res.ok) { 
                document.getElementById('newName').value = "";
                document.getElementById('newPhone').value = ""; 
                refreshUI(); 
                showSuccess("تمت إضافة الطالب " + n + " بنجاح");
            } else {
                throw new Error("Save failed");
            }
        } catch(e) { 
            students.pop(); // تراجع في حال الفشل
            showCustomAlert("فشل الاتصال بالسيرفر", "error");
        }
    }

    // تحديث بيانات الطالب
    async function submitStudentEdit() {
        const oldN = document.getElementById('editOldName').value;
        const nSec = document.getElementById('editSectionInput').value.trim();
        const nPh = document.getElementById('editPhoneInput').value.trim();
        
        // نسخة احتياطية للتراجع
        const backupStudents = JSON.parse(JSON.stringify(students));
        
        students = students.map(s => s.name === oldN ? {...s, section: nSec, phone: nPh} : s);

        try {
            const res = await fetch('/api/update-students', { 
                method:'POST', 
                headers:{
                    'Content-Type':'application/json',
                    'x-app-secret': getSecureKey() // ✅ تم الإصلاح: إضافة المفتاح
                }, 
                body:JSON.stringify(students) 
            });
            if(res.ok) { 
                closeModal(); 
                refreshUI(); 
                showSuccess("تم تحديث البيانات بنجاح"); 
            } else {
                throw new Error("Update failed");
            }
        } catch(e) { 
            students = backupStudents; // تراجع
            showCustomAlert("حدث خطأ أثناء التحديث", "error");
        }
    }

    // حذف طالب نهائياً
    function showDeleteModal(name) {
        deleteTargetName = name; 
        document.getElementById('deleteStudentName').innerText = name;
        document.getElementById('deleteModal').style.display = 'flex';
        
        document.getElementById('confirmDeleteBtn').onclick = async () => {
            // النسخ الاحتياطية
            const backupStudents = JSON.parse(JSON.stringify(students));
            const backupHistory = JSON.parse(JSON.stringify(history));

            // الحذف المحلي
            students = students.filter(s => s.name !== deleteTargetName);
            history = history.filter(h => h.name !== deleteTargetName);

            try {
                // 1. تحديث قائمة الطلاب
                const resStudents = await fetch('/api/update-students', { 
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-app-secret': getSecureKey() // ✅ تم الإصلاح
                    }, 
                    body: JSON.stringify(students) 
                });

                // 2. تحديث سجل الغياب
                const resHistory = await fetch('/api/save-attendance-full', { 
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-app-secret': getSecureKey() // ✅ تم الإصلاح
                    }, 
                    body: JSON.stringify(history) 
                });

                if (resStudents.ok && resHistory.ok) { 
                    closeModal();
                    refreshUI(); 
                    showSuccess("تم الحذف بنجاح");
                } else {
                    throw new Error("GitHub Sync Failed");
                }
            } catch (e) { 
                // تراجع عند الخطأ
                students = backupStudents;
                history = backupHistory;
                console.error(e);
                showCustomAlert("فشل الحذف من السيرفر", "error"); 
            }
        };
    }

    // حذف سجل غياب يوم محدد
    async function deleteAttendanceRecord(name, date) {
        showConfirmDialog(`هل أنت متأكد من حذف غياب الطالب (${name}) بتاريخ ${date}؟`, async function() {
            const backupHistory = JSON.parse(JSON.stringify(history));
            history = history.filter(h => !(h.name === name && h.date === date));

            try {
                const res = await fetch('/api/save-attendance-full', { 
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-app-secret': getSecureKey() // ✅ تم الإصلاح: إضافة المفتاح
                    }, 
                    body: JSON.stringify(history) 
                });

                if (res.ok) {
                    generateReport(); 
                    showSuccess("تم حذف السجل بنجاح");
                } else {
                    throw new Error("Server Error");
                }
            } catch (e) {
                history = backupHistory; // تراجع
                showCustomAlert("فشل الاتصال بالخادم", "error");
            }
        });
    }

    // --- 5. دوال الواجهة المساعدة (UI Helpers) ---
    
    function initGrades() {
        const userRole = sessionStorage.getItem('userRole');
        const userClasses = JSON.parse(sessionStorage.getItem('userClasses') || '[]');
        
        let filteredStudents = students;
        if (userRole !== 'admin') {
            filteredStudents = students.filter(s => userClasses.includes(`${s.grade}-${s.section}`));
        }

        const grades = [...new Set(filteredStudents.map(s => String(s.grade).trim()).filter(g => g))].sort();
        ['mainGradeSelect', 'repGradeSelect', 'manageGradeSelect'].forEach(id => {
            const el = document.getElementById(id); 
            if(!el) return;
            const currentVal = el.value;
            el.innerHTML = '<option value="">الصف</option>';
            grades.forEach(g => el.innerHTML += `<option value="${g}">${g}</option>`);
            el.value = currentVal;
        });
    }

    function updateSections(gId, sId) {
        const g = document.getElementById(gId).value;
        const sEl = document.getElementById(sId); 
        const currentVal = sEl.value;
        sEl.innerHTML = '<option value="">الشعبة</option>'; 
        if(!g) return;

        const userRole = sessionStorage.getItem('userRole');
        const userClasses = JSON.parse(sessionStorage.getItem('userClasses') || '[]');
        
        let filteredStudents = students.filter(s => String(s.grade) === g);
        if (userRole !== 'admin') {
            filteredStudents = filteredStudents.filter(s => userClasses.includes(`${s.grade}-${s.section}`));
        }

        const sections = [...new Set(filteredStudents.map(s => String(s.section)))].sort();
        sections.forEach(s => sEl.innerHTML += `<option value="${s}">${s}</option>`);
        if (Array.from(sEl.options).some(o => o.value === currentVal)) sEl.value = currentVal;
    }

    function updateStudents() {
        const g = document.getElementById('mainGradeSelect').value;
        const s = document.getElementById('mainSectionSelect').value;
        const drop = document.getElementById('studentDropdown'); 
        drop.innerHTML = '<option value="">-- اختر الطالب --</option>';
        if(!g || !s) return;
        students.filter(x => String(x.grade) === g && String(x.section) === s)
                .sort((a,b)=>a.name.localeCompare(b.name, 'ar'))
                .forEach(st => {
                    drop.innerHTML += `<option value="${st.name}" data-phone="${st.phone}">${st.name}</option>`;
                });
    }

    function addToList() {
        const d = document.getElementById('studentDropdown');
        if(!d.value || currentBatch.find(x => x.name === d.value)) return;
        currentBatch.push({ 
            name: d.value, 
            phone: d.options[d.selectedIndex].getAttribute('data-phone') 
        });
        renderBatch(); 
        d.selectedIndex = 0;
    }

    function renderBatch() {
        const date = document.getElementById('absentDate').value;
        const listArea = document.getElementById('selectedList');
        listArea.innerHTML = currentBatch.map((s, i) => `
            <div class="item-row">
                <span>${s.name}</span>
                <div class="action-icons">
                    <i class="fab fa-whatsapp" style="color:var(--wa)" onclick="sendWA('${s.phone}','${s.name}','${date}')"></i>
                    <i class="fas fa-minus-circle" style="color:var(--danger)" onclick="currentBatch.splice(${i},1);renderBatch();"></i>
                </div>
            </div>`).join('');
    }

    function sendWA(phone, name, date) {
        const day = getDayName(date);
        const text = `مدرسة صلالة الشرقية%0Aغياب الطالب: *${name}*%0Aيوم: *${day}* الموافق: *${date}*`;
        window.open(`https://wa.me/${phone}?text=${text}`, '_blank');
    }

    // --- التقارير ---
    function generateReport() {
        const mode = document.getElementById('reportMode').value;
        const start = document.getElementById('repDateStart').value;
        const end = document.getElementById('repDateEnd').value;
        const resDiv = document.getElementById('reportResult');
        let html = ""; 
        let infoPrint = "";

        if (!start || !end) return showCustomAlert("يرجى تحديد التاريخ", "error");

        if (mode === 'student') {
            const name = document.getElementById('repStudentSelect').value;
            const g = document.getElementById('repGradeSelect').value;
            const s = document.getElementById('repSectionSelect').value;
            if (!name) return showCustomAlert("يرجى اختيار الطالب", "error");

            const data = history.filter(h => h.name === name && h.date >= start && h.date <= end);
            document.getElementById('dynamicTitlePrint').innerText = "تقرير غياب طالب رسمي";
            infoPrint = `<b>اسم الطالب:</b> ${name} <br> <b>الصف:</b> ${g} / <b>الشعبة:</b> ${s} <br> <b>الفترة:</b> من ${start} إلى ${end}`;
            
            html = `<h3>تقرير: ${name}</h3>
                    <table>
                        <thead>
                            <tr><th>م</th><th>اليوم</th><th>التاريخ</th><th class="no-print">إجراءات</th></tr>
                        </thead>
                        <tbody>
                            ${data.map((r, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${getDayName(r.date)}</td>
                                    <td>${r.date}</td>
                                    <td class="no-print">
                                        <i class="fas fa-trash-alt" style="color:var(--danger); cursor:pointer;" 
                                           title="حذف" onclick="deleteAttendanceRecord('${r.name}', '${r.date}')"></i>
                                    </td>
                                </tr>`).join('')}
                        </tbody>
                    </table>`;
            if (data.length === 0) html += '<p style="text-align:center;">لا توجد غيابات.</p>';

        } else {
            const g = document.getElementById('repGradeSelect').value;
            const s = document.getElementById('repSectionSelect').value;
            if (!g || !s) return showCustomAlert("يرجى اختيار الصف", "error");

            const cData = history.filter(h => h.class === `${g}-${s}` && h.date >= start && h.date <= end);
            const log = {};
            document.getElementById('dynamicTitlePrint').innerText = "كشف غياب الصف المجمع";
            infoPrint = `<b>كشف غياب الصف:</b> ${g} / <b>الشعبة:</b> ${s} <br> <b>الفترة:</b> من ${start} إلى ${end}`;
            
            students.filter(st => String(st.grade) === g && String(st.section) === s).forEach(st => {
                const dates = cData.filter(d => d.name === st.name).map(d => `${getDayName(d.date)} (${d.date})`);
                if (dates.length > 0) log[st.name] = dates;
            });
            
            html = `<h3>كشف (${g}/${s})</h3>
                    <table>
                        <tr><th>الاسم</th><th style="width:70%">أيام الغياب</th><th>الإجمالي</th></tr>
                        ${Object.keys(log).sort().map(n => `
                            <tr><td>${n}</td><td class="date-cell">${log[n].join('\n')}</td><td>${log[n].length}</td></tr>
                        `).join('')}
                    </table>`;
            if (Object.keys(log).length === 0) html += '<p style="text-align:center;">لا توجد غيابات.</p>';
        }
        
        resDiv.innerHTML = html;
        document.getElementById('printStudentInfo').innerHTML = infoPrint;
        document.getElementById('printBtn').style.display = 'block';
    }

    function toggleReportUI() { 
        document.getElementById('studentSelectDiv').style.display = (document.getElementById('reportMode').value==='student'?'block':'none');
    }

    function updateReportStudentList() {
        const g = document.getElementById('repGradeSelect').value;
        const s = document.getElementById('repSectionSelect').value;
        const sel = document.getElementById('repStudentSelect'); 
        sel.innerHTML = '<option value="">-- اختر الطالب --</option>';
        if(!g || !s) return;
        students.filter(x => String(x.grade) === g && String(x.section) === s)
                .sort((a, b) => a.name.localeCompare(b.name, 'ar'))
                .forEach(st => {
                    sel.innerHTML += `<option value="${st.name}">${st.name}</option>`;
                });
    }

    function initiatePrint() {
        document.getElementById('printDateStamp').innerText = new Date().toLocaleDateString('ar-OM');
        window.print();
    }

    // --- إدارة القوائم ---
    function renderManagerList() {
        const g = document.getElementById('manageGradeSelect').value;
        const s = document.getElementById('manageSectionSelect').value;
        const area = document.getElementById('managerListArea'); 
        area.innerHTML = ''; 
        if(!g || !s) return;
        const filtered = students.filter(st => String(st.grade) === g && String(st.section) === s);
        if(!filtered.length) { area.innerHTML = '<p>لا يوجد طلاب</p>'; return; }
        filtered.forEach(st => {
            area.innerHTML += `
                <div class="item-row">
                    <span>${st.name}</span>
                    <div class="action-icons">
                        <i class="fas fa-edit" style="color:var(--edit)" onclick="openEditModal('${st.name}')"></i>
                        <i class="fas fa-trash-alt" style="color:var(--danger)" onclick="showDeleteModal('${st.name}')"></i>
                    </div>
                </div>`;
        });
    }

    function openEditModal(name) {
        const s = students.find(x => x.name === name);
        document.getElementById('editOldName').value = s.name; 
        document.getElementById('displayStudentName').innerText = s.name;
        document.getElementById('editSectionInput').value = s.section; 
        document.getElementById('editPhoneInput').value = s.phone;
        document.getElementById('editModal').style.display = 'flex';
    }

    // --- النوافذ المنبثقة ---
    function showSuccess(msg) { 
        document.getElementById('successMsg').innerText = msg;
        document.getElementById('successModal').style.display = 'flex'; 
    }
    function closeModal() { 
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
    }
    function switchTab(id, el) { 
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        el.classList.add('active'); 
    }
    function refreshUI() { 
        initGrades();
        updateSections('mainGradeSelect','mainSectionSelect'); 
        updateSections('manageGradeSelect','manageSectionSelect'); 
        updateStudents(); 
        renderManagerList(); 
    }
    function showCustomAlert(msg, type = 'info') {
        const modal = document.getElementById('customAlertModal');
        const title = document.getElementById('alertTitle');
        const icon = document.getElementById('alertIcon');
        document.getElementById('alertMessage').innerText = msg;
        if (type === 'error') {
            title.innerText = "خطأ";
            icon.className = "fas fa-times-circle";
            icon.style.color = "var(--danger)";
        } else {
            title.innerText = "تنبيه";
            icon.className = "fas fa-info-circle";
            icon.style.color = "var(--primary)";
        }
        modal.style.display = 'flex';
    }
    function closeCustomAlert() {
        document.getElementById('customAlertModal').style.display = 'none';
    }
    function showConfirmDialog(msg, callback) {
        document.getElementById('confirmMsgContent').innerText = msg;
        document.getElementById('confirmActionModal').style.display = 'flex';
        document.getElementById('btnConfirmYes').onclick = function() {
            callback();
            closeConfirmModal();
        };
    }
    function closeConfirmModal() {
        document.getElementById('confirmActionModal').style.display = 'none';
    }

    // التشغيل
    window.onload = loadData;

</script>
</body>
</html>
