<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>منصة مدرسة صلالة الشرقية - رصد الغياب</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { 
            --primary: #0f172a;
            --accent: #d4af37; 
            --bg: #f8fafc; 
            --card-bg: #ffffff; 
            --success: #10b981; 
            --wa: #25d366; 
            --danger: #ef4444; 
            --edit: #3b82f6;
        }

        body { 
            font-family: 'Cairo', sans-serif;
            background: var(--bg); 
            margin: 0; 
            padding-bottom: 160px; 
            color: var(--primary); 
            overflow-x: hidden;
        }
        
        /* الهيدر المطور */
        .official-header { 
            background: var(--primary);
            color: white; 
            padding: 12px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 3px solid var(--accent); 
            position: sticky; 
            top: 0;
            z-index: 1000; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
        }

        .school-info h1 { 
            margin: 0;
            font-size: clamp(0.75rem, 4vw, 1.1rem); 
            color: var(--accent); 
            font-weight: 800; 
        }
        
        .user-controls { 
            display: flex;
            align-items: center; 
            gap: 12px; 
        }

        .user-info { 
            display: flex;
            flex-direction: column; 
            align-items: flex-end; 
            border-right: 2px solid var(--accent); 
            padding-right: 10px;
        }

        .teacher-name { 
            font-size: 0.85rem;
            font-weight: 700; 
            color: #fff; 
        }

        #headerDate { 
            font-size: 0.7rem;
            opacity: 0.8; 
        }
        
        .logout-btn { 
            background: rgba(239, 68, 68, 0.1);
            color: #ff6b6b; 
            border: 1px solid #ef4444; 
            width: 35px; 
            height: 35px; 
            border-radius: 8px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: 0.3s; 
        }

        .logout-btn:hover { 
            background: var(--danger);
            color: white; 
        }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        
        .card { 
            background: var(--card-bg);
            border-radius: 15px; 
            padding: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
            border: 1px solid #e2e8f0;
        }

        .card-title { 
            display: flex;
            align-items: center; 
            gap: 10px; 
            font-weight: 800; 
            margin-bottom: 15px; 
            border-bottom: 2px solid #f1f5f9; 
            padding-bottom: 10px; 
            color: var(--primary);
        }

        label { display: block; font-weight: 700; margin-bottom: 5px; font-size: 0.9rem; color: #475569; }
        
        select, input { 
            width: 100%;
            padding: 12px; 
            border: 2px solid #e2e8f0; 
            border-radius: 10px; 
            font-family: 'Cairo'; 
            margin-bottom: 15px; 
            box-sizing: border-box; 
            font-size: 1rem; 
            outline: none;
        }

        select:focus, input:focus { border-color: var(--accent); }

        .btn { 
            border: none;
            border-radius: 10px; 
            font-family: 'Cairo'; 
            font-weight: 800; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            width: 100%; 
            padding: 12px;
            transition: 0.2s; 
        }

        .btn-primary { background: var(--primary); color: var(--accent); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-cancel { background: #f1f5f9; color: #475569; }
        
        .modal-overlay { 
            position: fixed;
            top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.7); 
            display:none; 
            justify-content:center; 
            align-items:center; 
            z-index:3000; 
            padding: 20px;
        }

        .modal-content { 
            background: white;
            padding: 25px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 400px; 
            text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        
        .item-row { 
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            background: #fff; 
            border-radius: 10px; 
            margin-bottom: 8px; 
            border-right: 5px solid var(--accent); 
            border: 1px solid #eee;
        }

        .action-icons { display: flex; gap: 15px; }
        .action-icons i { cursor: pointer; font-size: 1.2rem; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border: 1px solid #cbd5e1; text-align: center; font-size: 0.85rem; }
        th { background: #f8fafc; font-weight: 900; }

        .bottom-nav { 
            position: fixed;
            bottom: 35px; 
            left: 0; right: 0; 
            background: white; 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            border-top: 1px solid #eee;
            z-index: 1200; 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05); 
        }

        .nav-item { 
            display: flex;
            flex-direction: column; 
            align-items: center; 
            color: #94a3b8; 
            cursor: pointer; 
            font-size: 0.8rem; 
            font-weight: 700; 
            transition: 0.3s;
        }

        .nav-item.active { color: var(--primary); }

        .extra-bottom-bar { 
            position: fixed;
            bottom: 0; 
            left: 0; right: 0; 
            height: 35px; 
            background: var(--primary); 
            color: var(--accent); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.75rem;
            font-weight: 700; 
            z-index: 1300; 
            border-top: 1px solid var(--accent); 
        }

        .section { display: none; }
        .section.active { display: block; }

        /* تنسيقات الطباعة الرسمية */
        #printHeader, .footer-stamp { display: none; }

        @media print {
            .no-print, .bottom-nav, .extra-bottom-bar, .official-header, .btn, input, select, label { display: none !important; }
            #printHeader, .footer-stamp { display: block !important; }
            body { background: white !important; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .container { max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
            .card { border: none !important; box-shadow: none !important; padding: 0 !important; }
            table { width: 100%; border: 2px solid #000 !important; border-collapse: collapse; margin-top: 10px; }
            th { background-color: #f2f2f2 !important; border: 1px solid #000 !important; color: #000 !important; font-weight: bold; }
            td { border: 1px solid #000 !important; color: #000 !important; padding: 8px; }
            .date-cell { white-space: pre-line !important; line-height: 1.6; text-align: right !important; padding-right: 15px !important; }
        }
    </style>
</head>
<body>

    <header class="official-header">
        <div class="school-info">
            <h1>مدرسة صلالة الشرقية (5-9)</h1>
        </div>
        <div class="user-controls">
            <div class="user-info">
                <span class="teacher-name" id="displayTeacherName">زائر</span>
                <span id="liveClock">--:--</span>
            </div>
            <div class="logout-btn" onclick="logout()" title="تسجيل خروج">
                <i class="fas fa-power-off"></i>
            </div>
        </div>
    </header>

    <div id="printHeader">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:20px;">
            <div style="text-align:right;">
                <div>سلطنة عمان</div>
                <div>وزارة التربية والتعليم</div>
                <div>مدرسة صلالة الشرقية للتعليم الأساسي</div>
            </div>
            <img src="data/logo.jpeg" style="width:80px; height:80px;" alt="شعار">
            <div style="text-align:left;">
                <h2 id="dynamicTitlePrint" style="margin:0;">تقرير غياب</h2>
                <div id="printDateStamp" style="font-size:0.9rem; margin-top:5px;"></div>
            </div>
        </div>
        <div id="printStudentInfo" style="margin-bottom:20px; font-size:1rem; border:1px solid #000; padding:10px;"></div>
    </div>

    <div class="container">
        
        <div id="recordSection" class="section active">
            <div class="card">
                <div class="card-title"><i class="fas fa-calendar-check"></i> رصد الغياب اليومي</div>
                
                <label>تاريخ اليوم:</label>
                <input type="date" id="absentDate">

                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label>الصف:</label>
                        <select id="mainGradeSelect" onchange="updateSections('mainGradeSelect','mainSectionSelect')"></select>
                    </div>
                    <div style="flex:1">
                        <label>الشعبة:</label>
                        <select id="mainSectionSelect" onchange="updateStudents()"></select>
                    </div>
                </div>

                <label>اختر الطالب:</label>
                <div style="display:flex; gap:10px;">
                    <select id="studentDropdown"></select>
                    <button class="btn btn-primary" style="width:auto;" onclick="addToList()"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="card" id="listCard">
                <div class="card-title"><i class="fas fa-clipboard-list"></i> قائمة الغياب المرصودة</div>
                <div id="selectedList">
                    </div>
                <button class="btn btn-success" onclick="saveData()" style="margin-top:20px;">
                    <i class="fas fa-save"></i> حفظ الغياب في النظام
                </button>
            </div>
        </div>

        <div id="reportSection" class="section">
            <div class="card">
                <div class="card-title"><i class="fas fa-chart-bar"></i> استخراج التقارير</div>
                
                <label>نوع التقرير:</label>
                <select id="reportMode" onchange="toggleReportUI()">
                    <option value="class">كشف غياب صف كامل</option>
                    <option value="student">تقرير طالب مفرد</option>
                </select>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label>من:</label>
                        <input type="date" id="repDateStart">
                    </div>
                    <div style="flex:1">
                        <label>إلى:</label>
                        <input type="date" id="repDateEnd">
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <select id="repGradeSelect" onchange="updateSections('repGradeSelect','repSectionSelect')"></select>
                    </div>
                    <div style="flex:1">
                        <select id="repSectionSelect" onchange="updateReportStudentList()"></select>
                    </div>
                </div>

                <div id="studentSelectDiv" style="display:none;">
                    <select id="repStudentSelect"></select>
                </div>

                <button class="btn btn-primary" onclick="generateReport()">
                    <i class="fas fa-search"></i> عرض التقرير
                </button>
            </div>

            <div id="reportResult"></div>
            <button id="printBtn" class="btn btn-primary no-print" onclick="initiatePrint()" style="display:none; margin-top:20px;">
                <i class="fas fa-print"></i> طباعة التقرير
            </button>
        </div>

        <div id="manageSection" class="section">
            <div class="card">
                <div class="card-title"><i class="fas fa-user-plus"></i> إضافة طالب جديد</div>
                <input type="text" id="newName" placeholder="اسم الطالب الثلاثي">
                <input type="tel" id="newPhone" placeholder="رقم هاتف ولي الأمر">
                <div style="display:flex; gap:10px;">
                    <input type="number" id="newGrade" placeholder="الصف (مثال: 5)">
                    <input type="number" id="newSection" placeholder="الشعبة (مثال: 1)">
                </div>
                <button class="btn btn-success" onclick="addNewStudent()">
                    <i class="fas fa-plus-circle"></i> إضافة لقاعدة البيانات
                </button>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-users-cog"></i> تعديل بيانات الطلاب</div>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <select id="manageGradeSelect" onchange="updateSections('manageGradeSelect','manageSectionSelect')"></select>
                    <select id="manageSectionSelect" onchange="renderManagerList()"></select>
                </div>
                <div id="managerListArea"></div>
            </div>
        </div>

    </div>

    <div id="successModal" class="modal-overlay">
        <div class="modal-content">
            <i class="fas fa-check-circle" style="font-size:3rem; color:var(--success); margin-bottom:15px;"></i>
            <h3 id="successMsg">تمت العملية بنجاح!</h3>
            <button class="btn btn-success" onclick="closeModal()">موافق</button>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <h3>تعديل بيانات الطالب</h3>
            <h4 id="displayStudentName" style="color:var(--accent);"></h4>
            <input type="hidden" id="editOldName">
            <label>الشعبة الجديدة:</label>
            <input type="number" id="editSectionInput">
            <label>رقم الهاتف:</label>
            <input type="tel" id="editPhoneInput">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" onclick="submitStudentEdit()">حفظ التعديلات</button>
                <button class="btn btn-cancel" onclick="closeModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="deleteModal" class="modal-overlay">
        <div class="modal-content">
            <i class="fas fa-exclamation-triangle" style="font-size:3rem; color:var(--danger); margin-bottom:15px;"></i>
            <h3>حذف طالب نهائياً</h3>
            <p>هل أنت متأكد من حذف الطالب: <br><b id="deleteStudentName" style="color:var(--danger)"></b>؟</p>
            <p style="font-size:0.8rem; color:#666;">سيتم حذف سجل غيابه بالكامل ولا يمكن التراجع.</p>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-danger" id="confirmDeleteBtn">نعم، حذف نهائي</button>
                <button class="btn btn-cancel" onclick="closeModal()">تراجع</button>
            </div>
        </div>
    </div>

    <div id="customAlertModal" class="modal-overlay" style="z-index: 4000;">
        <div class="modal-content">
            <i id="alertIcon" class="fas fa-info-circle" style="font-size:3rem; margin-bottom:15px;"></i>
            <h3 id="alertTitle">تنبيه</h3>
            <p id="alertMessage"></p>
            <button class="btn btn-primary" onclick="closeCustomAlert()">موافق</button>
        </div>
    </div>

    <div id="confirmActionModal" class="modal-overlay" style="z-index: 3500;">
        <div class="modal-content">
            <i class="fas fa-question-circle" style="font-size:3rem; color:var(--accent); margin-bottom:15px;"></i>
            <p id="confirmMsgContent" style="font-weight:bold;"></p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" id="btnConfirmYes">نعم، متأكد</button>
                <button class="btn btn-cancel" onclick="closeConfirmModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('recordSection', this)">
            <i class="fas fa-edit fa-lg"></i>
            <span>رصد</span>
        </div>
        <div class="nav-item" onclick="switchTab('reportSection', this)">
            <i class="fas fa-file-alt fa-lg"></i>
            <span>التقارير</span>
        </div>
        <div class="nav-item" onclick="switchTab('manageSection', this)">
            <i class="fas fa-users fa-lg"></i>
            <span>إدارة</span>
        </div>
    </nav>

    <div class="extra-bottom-bar">
        تصميم وبرمجة: أ. فيصل العريبي | 2026
    </div>

    <script>
    // --- 1. المتغيرات والتهيئة ---
    let students = [];
    let history = []; 
    let currentBatch = []; 
    let deleteTargetName = "";

    // التحقق من تسجيل الدخول
    if (sessionStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'index.html';
    }

    // --- 2. أدوات الأمان والوقت ---
    function logout() {
        sessionStorage.clear();
        window.location.href = 'index.html';
    }

    function updateLiveDateTime() {
        const now = new Date();
        const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
        const dayName = days[now.getDay()];
        const dateStr = now.toLocaleDateString('ar-OM', { day: 'numeric', month: 'long', year: 'numeric' });
        
        const clockEl = document.getElementById('liveClock');
        if(clockEl) clockEl.innerHTML = `${dayName} | ${dateStr}`;
        
        // تعيين تاريخ اليوم كقيمة افتراضية لحقل التاريخ
        const todayInput = new Date().toISOString().split('T')[0];
        if(document.getElementById('absentDate')) {
            document.getElementById('absentDate').value = todayInput;
        }
    }
    updateLiveDateTime();

    function getDayName(dateString) {
        const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
        return days[new Date(dateString).getDay()];
    }

    // ⭐ دالة مفتاح الأمان (يجب أن تتطابق مع المتوقع في السيرفر)
   // ⭐ دالة مفتاح الأمان (تم تحديثها لتطابق MySecret@2026!#)
    function getSecureKey() {
    const obfuscated = "jI1MjRAMXJ5Y25lU215VFA=";
    return atob(obfuscated.split("").reverse().join(""));
}


    // --- 3. دوال الاتصال بالسيرفر (Load & Sync) ---

    // دالة تحميل البيانات
  async function loadData() {
        const tName = sessionStorage.getItem('teacherName');
        const userRole = sessionStorage.getItem('userRole');

        // تحديث اسم المعلم في الهيدر
        if(tName && document.getElementById('displayTeacherName')) {
            document.getElementById('displayTeacherName').innerText = tName + (userRole === 'admin' ? ' (مدير)' : '');
        }

        // إظهار رسالة جاري التحميل (اختياري)
        console.log("جاري جلب البيانات من السيرفر...");
        
        try {
            // 1. جلب قائمة الطلاب من الـ API الآمن
            // نستخدم ?v= لضمان عدم استرجاع بيانات قديمة من ذاكرة المتصفح (Cache)
            let response = await fetch('/api/get-students?v=' + Date.now()); 
            if (response.ok) {
                students = await response.json();
                console.log("تم تحميل قائمة الطلاب بنجاح");
            } else {
                throw new Error("فشل في الوصول لمسار الطلاب");
            }

            // 2. جلب سجل الغياب من الـ API الآمن
            let historyResponse = await fetch('/api/get-history?v=' + Date.now());
            if (historyResponse.ok) {
                history = await historyResponse.json();
                console.log("تم تحميل سجل الغياب بنجاح");
            } else {
                history = []; // إذا لم يوجد سجل سابق (أول مرة تشغيل)
            }
            
            // 3. تهيئة القوائم المنسدلة بناءً على البيانات المستلمة
            initGrades();
            
        } catch(e) { 
            console.error("خطأ أثناء تحميل البيانات:", e);
            // تنبيه المستخدم في حال وجود خطأ في الاتصال
            if(typeof showCustomAlert === "function") {
                showCustomAlert("فشل الاتصال بقاعدة البيانات. تأكد من إعدادات Vercel", "error");
            }
            initGrades(); // لضمان بقاء الواجهة قابلة للاستخدام
        }
    }
    // --- 4. العمليات الأساسية (Add, Edit, Delete, Save) ---

    // رصد الغياب اليومي (يستخدم save-attendance.js)
    async function saveData() {
        if(!currentBatch.length) return showCustomAlert("لم يتم اختيار أي طالب!", "error");
        
        const date = document.getElementById('absentDate').value;
        if(!date) return showCustomAlert("يرجى اختيار التاريخ", "error");

        const g = document.getElementById('mainGradeSelect').value;
        const s = document.getElementById('mainSectionSelect').value;
        
        // تجهيز البيانات
        const entries = currentBatch.map(b => ({ 
            name: b.name, 
            date: date, 
            class: `${g}-${s}`,
            timestamp: new Date().toISOString()
        }));

        try {
            // إرسال البيانات إلى save-attendance.js
            const res = await fetch('/api/save-attendance', { 
                method:'POST', 
                headers:{
                    'Content-Type':'application/json',
                    'x-app-secret': getSecureKey() // المصادقة
                }, 
                body:JSON.stringify(entries) // إرسال مصفوفة للإضافة (Append)
            });

            if(res.ok) { 
                // تحديث النسخة المحلية
                history.push(...entries);
                currentBatch = []; 
                document.getElementById('selectedList').innerHTML = ''; // تفريغ الواجهة
                showSuccess("تم حفظ الغياب بنجاح"); 
            } else {
                const errData = await res.json();
                throw new Error(errData.error || "Server Error");
            }
        } catch(e) { 
            console.error(e);
            showCustomAlert("فشل الحفظ: " + e.message, "error");
        }
    }

    // إضافة طالب جديد (يستخدم update-students.js)
    async function addNewStudent() {
        const n = document.getElementById('newName').value.trim();
        const p = document.getElementById('newPhone').value.trim();
        const g = document.getElementById('newGrade').value.trim();
        const s = document.getElementById('newSection').value.trim();

        if(!n || !p || !g || !s) return showCustomAlert("يرجى إكمال جميع الحقول", "error");

        // التحقق من الصلاحيات (اختياري حسب منطقك)
        const userRole = sessionStorage.getItem('userRole');
        
        // إضافة للمصفوفة المحلية
        students.push({name: n, phone: p, grade: g, section: s});

        try {
            // إرسال المصفوفة الكاملة للتحديث
            const res = await fetch('/api/update-students', { 
                method:'POST', 
                headers:{
                    'Content-Type':'application/json',
                    'x-app-secret': getSecureKey()
                }, 
                body:JSON.stringify(students) // استبدال كامل
            });

            if(res.ok) { 
                document.getElementById('newName').value = "";
                document.getElementById('newPhone').value = ""; 
                refreshUI(); 
                showSuccess("تمت إضافة الطالب " + n + " بنجاح");
            } else {
                throw new Error("فشل الحفظ في السيرفر");
            }
        } catch(e) { 
            students.pop(); // تراجع في حال الفشل
            showCustomAlert("فشل الاتصال بالسيرفر", "error");
        }
    }

    // تحديث بيانات الطالب (يستخدم update-students.js)
    async function submitStudentEdit() {
        const oldN = document.getElementById('editOldName').value;
        const nSec = document.getElementById('editSectionInput').value.trim();
        const nPh = document.getElementById('editPhoneInput').value.trim();
        
        const backupStudents = JSON.parse(JSON.stringify(students));
        
        // تحديث المصفوفة المحلية
        students = students.map(s => s.name === oldN ? {...s, section: nSec, phone: nPh} : s);

        try {
            const res = await fetch('/api/update-students', { 
                method:'POST', 
                headers:{
                    'Content-Type':'application/json',
                    'x-app-secret': getSecureKey()
                }, 
                body:JSON.stringify(students) // استبدال كامل
            });

            if(res.ok) { 
                closeModal(); 
                refreshUI();
                showSuccess("تم تحديث البيانات بنجاح"); 
            } else {
                throw new Error("Update failed");
            }
        } catch(e) { 
            students = backupStudents; // تراجع
            showCustomAlert("حدث خطأ أثناء التحديث", "error");
        }
    }

    // حذف طالب نهائياً (يتطلب تحديث ملفين)
    function showDeleteModal(name) {
        deleteTargetName = name;
        document.getElementById('deleteStudentName').innerText = name;
        document.getElementById('deleteModal').style.display = 'flex';
        
        document.getElementById('confirmDeleteBtn').onclick = async () => {
            const backupStudents = JSON.parse(JSON.stringify(students));
            const backupHistory = JSON.parse(JSON.stringify(history));

            // الحذف المحلي
            students = students.filter(s => s.name !== deleteTargetName);
            history = history.filter(h => h.name !== deleteTargetName);

            try {
                // 1. تحديث قائمة الطلاب (update-students.js)
                const resStudents = await fetch('/api/update-students', { 
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-app-secret': getSecureKey()
                    }, 
                    body: JSON.stringify(students) 
                });

                // 2. تحديث سجل الغياب (save-attendance-full.js)
                // نستخدم save-attendance-full لأنه يسمح باستبدال الملف بالكامل
                const resHistory = await fetch('/api/save-attendance-full', { 
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-app-secret': getSecureKey()
                    }, 
                    body: JSON.stringify(history) 
                });

                if (resStudents.ok && resHistory.ok) { 
                    closeModal();
                    refreshUI(); 
                    showSuccess("تم الحذف بنجاح");
                } else {
                    throw new Error("GitHub Sync Failed");
                }
            } catch (e) { 
                students = backupStudents;
                history = backupHistory;
                console.error(e);
                showCustomAlert("فشل الحذف من السيرفر", "error"); 
            }
        };
    }

    // حذف سجل غياب يوم محدد (يستخدم save-attendance-full.js)
    async function deleteAttendanceRecord(name, date) {
        showConfirmDialog(`هل أنت متأكد من حذف غياب الطالب (${name}) بتاريخ ${date}؟`, async function() {
            const backupHistory = JSON.parse(JSON.stringify(history));
            
            // الحذف من المصفوفة المحلية
            history = history.filter(h => !(h.name === name && h.date === date));

            try {
                // إرسال السجل الكامل المعدل لاستبدال الملف القديم
                const res = await fetch('/api/save-attendance-full', { 
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-app-secret': getSecureKey()
                    }, 
                    body: JSON.stringify(history) 
                });

                if (res.ok) {
                    generateReport(); // إعادة رسم التقرير
                    showSuccess("تم حذف السجل بنجاح");
                } else {
                    throw new Error("Server Error");
                }
            } catch (e) {
                history = backupHistory; // تراجع
                showCustomAlert("فشل الاتصال بالخادم", "error");
            }
        });
    }

    // --- 5. دوال الواجهة المساعدة (UI Helpers) ---
    
   function initGrades() {
    const userRole = sessionStorage.getItem('userRole');
    const userClassesRaw = sessionStorage.getItem('userClasses');
    const userClasses = userClassesRaw ? JSON.parse(userClassesRaw) : [];

    // سنقوم بتصفية قائمة الطلاب بناءً على صلاحيات المعلم
    let filteredStudents = students;

    if (userRole !== 'admin') {
        filteredStudents = students.filter(s => {
            // دمج الصف والشعبة كما هي في ملفك: "الخامس" + "-" + "1" = "الخامس-1"
            const classKey = `${s.grade}-${s.section}`; 
            return userClasses.includes(classKey);
        });
    }

    // استخراج الصفوف الفريدة (الخامس، السادس...) من القائمة المفلترة
    const grades = [...new Set(filteredStudents.map(s => s.grade))];
    
    // تحديث القوائم المنسدلة في الصفحة
    ['mainGradeSelect', 'repGradeSelect', 'manageGradeSelect'].forEach(id => {
        const el = document.getElementById(id); 
        if(!el) return;
        el.innerHTML = '<option value="">اختر الصف</option>';
        grades.forEach(g => {
            el.innerHTML += `<option value="${g}">${g}</option>`;
        });
    });
}

   function updateSections(gId, sId) {
    const selectedGrade = document.getElementById(gId).value;
    const sEl = document.getElementById(sId);
    const userRole = sessionStorage.getItem('userRole');
    const userClasses = JSON.parse(sessionStorage.getItem('userClasses') || "[]");

    sEl.innerHTML = '<option value="">الشعبة</option>'; 
    if(!selectedGrade) return;

    // جلب الشعب المتوفرة لهذا الصف
    let sections = [...new Set(students.filter(s => s.grade === selectedGrade).map(s => s.section))];

    // إذا كان المستخدم معلماً، نظهر له الشعب المخصصة له فقط في هذا الصف
    if (userRole !== 'admin') {
        sections = sections.filter(sec => {
            const classKey = `${selectedGrade}-${sec}`;
            return userClasses.includes(classKey);
        });
    }

    // ترتيب الشعب تصاعدياً وإضافتها للقائمة
    sections.sort((a, b) => a - b).forEach(s => {
        sEl.innerHTML += `<option value="${s}">${s}</option>`;
    });
}

    function updateStudents() {
        const g = document.getElementById('mainGradeSelect').value;
        const s = document.getElementById('mainSectionSelect').value;
        const drop = document.getElementById('studentDropdown'); 
        drop.innerHTML = '<option value="">-- اختر الطالب --</option>';
        if(!g || !s) return;
        
        students.filter(x => String(x.grade) === g && String(x.section) === s)
                .sort((a,b)=>a.name.localeCompare(b.name, 'ar'))
                .forEach(st => {
                    drop.innerHTML += `<option value="${st.name}" data-phone="${st.phone}">${st.name}</option>`;
                });
    }

    function addToList() {
        const d = document.getElementById('studentDropdown');
        if(!d.value) return;
        
        if(currentBatch.find(x => x.name === d.value)) {
            showCustomAlert("الطالب مضاف بالفعل للقائمة", "info");
            return;
        }

        currentBatch.push({ 
            name: d.value, 
            phone: d.options[d.selectedIndex].getAttribute('data-phone') 
        });
        renderBatch(); 
        d.selectedIndex = 0; // إعادة تعيين القائمة
    }

    function renderBatch() {
        const date = document.getElementById('absentDate').value;
        const listArea = document.getElementById('selectedList');
        
        if(currentBatch.length === 0) {
            listArea.innerHTML = '<p style="text-align:center; color:#999;">لم يتم اختيار طلاب بعد</p>';
            return;
        }

        listArea.innerHTML = currentBatch.map((s, i) => `
            <div class="item-row">
                <span>${s.name}</span>
                <div class="action-icons">
                    <i class="fab fa-whatsapp" style="color:var(--wa)" onclick="sendWA('${s.phone}','${s.name}','${date}')" title="مراسلة ولي الأمر"></i>
                    <i class="fas fa-minus-circle" style="color:var(--danger)" onclick="removeFromBatch(${i})" title="إزالة من القائمة"></i>
                </div>
            </div>`).join('');
    }

    function removeFromBatch(index) {
        currentBatch.splice(index, 1);
        renderBatch();
    }

    function sendWA(phone, name, date) {
        const day = getDayName(date);
        const text = `مدرسة صلالة الشرقية%0Aولي الأمر الفاضل، نفيدكم بغياب الطالب: *${name}*%0Aعن المدرسة يوم: *${day}* الموافق: *${date}*%0Aيرجى توضيح سبب الغياب.`;
        // إزالة الصفر الأول وإضافة مفتاح الدولة 968
        let cleanPhone = phone.replace(/^0+/, ''); 
        if(!cleanPhone.startsWith('968')) cleanPhone = '968' + cleanPhone;
        
        window.open(`https://wa.me/${cleanPhone}?text=${text}`, '_blank');
    }

    // --- التقارير ---
    function generateReport() {
        const mode = document.getElementById('reportMode').value;
        const start = document.getElementById('repDateStart').value;
        const end = document.getElementById('repDateEnd').value;
        const resDiv = document.getElementById('reportResult');
        let html = ""; 
        let infoPrint = "";

        if (!start || !end) return showCustomAlert("يرجى تحديد فترة التاريخ (من - إلى)", "error");

        if (mode === 'student') {
            const name = document.getElementById('repStudentSelect').value;
            const g = document.getElementById('repGradeSelect').value;
            const s = document.getElementById('repSectionSelect').value;
            
            if (!name) return showCustomAlert("يرجى اختيار الطالب", "error");
            
            const data = history.filter(h => h.name === name && h.date >= start && h.date <= end);
            
            document.getElementById('dynamicTitlePrint').innerText = "تقرير غياب طالب";
            infoPrint = `<b>اسم الطالب:</b> ${name} <br> <b>الصف:</b> ${g} / <b>الشعبة:</b> ${s} <br> <b>الفترة:</b> من ${start} إلى ${end}`;
            
            html = `<h3>تقرير: ${name}</h3>
                    <table>
                        <thead>
                            <tr><th>م</th><th>اليوم</th><th>التاريخ</th><th class="no-print">إجراءات</th></tr>
                        </thead>
                        <tbody>
                            ${data.map((r, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${getDayName(r.date)}</td>
                                    <td>${r.date}</td>
                                    <td class="no-print">
                                        <i class="fas fa-trash-alt" style="color:var(--danger); cursor:pointer;" 
                                           title="حذف السجل" onclick="deleteAttendanceRecord('${r.name}', '${r.date}')"></i>
                                    </td>
                                </tr>`).join('')}
                        </tbody>
                    </table>`;
            if (data.length === 0) html += '<p style="text-align:center; padding:10px;">لا توجد غيابات مسجلة في هذه الفترة.</p>';
        
        } else {
            // تقرير الصف
            const g = document.getElementById('repGradeSelect').value;
            const s = document.getElementById('repSectionSelect').value;
            
            if (!g || !s) return showCustomAlert("يرجى اختيار الصف والشعبة", "error");
            
            const cData = history.filter(h => h.class === `${g}-${s}` && h.date >= start && h.date <= end);
            const log = {};
            
            document.getElementById('dynamicTitlePrint').innerText = "كشف غياب صف مجمع";
            infoPrint = `<b>الصف:</b> ${g} / <b>الشعبة:</b> ${s} <br> <b>الفترة:</b> من ${start} إلى ${end}`;
            
            // جلب جميع طلاب الصف (حتى من لم يغب)
            const classStudents = students.filter(st => String(st.grade) === g && String(st.section) === s);
            
            classStudents.forEach(st => {
                const absences = cData.filter(d => d.name === st.name).map(d => `${d.date} (${getDayName(d.date)})`);
                if (absences.length > 0) log[st.name] = absences;
            });
            
            html = `<h3>كشف غياب (${g}/${s})</h3>
                    <table>
                        <tr><th>الاسم</th><th style="width:70%">أيام الغياب</th><th>عدد الأيام</th></tr>
                        ${Object.keys(log).sort().map(n => `
                            <tr>
                                <td>${n}</td>
                                <td class="date-cell">${log[n].join(' ، ')}</td>
                                <td>${log[n].length}</td>
                            </tr>
                        `).join('')}
                    </table>`;
            if (Object.keys(log).length === 0) html += '<p style="text-align:center; padding:10px;">سجل الحضور نظيف 100%، لا توجد غيابات.</p>';
        }
        
        resDiv.innerHTML = html;
        document.getElementById('printStudentInfo').innerHTML = infoPrint;
        document.getElementById('printBtn').style.display = 'block';
    }

    function toggleReportUI() { 
        document.getElementById('studentSelectDiv').style.display = (document.getElementById('reportMode').value==='student'?'block':'none');
    }

    function updateReportStudentList() {
        const g = document.getElementById('repGradeSelect').value;
        const s = document.getElementById('repSectionSelect').value;
        const sel = document.getElementById('repStudentSelect'); 
        sel.innerHTML = '<option value="">-- اختر الطالب --</option>';
        if(!g || !s) return;
        
        students.filter(x => String(x.grade) === g && String(x.section) === s)
                .sort((a, b) => a.name.localeCompare(b.name, 'ar'))
                .forEach(st => {
                    sel.innerHTML += `<option value="${st.name}">${st.name}</option>`;
                });
    }

    function initiatePrint() {
        document.getElementById('printDateStamp').innerText = "تاريخ الطباعة: " + new Date().toLocaleDateString('ar-OM');
        window.print();
    }

    // --- إدارة القوائم ---
    function renderManagerList() {
        const g = document.getElementById('manageGradeSelect').value;
        const s = document.getElementById('manageSectionSelect').value;
        const area = document.getElementById('managerListArea'); 
        area.innerHTML = ''; 
        if(!g || !s) return;
        
        const filtered = students.filter(st => String(st.grade) === g && String(st.section) === s);
        
        if(!filtered.length) { 
            area.innerHTML = '<p style="text-align:center;">لا يوجد طلاب في هذا الفصل</p>'; 
            return;
        }
        
        filtered.forEach(st => {
            area.innerHTML += `
                <div class="item-row">
                    <span>${st.name}</span>
                    <div class="action-icons">
                        <i class="fas fa-edit" style="color:var(--edit)" onclick="openEditModal('${st.name}')"></i>
                        <i class="fas fa-trash-alt" style="color:var(--danger)" onclick="showDeleteModal('${st.name}')"></i>
                    </div>
                </div>`;
        });
    }

    function openEditModal(name) {
        const s = students.find(x => x.name === name);
        if(!s) return;
        document.getElementById('editOldName').value = s.name; 
        document.getElementById('displayStudentName').innerText = s.name;
        document.getElementById('editSectionInput').value = s.section; 
        document.getElementById('editPhoneInput').value = s.phone;
        document.getElementById('editModal').style.display = 'flex';
    }

    // --- النوافذ المنبثقة ---
    function showSuccess(msg) { 
        document.getElementById('successMsg').innerText = msg;
        document.getElementById('successModal').style.display = 'flex'; 
    }
    function closeModal() { 
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
    }
    function switchTab(id, el) { 
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        el.classList.add('active'); 
    }
    function refreshUI() { 
        initGrades();
        updateSections('mainGradeSelect','mainSectionSelect'); 
        updateSections('manageGradeSelect','manageSectionSelect'); 
        updateStudents(); 
        renderManagerList(); 
    }
    function showCustomAlert(msg, type = 'info') {
        const modal = document.getElementById('customAlertModal');
        const title = document.getElementById('alertTitle');
        const icon = document.getElementById('alertIcon');
        document.getElementById('alertMessage').innerText = msg;
        
        if (type === 'error') {
            title.innerText = "خطأ";
            icon.className = "fas fa-times-circle";
            icon.style.color = "var(--danger)";
        } else {
            title.innerText = "تنبيه";
            icon.className = "fas fa-info-circle";
            icon.style.color = "var(--primary)";
        }
        modal.style.display = 'flex';
    }
    function closeCustomAlert() {
        document.getElementById('customAlertModal').style.display = 'none';
    }
    function showConfirmDialog(msg, callback) {
        document.getElementById('confirmMsgContent').innerText = msg;
        document.getElementById('confirmActionModal').style.display = 'flex';
        
        // إزالة الأحداث السابقة لتجنب التكرار
        const yesBtn = document.getElementById('btnConfirmYes');
        const newBtn = yesBtn.cloneNode(true);
        yesBtn.parentNode.replaceChild(newBtn, yesBtn);
        
        newBtn.onclick = function() {
            callback();
            closeConfirmModal();
        };
    }
    function closeConfirmModal() {
        document.getElementById('confirmActionModal').style.display = 'none';
    }

    // بدء التطبيق عند تحميل الصفحة
    window.onload = loadData;
    </script>
</body>
</html>
