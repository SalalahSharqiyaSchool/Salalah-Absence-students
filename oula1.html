<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>منصة مدرسة صلالة الشرقية الرقمية</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { 
            --primary: #0f172a; 
            --accent: #d4af37; 
            --bg: #f8fafc; 
            --card-bg: #ffffff; 
            --success: #10b981; 
            --wa: #25d366; 
            --danger: #ef4444; 
            --edit: #3b82f6; 
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding-bottom: 160px; 
            color: var(--primary); 
            overflow-x: hidden;
        }
        
        /* الهيدر المطور */
        .official-header { 
            background: var(--primary); 
            color: white; 
            padding: 12px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 3px solid var(--accent); 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
        }

        .school-info h1 { 
            margin: 0; 
            font-size: clamp(0.75rem, 4vw, 1.1rem); 
            color: var(--accent); 
            font-weight: 800; 
        }
        
        .user-controls { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }

        .user-info { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            border-right: 2px solid var(--accent); 
            padding-right: 10px; 
        }

        .teacher-name { 
            font-size: 0.85rem; 
            font-weight: 700; 
            color: #fff; 
        }

        #headerDate { 
            font-size: 0.7rem; 
            opacity: 0.8; 
        }
        
        .logout-btn { 
            background: rgba(239, 68, 68, 0.1); 
            color: #ff6b6b; 
            border: 1px solid #ef4444; 
            width: 35px; 
            height: 35px; 
            border-radius: 8px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: 0.3s; 
        }

        .logout-btn:hover { 
            background: var(--danger); 
            color: white; 
        }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        
        .card { 
            background: var(--card-bg); 
            border-radius: 15px; 
            padding: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
            border: 1px solid #e2e8f0; 
        }

        .card-title { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-weight: 800; 
            margin-bottom: 15px; 
            border-bottom: 2px solid #f1f5f9; 
            padding-bottom: 10px; 
            color: var(--primary);
        }

        label { display: block; font-weight: 700; margin-bottom: 5px; font-size: 0.9rem; color: #475569; }
        
        select, input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e2e8f0; 
            border-radius: 10px; 
            font-family: 'Cairo'; 
            margin-bottom: 15px; 
            box-sizing: border-box; 
            font-size: 1rem; 
            outline: none;
        }

        select:focus, input:focus { border-color: var(--accent); }

        .btn { 
            border: none; 
            border-radius: 10px; 
            font-family: 'Cairo'; 
            font-weight: 800; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            width: 100%; 
            padding: 12px; 
            transition: 0.2s; 
        }

        .btn-primary { background: var(--primary); color: var(--accent); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-cancel { background: #f1f5f9; color: #475569; }
        
        .modal-overlay { 
            position: fixed; 
            top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.7); 
            display:none; 
            justify-content:center; 
            align-items:center; 
            z-index:3000; 
            padding: 20px; 
        }

        .modal-content { 
            background: white; 
            padding: 25px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 400px; 
            text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
        }
        
        .item-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            background: #fff; 
            border-radius: 10px; 
            margin-bottom: 8px; 
            border-right: 5px solid var(--accent); 
            border: 1px solid #eee; 
        }

        .action-icons { display: flex; gap: 15px; }
        .action-icons i { cursor: pointer; font-size: 1.2rem; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border: 1px solid #cbd5e1; text-align: center; font-size: 0.85rem; }
        th { background: #f8fafc; font-weight: 900; }

        .bottom-nav { 
            position: fixed; 
            bottom: 35px; 
            left: 0; right: 0; 
            background: white; 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            border-top: 1px solid #eee; 
            z-index: 1200; 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05); 
        }

        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: #94a3b8; 
            cursor: pointer; 
            font-size: 0.8rem; 
            font-weight: 700; 
            transition: 0.3s; 
        }

        .nav-item.active { color: var(--primary); }

        .extra-bottom-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; right: 0; 
            height: 35px; 
            background: var(--primary); 
            color: var(--accent); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.75rem; 
            font-weight: 700; 
            z-index: 1300; 
            border-top: 1px solid var(--accent); 
        }

        .section { display: none; }
        .section.active { display: block; }

        /* تنسيقات الطباعة الرسمية */
        #printHeader, .footer-stamp { display: none; }

        @media print {
            .no-print, .bottom-nav, .extra-bottom-bar, .official-header, .btn, input, select, label { display: none !important; }
            #printHeader, .footer-stamp { display: block !important; }
            body { background: white !important; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .container { max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
            .card { border: none !important; box-shadow: none !important; padding: 0 !important; }
            table { width: 100%; border: 2px solid #000 !important; border-collapse: collapse; margin-top: 10px; }
            th { background-color: #f2f2f2 !important; border: 1px solid #000 !important; color: #000 !important; font-weight: bold; }
            td { border: 1px solid #000 !important; color: #000 !important; padding: 8px; }
            .date-cell { white-space: pre-line !important; line-height: 1.6; text-align: right !important; padding-right: 15px !important; }
        }
    </style>
</head>
<body>

<script>
    if (sessionStorage.getItem('isLoggedIn') !== 'true') {
        window.location.href = 'index.html';
    }
</script>

<div id="printHeader">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 10px;">
        <div style="text-align: right; line-height: 1.4; font-weight: bold; font-size: 0.9rem;">
            <p>سلطنة عمان</p>
            <p>وزارة التربية والتعليم</p>
            <p>المديرية العامة للتربية والتعليم بمحافظة ظفار</p>
            <p>مدرسة صلالة الشرقية للتعليم الأساسي (5-9)</p>
        </div>
        <div class="logo-area">
            <img src="data/logo.jpeg" style="width: 85px;" onerror="this.src='https://via.placeholder.com/85?text=Logo'">
        </div>
    </div>
    <h1 id="dynamicTitlePrint" style="text-align: center; text-decoration: underline; font-size: 1.5rem; font-weight: 900; margin: 15px 0;">تقرير غياب رسمي</h1>
    <div id="printStudentInfo" style="border: 2px solid #000; padding: 12px; background: #f9f9f9; margin-bottom: 15px; line-height: 1.7; font-size: 1rem;"></div>
</div>

<header class="official-header no-print">
    <div class="school-info"><h1>مدرسة صلالة الشرقية</h1></div>
    <div class="user-controls">
        <div class="user-info">
    <div style="display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-user-circle" style="color: var(--accent);"></i>
        <span class="teacher-name" id="displayTeacherName">المعلم</span>
    </div>
    <div id="liveClock" style="font-size: 0.75rem; color: #cbd5e1; font-weight: 600; margin-top: 2px;"></div>
</div>
        <button class="logout-btn" onclick="logout()" title="تسجيل الخروج">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>
</header>

<div class="container">
    <section id="absent-section" class="section active">
        <div class="card no-print">
            <div class="card-title"><i class="fas fa-calendar-check"></i> رصد الغياب اليومي</div>
            <label>التاريخ</label>
            <input type="date" id="absentDate">
            <div style="display: flex; gap:10px;">
                <select id="mainGradeSelect" onchange="updateSections('mainGradeSelect','mainSectionSelect'); updateStudents();"></select>
                <select id="mainSectionSelect" onchange="updateStudents()"></select>
            </div>
            <label>اختيار الطالب</label>
            <select id="studentDropdown" onchange="addToList()"><option value="">-- اختر الصف والشعبة --</option></select>
            <div id="selectedList" style="margin-top:15px;"></div>
            <button class="btn btn-primary" onclick="saveData()"><i class="fas fa-save"></i> حفظ وإرسال السجل</button>
        </div>
    </section>

    <section id="report-section" class="section">
        <div class="card">
            <div class="no-print">
                <div class="card-title"><i class="fas fa-file-invoice"></i> نظام التقارير</div>
                <select id="reportMode" onchange="toggleReportUI()">
                    <option value="student">تقرير طالب محدد</option>
                    <option value="class">كشف غياب الصف المجمع</option>
                </select>
                <div style="display: flex; gap:10px;">
                    <select id="repGradeSelect" onchange="updateSections('repGradeSelect','repSectionSelect'); updateReportStudentList();"></select>
                    <select id="repSectionSelect" onchange="updateReportStudentList()"></select>
                </div>
                <div id="studentSelectDiv"><label>اسم الطالب</label><select id="repStudentSelect"></select></div>
                <div style="display: flex; gap:10px;">
                    <input type="date" id="repDateStart">
                    <input type="date" id="repDateEnd">
                </div>
                <button class="btn btn-primary" onclick="generateReport()">عرض التقرير</button>
            </div>
            
            <div id="reportResult"></div>

            <div class="footer-stamp">
                <div style="display: flex; justify-content: space-between; margin-top: 40px; font-weight: bold; border-top: 2px solid #000; padding-top: 15px;">
                    <p>يعتمد / مدير المدرسة: .........................</p>
                    <p>تاريخ الاستخراج: <span id="printDateStamp"></span></p>
                </div>
            </div>

            <button class="btn btn-primary no-print" id="printBtn" onclick="initiatePrint()" style="display:none; margin-top:15px; width:100%; background: #334155;">
                <i class="fas fa-print"></i> طباعة التقرير الرسمي / PDF
            </button>
        </div>
    </section>

    <section id="manage-section" class="section">
        <div class="card">
            <div class="card-title"><i class="fas fa-user-plus"></i> إضافة طالب جديد</div>
            <input type="text" id="newName" placeholder="الاسم الرباعي">
            <input type="tel" id="newPhone" placeholder="رقم التواصل">
            <div style="display:flex; gap:10px;">
                <input type="text" id="newGrade" placeholder="مثال: الخامس" style="flex:1">
                <input type="text" id="newSection" placeholder="مثال: 1" style="flex:1">
            </div>
            <button class="btn btn-success" onclick="addNewStudent()">إضافة وحفظ</button>
        </div>
        <div class="card">
            <div class="card-title"><i class="fas fa-user-edit"></i> تعديل بيانات الطلاب</div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <select id="manageGradeSelect" onchange="updateSections('manageGradeSelect','manageSectionSelect'); renderManagerList();"></select>
                <select id="manageSectionSelect" onchange="renderManagerList()"></select>
            </div>
            <div id="managerListArea"></div>
        </div>
    </section>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-content" style="text-align: right;">
        <h3>تعديل البيانات</h3>
        <p>الطالب: <b id="displayStudentName"></b></p>
        <input type="hidden" id="editOldName">
        <label>الشعبة الجديدة</label>
        <input type="text" id="editSectionInput">
        <label>رقم الهاتف الجديد</label>
        <input type="tel" id="editPhoneInput">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-success" style="flex:2" onclick="submitStudentEdit()">تحديث</button>
            <button class="btn btn-cancel" style="flex:1" onclick="closeModal()">إلغاء</button>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <i class="fas fa-exclamation-triangle" style="font-size:3rem; color:var(--danger); margin-bottom:15px;"></i>
        <h3>تأكيد الحذف</h3>
        <p>هل تريد حذف الطالب <br><b id="deleteStudentName" style="color:var(--danger)"></b> نهائياً؟</p>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-danger" style="flex:1" id="confirmDeleteBtn">نعم، احذف</button>
            <button class="btn btn-cancel" style="flex:1" onclick="closeModal()">إلغاء</button>
        </div>
    </div>
</div>

<div id="successModal" class="modal-overlay">
    <div class="modal-content">
        <i class="fas fa-check-circle" style="font-size:3.5rem; color:var(--success); margin-bottom:15px;"></i>
        <h3 id="successMsg">تمت العملية بنجاح</h3>
        <button class="btn btn-primary" onclick="closeModal()">موافق</button>
    </div>
</div>

<nav class="bottom-nav no-print">
    <div class="nav-item active" onclick="switchTab('absent-section', this)"><i class="fas fa-edit"></i><span>الرصد</span></div>
    <div class="nav-item" onclick="switchTab('report-section', this)"><i class="fas fa-print"></i><span>التقارير</span></div>
    <div class="nav-item" onclick="switchTab('manage-section', this)"><i class="fas fa-users-cog"></i><span>الإدارة</span></div>
</nav>
<div class="extra-bottom-bar no-print">تصميم وتنفيذ الأستاذ فيصل العريبي © 2026</div>
<div id="customAlertModal" class="modal-overlay">
    <div class="modal-content">
        <i id="alertIcon" class="fas fa-info-circle" style="font-size:3rem; margin-bottom:15px; color:var(--primary);"></i>
        <h3 id="alertTitle" style="margin-bottom:10px;">تنبيه</h3>
        <p id="alertMessage" style="color:#666; font-size:1rem;"></p>
        <button class="btn btn-primary" onclick="closeCustomAlert()" style="margin-top:20px;">حسناً</button>
    </div>
</div>

<div id="confirmActionModal" class="modal-overlay">
    <div class="modal-content">
        <i class="fas fa-trash-alt" style="font-size:3rem; color:var(--danger); margin-bottom:15px;"></i>
        <h3>تأكيد الحذف</h3>
        <p id="confirmMsgContent" style="margin-bottom:20px;">هل أنت متأكد من حذف هذا السجل؟</p>
        <div style="display:flex; gap:10px;">
            <button id="btnConfirmYes" class="btn btn-danger" style="flex:1">نعم، احذف</button>
            <button class="btn btn-cancel" style="flex:1" onclick="closeConfirmModal()">تراجع</button>
        </div>
    </div>
</div>
<script>
    let students = []; 
    let history = []; 
    let currentBatch = []; 
    let deleteTargetName = "";

    function logout() {
        sessionStorage.clear();
        window.location.href = 'index.html';
    }

function updateLiveDateTime() {
    const now = new Date();
    
    // جلب اسم اليوم
    const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
    const dayName = days[now.getDay()];
    
    // تنسيق التاريخ (يوم/شهر/سنة)
    const dateStr = now.toLocaleDateString('ar-OM', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });

    // وضعهم في المكان المخصص بجانب الاسم
    document.getElementById('liveClock').innerHTML = `${dayName} | ${dateStr}`;
}

// تشغيل الدالة فور تحميل الصفحة
updateLiveDateTime();


    
    function getDayName(dateString) {
        const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
        return days[new Date(dateString).getDay()];
    }

    async function loadData() {
        const tName = sessionStorage.getItem('teacherName');
        const userRole = sessionStorage.getItem('userRole');
        
        if(tName && document.getElementById('displayTeacherName')) {
             document.getElementById('displayTeacherName').innerText = tName + (userRole === 'admin' ? ' (مدير)' : '');
        }

        // تم السماح للمعلم بالدخول لقسم الإدارة مع تقييد الصلاحيات داخل القسم نفسه
        const manageNavItem = document.querySelector('.nav-item[onclick*="manage-section"]');
        if (manageNavItem) manageNavItem.style.display = 'flex';

        const v = Date.now();
        try {
            const [sR, hR] = await Promise.all([
                fetch(`student_fone.json?v=${v}`), 
                fetch(`attendance_history.json?v=${v}`)
            ]);
            students = await sR.json(); 
            history = await hR.json();
            
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(i => i.value = today);
            
            if(typeof updateLiveDateTime === 'function') {
                updateLiveDateTime();
            }
            
            initGrades();
        } catch(e) { 
            console.error("Error loading data", e); 
        }
    }

    function initGrades() {
        const userRole = sessionStorage.getItem('userRole');
        const userClasses = JSON.parse(sessionStorage.getItem('userClasses') || '[]');
        
        let filteredStudents = students;
        if (userRole !== 'admin') {
            filteredStudents = students.filter(s => userClasses.includes(`${s.grade}-${s.section}`));
        }

        const grades = [...new Set(filteredStudents.map(s => String(s.grade).trim()).filter(g => g))].sort();
        ['mainGradeSelect', 'repGradeSelect', 'manageGradeSelect'].forEach(id => {
            const el = document.getElementById(id); 
            if(!el) return;
            const currentVal = el.value;
            el.innerHTML = '<option value="">الصف</option>';
            grades.forEach(g => el.innerHTML += `<option value="${g}">${g}</option>`);
            el.value = currentVal;
        });
    }

    function updateSections(gId, sId) {
        const g = document.getElementById(gId).value; 
        const sEl = document.getElementById(sId); 
        const currentVal = sEl.value;
        sEl.innerHTML = '<option value="">ش</option>'; 
        if(!g) return;

        const userRole = sessionStorage.getItem('userRole');
        const userClasses = JSON.parse(sessionStorage.getItem('userClasses') || '[]');
        
        let filteredStudents = students.filter(s => String(s.grade) === g);
        if (userRole !== 'admin') {
            filteredStudents = filteredStudents.filter(s => userClasses.includes(`${s.grade}-${s.section}`));
        }

        const sections = [...new Set(filteredStudents.map(s => String(s.section)))].sort();
        sections.forEach(s => sEl.innerHTML += `<option value="${s}">${s}</option>`);
        if (Array.from(sEl.options).some(o => o.value === currentVal)) sEl.value = currentVal;
    }

    function updateStudents() {
        const g = document.getElementById('mainGradeSelect').value; 
        const s = document.getElementById('mainSectionSelect').value;
        const drop = document.getElementById('studentDropdown'); 
        drop.innerHTML = '<option value="">-- اختر الطالب --</option>';
        if(!g || !s) return;
        students.filter(x => String(x.grade) === g && String(x.section) === s)
                .sort((a,b)=>a.name.localeCompare(b.name, 'ar'))
                .forEach(st => {
                    drop.innerHTML += `<option value="${st.name}" data-phone="${st.phone}">${st.name}</option>`;
                });
    }

    function addToList() {
        const d = document.getElementById('studentDropdown');
        if(!d.value || currentBatch.find(x => x.name === d.value)) return;
        currentBatch.push({ 
            name: d.value, 
            phone: d.options[d.selectedIndex].getAttribute('data-phone') 
        });
        renderBatch(); 
        d.selectedIndex = 0;
    }

    function renderBatch() {
        const date = document.getElementById('absentDate').value;
        const listArea = document.getElementById('selectedList');
        listArea.innerHTML = currentBatch.map((s, i) => `
            <div class="item-row">
                <span>${s.name}</span>
                <div class="action-icons">
                    <i class="fab fa-whatsapp" style="color:var(--wa)" onclick="sendWA('${s.phone}','${s.name}','${date}')"></i>
                    <i class="fas fa-minus-circle" style="color:var(--danger)" onclick="currentBatch.splice(${i},1);renderBatch();"></i>
                </div>
            </div>`).join('');
    }

    function sendWA(phone, name, date) {
        const day = getDayName(date);
        const text = `مدرسة صلالة الشرقية%0Aغياب الطالب: *${name}*%0Aيوم: *${day}* الموافق: *${date}*`;
        window.open(`https://wa.me/${phone}?text=${text}`, '_blank');
    }

    async function saveData() {
        if(!currentBatch.length) return;
        const date = document.getElementById('absentDate').value;
        const g = document.getElementById('mainGradeSelect').value;
        const s = document.getElementById('mainSectionSelect').value;
        const entries = currentBatch.map(b => ({ name: b.name, date, class: `${g}-${s}` }));
        
        try {
            const res = await fetch('/api/save-attendance', { 
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify(entries) 
            });
            if(res.ok) { 
                history.push(...entries); 
                currentBatch = []; 
                renderBatch(); 
                showSuccess("تم الحفظ بنجاح"); 
            }
        } catch(e) { alert("فشل الاتصال بالخادم"); }
    }

 function generateReport() {
        const mode = document.getElementById('reportMode').value;
        const start = document.getElementById('repDateStart').value;
        const end = document.getElementById('repDateEnd').value;
        const resDiv = document.getElementById('reportResult');
        let html = ""; 
        let infoPrint = "";

        // التحقق من المدخلات الأساسية
        if (!start || !end) {
            alert("يرجى تحديد تاريخ البداية والنهاية");
            return;
        }

        if (mode === 'student') {
            // --- وضع تقرير الطالب (مع إمكانية الحذف) ---
            const name = document.getElementById('repStudentSelect').value;
            const g = document.getElementById('repGradeSelect').value;
            const s = document.getElementById('repSectionSelect').value;

            if (!name) {
                alert("يرجى اختيار اسم الطالب");
                return;
            }

            const data = history.filter(h => h.name === name && h.date >= start && h.date <= end);
            
            // تجهيز ترويسة الطباعة
            document.getElementById('dynamicTitlePrint').innerText = "تقرير غياب طالب رسمي";
            infoPrint = `<b>اسم الطالب:</b> ${name} <br> <b>الصف:</b> ${g} / <b>الشعبة:</b> ${s} <br> <b>الفترة:</b> من ${start} إلى ${end}`;
            
            // بناء الجدول مع زر الحذف
            html = `<h3>تقرير: ${name}</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>م</th>
                                <th>اليوم</th>
                                <th>التاريخ</th>
                                <th class="no-print">إجراءات</th> </tr>
                        </thead>
                        <tbody>
                            ${data.map((r, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${getDayName(r.date)}</td>
                                    <td>${r.date}</td>
                                    <td class="no-print">
                                        <i class="fas fa-trash-alt" 
                                           style="color:var(--danger); cursor:pointer;" 
                                           title="حذف سجل الغياب لهذا اليوم"
                                           onclick="deleteAttendanceRecord('${r.name}', '${r.date}')">
                                        </i>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;

            if (data.length === 0) {
                html += '<p style="text-align:center; padding:10px;">لا توجد غيابات مسجلة لهذا الطالب في الفترة المحددة.</p>';
            }

        } else {
            // --- وضع كشف الصف المجمع (للطباعة فقط) ---
            const g = document.getElementById('repGradeSelect').value;
            const s = document.getElementById('repSectionSelect').value;

            if (!g || !s) {
                alert("يرجى اختيار الصف والشعبة");
                return;
            }

            const cData = history.filter(h => h.class === `${g}-${s}` && h.date >= start && h.date <= end);
            const log = {};
            
            document.getElementById('dynamicTitlePrint').innerText = "كشف غياب الصف المجمع";
            infoPrint = `<b>كشف غياب الصف:</b> ${g} / <b>الشعبة:</b> ${s} <br> <b>الفترة:</b> من ${start} إلى ${end}`;

            // تجميع البيانات لكل طالب
            students.filter(st => String(st.grade) === g && String(st.section) === s).forEach(st => {
                const dates = cData.filter(d => d.name === st.name).map(d => `${getDayName(d.date)} (${d.date})`);
                if (dates.length > 0) log[st.name] = dates;
            });

            html = `<h3>كشف (${g}/${s})</h3>
                    <table>
                        <tr><th>الاسم</th><th style="width:70%">أيام الغياب (اليوم والتاريخ)</th><th>الإجمالي</th></tr>
                        ${Object.keys(log).sort().map(n => `
                            <tr>
                                <td>${n}</td>
                                <td class="date-cell">${log[n].join('\n')}</td>
                                <td>${log[n].length}</td>
                            </tr>
                        `).join('')}
                    </table>`;
            
            if (Object.keys(log).length === 0) {
                html += '<p style="text-align:center; padding:10px;">لا توجد غيابات مسجلة لهذا الصف في الفترة المحددة.</p>';
            }
        }
        
        // عرض النتائج
        resDiv.innerHTML = html; 
        document.getElementById('printStudentInfo').innerHTML = infoPrint;
        document.getElementById('printBtn').style.display = 'block';
    }
    function renderManagerList() {
        const g = document.getElementById('manageGradeSelect').value; 
        const s = document.getElementById('manageSectionSelect').value;
        const area = document.getElementById('managerListArea'); 
        area.innerHTML = ''; 
        if(!g || !s) return;
        const filtered = students.filter(st => String(st.grade) === g && String(st.section) === s);
        if(!filtered.length) { area.innerHTML = '<p>لا يوجد طلاب في هذه الشعبة</p>'; return; }
        filtered.forEach(st => {
            area.innerHTML += `
                <div class="item-row">
                    <span>${st.name}</span>
                    <div class="action-icons">
                        <i class="fas fa-edit" style="color:var(--edit)" onclick="openEditModal('${st.name}')"></i>
                        <i class="fas fa-trash-alt" style="color:var(--danger)" onclick="showDeleteModal('${st.name}')"></i>
                    </div>
                </div>`;
        });
    }

 function showDeleteModal(name) {
    deleteTargetName = name; 
    document.getElementById('deleteStudentName').innerText = name;
    document.getElementById('deleteModal').style.display = 'flex';

    document.getElementById('confirmDeleteBtn').onclick = async () => {
        // 1. التعديل المحلي: حذف الطالب وغياباته من ذاكرة المتصفح الحالية
        students = students.filter(s => s.name !== deleteTargetName);
        history = history.filter(h => h.name !== deleteTargetName);

        try {
            // 2. تحديث ملف الطلاب في GitHub (عبر API update-students)
            const resStudents = await fetch('/api/update-students', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(students) 
            });

            // 3. تحديث سجل الغياب بالكامل في GitHub (عبر API save-attendance-full)
            // هذا السطر هو الذي يضمن عدم ظهور الغيابات القديمة مرة أخرى
            const resHistory = await fetch('/api/save-attendance-full', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(history) 
            });

            // التحقق من نجاح العمليتين
            if (resStudents.ok && resHistory.ok) { 
                closeModal(); 
                refreshUI(); // تحديث القوائم في الصفحة
                showSuccess("تم حذف الطالب ومسح جميع سجلات غيابه بنجاح"); 
            } else {
                alert("حدثت مشكلة أثناء التحديث في GitHub");
            }

        } catch (e) { 
            console.error("Error during deletion:", e);
            alert("فشل الاتصال بالسيرفر، يرجى المحاولة لاحقاً"); 
        }
    };
}

    function openEditModal(name) {
        const s = students.find(x => x.name === name);
        document.getElementById('editOldName').value = s.name; 
        document.getElementById('displayStudentName').innerText = s.name;
        document.getElementById('editSectionInput').value = s.section; 
        document.getElementById('editPhoneInput').value = s.phone;
        document.getElementById('editModal').style.display = 'flex';
    }

    async function submitStudentEdit() {
        const oldN = document.getElementById('editOldName').value;
        const nSec = document.getElementById('editSectionInput').value.trim();
        const nPh = document.getElementById('editPhoneInput').value.trim();
        students = students.map(s => s.name === oldN ? {...s, section: nSec, phone: nPh} : s);
        try {
            const res = await fetch('/api/update-students', { 
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify(students) 
            });
            if(res.ok) { closeModal(); refreshUI(); showSuccess("تم تحديث البيانات بنجاح"); }
        } catch(e) { alert("حدث خطأ"); }
    }

    async function addNewStudent() {
    // 1. جلب القيم من الحقول
    const n = document.getElementById('newName').value.trim();
    const p = document.getElementById('newPhone').value.trim();
    const g = document.getElementById('newGrade').value.trim();
    const s = document.getElementById('newSection').value.trim();

    // 2. التحقق من إدخال البيانات
    if(!n || !p || !g || !s) {
        return alert("يرجى إكمال جميع الحقول (الاسم، الهاتف، الصف، الشعبة)");
    }

    // 3. التحقق من الصلاحية (للمعلم فقط)
    const userRole = sessionStorage.getItem('userRole');
    const userClasses = JSON.parse(sessionStorage.getItem('userClasses') || '[]');
    if (userRole !== 'admin') {
        const targetClass = `${g}-${s}`;
        if (!userClasses.includes(targetClass)) {
            return alert("عذراً، ليس لديك صلاحية لإضافة طلاب في هذا الصف/الشعبة. الصفوف المسموحة لك هي: " + userClasses.join(', '));
        }
    }

    // 4. إضافة الطالب للقائمة المحلية
    students.push({name: n, phone: p, grade: g, section: s});

    try {
        // 4. إرسال القائمة المحدثة إلى GitHub
        const res = await fetch('/api/update-students', { 
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify(students) 
        });

        if(res.ok) { 
            // 5. تفريغ الحقول بعد النجاح لتجهيزها لإضافة طالب آخر
            document.getElementById('newName').value = ""; 
            document.getElementById('newPhone').value = ""; 
            // document.getElementById('newGrade').value = ""; // اختياري إذا كنت تضيف طلاب من نفس الصف
            // document.getElementById('newSection').value = ""; 

            refreshUI(); // تحديث القوائم المنسدلة في المنصة فوراً
            showSuccess("تمت إضافة الطالب " + n + " بنجاح"); 
        } else {
            alert("حدث خطأ أثناء الحفظ في GitHub");
        }
    } catch(e) { 
        alert("فشل الاتصال بالسيرفر"); 
    }
}

    function showSuccess(msg) { 
        document.getElementById('successMsg').innerText = msg; 
        document.getElementById('successModal').style.display = 'flex'; 
    }

    function closeModal() { 
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); 
    }

    function switchTab(id, el) { 
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); 
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        el.classList.add('active'); 
    }

    function refreshUI() { 
        initGrades(); 
        updateSections('mainGradeSelect','mainSectionSelect'); 
        updateSections('manageGradeSelect','manageSectionSelect'); 
        updateStudents(); 
        renderManagerList(); 
    }

    function toggleReportUI() { 
        document.getElementById('studentSelectDiv').style.display = (document.getElementById('reportMode').value==='student'?'block':'none'); 
    }

   function updateReportStudentList() {
        const g = document.getElementById('repGradeSelect').value; 
        const s = document.getElementById('repSectionSelect').value;
        const sel = document.getElementById('repStudentSelect'); 
        
        // تفريغ القائمة الحالية
        sel.innerHTML = '<option value="">-- اختر الطالب --</option>';
        
        if(!g || !s) return;

        // تصفية الطلاب بناءً على الصف والشعبة المختارين
        students.filter(x => String(x.grade) === g && String(x.section) === s)
                .sort((a, b) => a.name.localeCompare(b.name, 'ar'))
                .forEach(st => {
                    sel.innerHTML += `<option value="${st.name}">${st.name}</option>`;
                });
    }

    function initiatePrint() {
        // تحديث تاريخ الطباعة في التقرير قبل البدء
        const printDate = new Date().toLocaleDateString('ar-OM', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById('printDateStamp').innerText = printDate;
        window.print();
    }

    // تشغيل تحميل البيانات الأساسية عند تحميل الصفحة
    window.onload = loadData;

async function deleteAttendanceRecord(name, date) {
        // بدلاً من confirm العادية، نستخدم النافذة الجديدة
        showConfirmDialog(`هل أنت متأكد من حذف غياب الطالب (${name}) بتاريخ ${date}؟`, async function() {
            
            // تنفيذ الحذف الفعلي بعد ضغط المستخدم على "نعم"
            history = history.filter(h => !(h.name === name && h.date === date));

            try {
                const res = await fetch('/api/save-attendance-full', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(history) 
                });

                if (res.ok) {
                    generateReport(); // تحديث الجدول
                    // استخدام رسالة النجاح الموجودة لديك أصلاً
                    showSuccess("تم حذف السجل بنجاح");
                } else {
                    showCustomAlert("حدثت مشكلة أثناء الحذف من السيرفر", "error");
                }
            } catch (e) {
                console.error(e);
                showCustomAlert("فشل الاتصال بالخادم", "error");
            }
        });
    }

// --- دوال النوافذ العائمة الجديدة ---

    // دالة لإظهار رسالة تنبيه أو خطأ
    function showCustomAlert(msg, type = 'info') {
        const modal = document.getElementById('customAlertModal');
        const title = document.getElementById('alertTitle');
        const icon = document.getElementById('alertIcon');
        
        document.getElementById('alertMessage').innerText = msg;
        
        // تغيير اللون والأيقونة حسب النوع
        if (type === 'error') {
            title.innerText = "خطأ";
            icon.className = "fas fa-times-circle";
            icon.style.color = "var(--danger)";
        } else {
            title.innerText = "تنبيه";
            icon.className = "fas fa-info-circle";
            icon.style.color = "var(--primary)";
        }
        
        modal.style.display = 'flex';
    }

    function closeCustomAlert() {
        document.getElementById('customAlertModal').style.display = 'none';
    }

    function closeConfirmModal() {
        document.getElementById('confirmActionModal').style.display = 'none';
    }

    // دالة مساعدة لتأكيد الحذف
    let confirmCallback = null; // متغير لتخزين العملية المراد تنفيذها

    function showConfirmDialog(msg, callback) {
        document.getElementById('confirmMsgContent').innerText = msg;
        document.getElementById('confirmActionModal').style.display = 'flex';
        
        // عند الضغط على "نعم"، نفذ الدالة المحفوظة
        document.getElementById('btnConfirmYes').onclick = function() {
            callback();
            closeConfirmModal();
        };
    }
    
</script>
</body>
</html>
