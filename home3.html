<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>منصة مدرسة صلالة الشرقية الرقمية - نظام الإدارة المتكامل</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #0f172a;
            --accent: #d4af37;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --success: #10b981;
            --danger: #ef4444;
            --edit: #3b82f6;
            --text-main: #1e293b;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg);
            margin: 0;
            padding-bottom: 120px;
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* --- الهيدر الاحترافي --- */
        .official-header {
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid var(--accent);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .school-info h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--accent);
            font-weight: 900;
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #teacherDisplay {
            font-size: 0.85rem;
            font-weight: 700;
            background: rgba(212, 175, 55, 0.15);
            padding: 6px 15px;
            border-radius: 25px;
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 7px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo';
            font-weight: bold;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-btn:hover { opacity: 0.8; transform: scale(1.05); }

        /* --- الحاويات والقوالب --- */
        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 15px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: var(--primary);
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 12px;
        }

        /* --- العناصر التفاعلية --- */
        select, input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: 'Cairo';
            margin-bottom: 15px;
            font-size: 1rem;
            transition: 0.3s;
            outline: none;
        }

        select:focus, input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1); }

        .btn {
            border: none;
            border-radius: 12px;
            font-family: 'Cairo';
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 14px;
            transition: 0.3s;
            font-size: 1rem;
        }

        .btn-primary { background: var(--primary); color: var(--accent); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-edit { background: var(--edit); color: white; }

        /* --- قائمة الطلاب المرصودين --- */
        .batch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f1f5f9;
            border-radius: 10px;
            margin-bottom: 8px;
            border-right: 4px solid var(--primary);
        }

        /* --- جدول الإدارة --- */
        .manage-table-container { overflow-x: auto; margin-top: 15px; }
        .m-table { width: 100%; border-collapse: collapse; min-width: 500px; }
        .m-table th, .m-table td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; }
        .m-table th { background: #f8fafc; color: #64748b; font-size: 0.85rem; }
        .action-btns { display: flex; gap: 8px; }
        .btn-sm { width: 35px; height: 35px; border-radius: 8px; padding: 0; }

        /* --- تنسيق الطباعة الرسمي --- */
        #printHeader { display: none; text-align: center; font-family: 'Cairo', serif; }
        .official-box { border: 2px solid #000; padding: 20px; margin: 20px 0; background: #fff; text-align: right; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .report-table th, .report-table td { border: 1px solid #000; padding: 10px; text-align: center; color: #000; }
        .report-table th { background: #f0f0f0 !important; }
        .print-footer { display: none; margin-top: 50px; }

        @media print {
            .no-print, .bottom-nav, .extra-bottom-bar, .official-header { display: none !important; }
            #printHeader, .print-footer { display: block; }
            body { background: white; padding: 0; }
            .container { max-width: 100%; margin: 0; padding: 0; }
            .card { border: none; box-shadow: none; padding: 0; }
            .official-box { border: 1.5px solid #000; }
        }

        /* --- القائمة السفلية --- */
        .bottom-nav {
            position: fixed; bottom: 45px; left: 0; right: 0;
            background: white; display: flex; justify-content: space-around;
            padding: 12px 0; border-top: 1px solid #e2e8f0; z-index: 1200;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #94a3b8; cursor: pointer; font-size: 0.8rem; font-weight: 700; transition: 0.3s;
        }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; }

        .extra-bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: 45px;
            background: var(--primary); color: var(--accent); display: flex;
            align-items: center; justify-content: center; font-weight: 800;
            z-index: 1300; border-top: 2px solid var(--accent); font-size: 0.85rem;
        }

        .section { display: none; }
        .section.active { display: block; }
    </style>
</head>
<body>

<div id="printHeader">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 30px;">
        <div style="line-height: 1.6; font-weight: bold; text-align: right;">
            <p>سلطنة عمان</p>
            <p>وزارة التربية والتعليم</p>
            <p>المديرية العامة للتربية والتعليم بمحافظة ظفار</p>
            <p>مدرسة صلالة الشرقية للتعليم الأساسي (5-9)</p>
        </div>
        <img src="data/logo.jpeg" style="width: 110px;" onerror="this.src='https://via.placeholder.com/110?text=LOGO'">
    </div>
    <h1 id="pTitle" style="text-decoration: underline; margin-top: 30px;">تقرير غياب رسمي</h1>
    <div id="pDetails" class="official-box"></div>
</div>

<header class="official-header no-print">
    <div class="school-info"><h1>صلالة الشرقية (5-9)</h1></div>
    <div class="user-controls">
        <div id="teacherDisplay"><i class="fas fa-user-tie"></i> <span id="tName">..</span></div>
        <button class="logout-btn" onclick="logout()"><i class="fas fa-power-off"></i> خروج</button>
    </div>
</header>

<div class="container">
    <section id="absent-section" class="section active">
        <div class="card no-print">
            <div class="card-title"><i class="fas fa-clipboard-list"></i> رصد الغياب اليومي</div>
            <input type="date" id="absentDate">
            <div style="display: flex; gap:10px;">
                <select id="mGrade" onchange="syncSections('mGrade','mSec'); syncDrop();"></select>
                <select id="mSec" onchange="syncDrop()"></select>
            </div>
            <select id="stDrop" onchange="addToBatch()"><option value="">-- اختر الطالب الغائب --</option></select>
            <div id="batchList" style="margin-top:20px;"></div>
            <button class="btn btn-primary" onclick="finalSave()"><i class="fas fa-cloud-upload-alt"></i> اعتماد وحفظ السجل</button>
        </div>
    </section>

    <section id="report-section" class="section">
        <div class="card">
            <div class="no-print">
                <div class="card-title"><i class="fas fa-file-pdf"></i> مركز استخراج التقارير</div>
                <select id="rMode" onchange="toggleRUI()">
                    <option value="single">تقرير غياب طالب (فردي)</option>
                    <option value="all">كشف غياب الصف (مجمع)</option>
                </select>
                <div style="display: flex; gap:10px;">
                    <select id="rGrade" onchange="syncSections('rGrade','rSec'); syncRDrop();"></select>
                    <select id="rSec" onchange="syncRDrop()"></select>
                </div>
                <div id="rStDiv"><select id="rStSelect"></select></div>
                <div style="display: flex; gap:10px;">
                    <input type="date" id="rStart"><input type="date" id="rEnd">
                </div>
                <button class="btn btn-primary" onclick="generateReport()"><i class="fas fa-search"></i> عرض التقرير</button>
            </div>
            
            <div id="rOutput"></div>
            
            <div class="print-footer">
                <div style="border: 1px dashed #000; padding: 10px; margin-bottom: 30px; font-weight: bold;">
                    ⚠️ تنبيه: يعتبر هذا التقرير مستخرجاً من النظام الرقمي للمدرسة، ولا يعتد به رسمياً ما لم يتم ختمه بختم الإدارة.
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <p>يعتمد / مدير المدرسة: .....................</p>
                    <p>تاريخ الطباعة: <span id="pDate"></span></p>
                </div>
            </div>
            <button class="btn btn-primary no-print" id="pBtn" onclick="initiatePrint()" style="display:none; background:#475569; margin-top:20px;">
                <i class="fas fa-print"></i> طباعة التقرير / PDF
            </button>
        </div>
    </section>

    <section id="manage-section" class="section">
        <div class="card no-print">
            <div class="card-title"><i class="fas fa-user-edit"></i> إضافة / تعديل بيانات طالب</div>
            <input type="hidden" id="editId" value="-1">
            <input type="text" id="inName" placeholder="الاسم الكامل للطالب">
            <input type="tel" id="inPhone" placeholder="رقم ولي الأمر">
            <div style="display:flex; gap:10px;">
                <input type="text" id="inGrade" placeholder="الصف (مثلاً: 5)">
                <input type="text" id="inSec" placeholder="الشعبة (مثلاً: 1)">
            </div>
            <button class="btn btn-success" id="btnAction" onclick="saveStudent()"><i class="fas fa-plus"></i> إضافة طالب جديد</button>
        </div>

        <div class="card no-print">
            <div class="card-title"><i class="fas fa-users"></i> قاعدة بيانات الطلاب</div>
            <div class="manage-table-container">
                <table class="m-table">
                    <thead><tr><th>الاسم</th><th>الصف</th><th>العمليات</th></tr></thead>
                    <tbody id="mTableBody"></tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<nav class="bottom-nav no-print">
    <div class="nav-item active" onclick="tab('absent-section', this)"><i class="fas fa-marker"></i><span>الرصد</span></div>
    <div class="nav-item" onclick="tab('report-section', this)"><i class="fas fa-print"></i><span>التقارير</span></div>
    <div class="nav-item" onclick="tab('manage-section', this)"><i class="fas fa-cog"></i><span>الإدارة</span></div>
</nav>

<div class="extra-bottom-bar no-print">تصميم الأستاذ فيصل العريبي © 2026 - نظام مدرسة صلالة الشرقية</div>

<script>
    // --- التحقق من تسجيل الدخول ---
    if (sessionStorage.getItem('isLoggedIn') !== 'true') { window.location.replace("index.html"); }
    
    let students = [], history = [], currentBatch = [];

    // --- تحميل البيانات ---
    async function load() {
        document.getElementById('tName').innerText = `أ. ${sessionStorage.getItem('teacherName') || 'عضو هيئة التدريس'}`;
        try {
            const v = Date.now();
            const [sR, hR] = await Promise.all([fetch(`student_fone.json?v=${v}`), fetch(`attendance_history.json?v=${v}`)]);
            students = await sR.json(); 
            history = await hR.json();
            initFilters();
            renderManage();
        } catch(e) { console.log("Init error"); }
    }

    function logout() { sessionStorage.clear(); window.location.replace("index.html"); }

    // --- وظائف الفلاتر ---
    function initFilters() {
        const grades = [...new Set(students.map(s => String(s.grade).trim()))].sort();
        ['mGrade', 'rGrade'].forEach(id => {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="">الصف</option>';
            grades.forEach(g => el.innerHTML += `<option value="${g}">${g}</option>`);
        });
    }

    function syncSections(gId, sId) {
        const g = document.getElementById(gId).value;
        const sEl = document.getElementById(sId);
        sEl.innerHTML = '<option value="">الشعبة</option>';
        const secs = [...new Set(students.filter(s => String(s.grade) === g).map(s => String(s.section)))].sort();
        secs.forEach(s => sEl.innerHTML += `<option value="${s}">${s}</option>`);
    }

    function syncDrop() {
        const g = document.getElementById('mGrade').value, s = document.getElementById('mSec').value;
        const d = document.getElementById('stDrop');
        d.innerHTML = '<option value="">-- اختر الطالب الغائب --</option>';
        students.filter(x => String(x.grade) === g && String(x.section) === s).forEach(st => {
            d.innerHTML += `<option value="${st.name}">${st.name}</option>`;
        });
    }

    // --- عمليات الرصد ---
    function addToBatch() {
        const d = document.getElementById('stDrop');
        if(!d.value || currentBatch.find(x => x.name === d.value)) return;
        currentBatch.push({ name: d.value });
        renderBatch();
        d.selectedIndex = 0;
    }

    function renderBatch() {
        document.getElementById('batchList').innerHTML = currentBatch.map((s,i) => `
            <div class="batch-item">
                <span><i class="fas fa-user"></i> ${s.name}</span>
                <i class="fas fa-trash" style="color:var(--danger); cursor:pointer;" onclick="currentBatch.splice(${i},1);renderBatch();"></i>
            </div>
        `).join('');
    }

    async function finalSave() {
        if(!currentBatch.length || !document.getElementById('absentDate').value) { alert("يرجى اختيار التاريخ والطلاب"); return; }
        const entries = currentBatch.map(b => ({
            name: b.name,
            date: document.getElementById('absentDate').value,
            class: `${document.getElementById('mGrade').value}-${document.getElementById('mSec').value}`
        }));
        const res = await fetch('/api/save-attendance', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(entries) });
        if(res.ok) { history.push(...entries); currentBatch = []; renderBatch(); alert("تم حفظ السجل بنجاح"); }
    }

    // --- عمليات الإدارة (تعديل/حذف/إضافة) ---
    function renderManage() {
        document.getElementById('mTableBody').innerHTML = students.map((s, i) => `
            <tr>
                <td style="font-weight:600;">${s.name}</td>
                <td>${s.grade} / ${s.section}</td>
                <td class="action-btns">
                    <button class="btn btn-sm btn-edit" onclick="prepEdit(${i})"><i class="fas fa-pen"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="removeSt(${i})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    }

    function prepEdit(i) {
        const s = students[i];
        document.getElementById('inName').value = s.name;
        document.getElementById('inPhone').value = s.phone || '';
        document.getElementById('inGrade').value = s.grade;
        document.getElementById('inSec').value = s.section;
        document.getElementById('editId').value = i;
        document.getElementById('btnAction').innerHTML = `<i class="fas fa-check"></i> تحديث البيانات`;
        document.getElementById('btnAction').className = "btn btn-primary";
    }

    async function removeSt(i) {
        if(confirm("هل تريد بالتأكيد حذف هذا الطالب؟")) {
            students.splice(i, 1);
            await syncDB();
        }
    }

    async function saveStudent() {
        const id = parseInt(document.getElementById('editId').value);
        const obj = {
            name: document.getElementById('inName').value,
            phone: document.getElementById('inPhone').value,
            grade: document.getElementById('inGrade').value,
            section: document.getElementById('inSec').value
        };
        if(!obj.name || !obj.grade) return;
        if(id === -1) students.push(obj); else students[id] = obj;
        await syncDB();
        // Reset
        document.getElementById('editId').value = "-1";
        document.getElementById('btnAction').innerHTML = `<i class="fas fa-plus"></i> إضافة طالب جديد`;
        document.getElementById('btnAction').className = "btn btn-success";
        ['inName','inPhone','inGrade','inSec'].forEach(f => document.getElementById(f).value="");
    }

    async function syncDB() {
        const res = await fetch('/api/save-students', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(students) });
        if(res.ok) { alert("تم تحديث قاعدة البيانات"); renderManage(); initFilters(); }
    }

    // --- عمليات التقارير ---
    function toggleRUI() { document.getElementById('rStDiv').style.display = (document.getElementById('rMode').value==='single'?'block':'none'); }
    function syncRDrop() {
        const g = document.getElementById('rGrade').value, s = document.getElementById('rSec').value;
        const d = document.getElementById('rStSelect'); d.innerHTML = '';
        students.filter(x => String(x.grade) === g && String(x.section) === s).forEach(st => d.innerHTML += `<option value="${st.name}">${st.name}</option>`);
    }

    function generateReport() {
        const mode = document.getElementById('rMode').value, start = document.getElementById('rStart').value, end = document.getElementById('rEnd').value;
        const g = document.getElementById('rGrade').value, s = document.getElementById('rSec').value;
        let filtered = history.filter(h => h.date >= start && h.date <= end), summary = {};

        if(mode === 'single') {
            const name = document.getElementById('rStSelect').value;
            summary[name] = filtered.filter(h => h.name === name).map(r => `• ${new Date(r.date).toLocaleDateString('ar-OM',{weekday:'long'})} (${r.date})`);
            document.getElementById('pDetails').innerHTML = `<b>اسم الطالب:</b> ${name} <br> <b>الصف:</b> ${g}/${s} <br> <b>الفترة:</b> من ${start} إلى ${end}`;
            document.getElementById('pTitle').innerText = "تقرير غياب طالب";
        } else {
            filtered.filter(h => h.class === `${g}-${s}`).forEach(r => {
                if(!summary[r.name]) summary[r.name] = [];
                summary[r.name].push(`• ${r.date}`);
            });
            document.getElementById('pDetails').innerHTML = `<b>كشف غياب الصف:</b> ${g}/${s} <br> <b>الفترة:</b> من ${start} إلى ${end}`;
            document.getElementById('pTitle').innerText = "كشف غياب الصف المجمع";
        }

        let html = `<table class="report-table"><thead><tr><th>الاسم</th><th>التواريخ</th><th>المجموع</th></tr></thead><tbody>`;
        for(let n in summary) html += `<tr><td style="font-weight:bold;">${n}</td><td style="text-align:right; white-space:pre-line;">${summary[n].join('\n')}</td><td style="font-weight:bold;">${summary[n].length} أيام</td></tr>`;
        if(Object.keys(summary).length === 0) html += `<tr><td colspan="3">لا توجد سجلات غياب</td></tr>`;
        
        document.getElementById('rOutput').innerHTML = html + `</tbody></table>`;
        document.getElementById('pBtn').style.display = 'block';
    }

    function initiatePrint() {
        document.getElementById('pDate').innerText = new Date().toLocaleDateString('ar-OM');
        window.print();
    }

    function tab(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active'); el.classList.add('active');
    }

    window.onload = load;
</script>
</body>
</html>
